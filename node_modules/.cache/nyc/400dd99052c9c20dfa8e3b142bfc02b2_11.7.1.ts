"use strict";/*
 * Copyright Â© 2018 Atomist, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var cov_si1s2hdxy=function(){var path="/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/delivery/build/local/npm/executePublish.ts",hash="48f402748afaa6398976ea304f658ee8bc6992b9",Function=function(){}.constructor,global=new Function('return this')(),gcv="__coverage__",coverageData={path:"/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/delivery/build/local/npm/executePublish.ts",statementMap:{"0":{start:{line:17,column:16},end:{line:24,column:1}},"1":{start:{line:18,column:4},end:{line:23,column:7}},"2":{start:{line:19,column:36},end:{line:19,column:97}},"3":{start:{line:19,column:42},end:{line:19,column:70}},"4":{start:{line:19,column:85},end:{line:19,column:95}},"5":{start:{line:20,column:35},end:{line:20,column:100}},"6":{start:{line:20,column:41},end:{line:20,column:73}},"7":{start:{line:20,column:88},end:{line:20,column:98}},"8":{start:{line:21,column:32},end:{line:21,column:149}},"9":{start:{line:21,column:97},end:{line:21,column:119}},"10":{start:{line:22,column:8},end:{line:22,column:78}},"11":{start:{line:25,column:0},end:{line:25,column:62}},"12":{start:{line:26,column:11},end:{line:26,column:30}},"13":{start:{line:27,column:10},end:{line:27,column:25}},"14":{start:{line:28,column:15},end:{line:28,column:57}},"15":{start:{line:29,column:18},end:{line:29,column:61}},"16":{start:{line:30,column:21},end:{line:30,column:44}},"17":{start:{line:39,column:4},end:{line:74,column:7}},"18":{start:{line:39,column:21},end:{line:74,column:6}},"19":{start:{line:40,column:45},end:{line:40,column:49}},"20":{start:{line:41,column:8},end:{line:73,column:12}},"21":{start:{line:41,column:103},end:{line:73,column:10}},"22":{start:{line:42,column:12},end:{line:47,column:13}},"23":{start:{line:43,column:32},end:{line:43,column:64}},"24":{start:{line:44,column:16},end:{line:46,column:17}},"25":{start:{line:45,column:20},end:{line:45,column:35}},"26":{start:{line:48,column:12},end:{line:48,column:37}},"27":{start:{line:49,column:27},end:{line:59,column:14}},"28":{start:{line:58,column:37},end:{line:58,column:47}},"29":{start:{line:60,column:12},end:{line:70,column:13}},"30":{start:{line:61,column:27},end:{line:61,column:59}},"31":{start:{line:62,column:28},end:{line:62,column:91}},"32":{start:{line:63,column:16},end:{line:68,column:19}},"33":{start:{line:69,column:16},end:{line:69,column:39}},"34":{start:{line:71,column:12},end:{line:71,column:32}},"35":{start:{line:72,column:12},end:{line:72,column:26}},"36":{start:{line:76,column:0},end:{line:76,column:40}},"37":{start:{line:78,column:4},end:{line:90,column:7}},"38":{start:{line:79,column:22},end:{line:79,column:80}},"39":{start:{line:80,column:18},end:{line:80,column:20}},"40":{start:{line:81,column:8},end:{line:83,column:9}},"41":{start:{line:82,column:12},end:{line:82,column:52}},"42":{start:{line:84,column:8},end:{line:87,column:9}},"43":{start:{line:85,column:12},end:{line:86,column:18}},"44":{start:{line:88,column:8},end:{line:88,column:39}},"45":{start:{line:89,column:8},end:{line:89,column:23}},"46":{start:{line:93,column:4},end:{line:96,column:7}},"47":{start:{line:94,column:22},end:{line:94,column:80}},"48":{start:{line:95,column:8},end:{line:95,column:32}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:17,column:44},end:{line:17,column:45}},loc:{start:{line:17,column:89},end:{line:24,column:1}},line:17},"1":{name:"(anonymous_1)",decl:{start:{line:18,column:36},end:{line:18,column:37}},loc:{start:{line:18,column:63},end:{line:23,column:5}},line:18},"2":{name:"fulfilled",decl:{start:{line:19,column:17},end:{line:19,column:26}},loc:{start:{line:19,column:34},end:{line:19,column:99}},line:19},"3":{name:"rejected",decl:{start:{line:20,column:17},end:{line:20,column:25}},loc:{start:{line:20,column:33},end:{line:20,column:102}},line:20},"4":{name:"step",decl:{start:{line:21,column:17},end:{line:21,column:21}},loc:{start:{line:21,column:30},end:{line:21,column:151}},line:21},"5":{name:"(anonymous_5)",decl:{start:{line:21,column:76},end:{line:21,column:77}},loc:{start:{line:21,column:95},end:{line:21,column:121}},line:21},"6":{name:"executePublish",decl:{start:{line:38,column:9},end:{line:38,column:23}},loc:{start:{line:38,column:112},end:{line:75,column:1}},line:38},"7":{name:"(anonymous_7)",decl:{start:{line:39,column:11},end:{line:39,column:12}},loc:{start:{line:39,column:21},end:{line:74,column:6}},line:39},"8":{name:"(anonymous_8)",decl:{start:{line:39,column:53},end:{line:39,column:54}},loc:{start:{line:39,column:66},end:{line:74,column:5}},line:39},"9":{name:"(anonymous_9)",decl:{start:{line:41,column:90},end:{line:41,column:91}},loc:{start:{line:41,column:103},end:{line:73,column:10}},line:41},"10":{name:"(anonymous_10)",decl:{start:{line:41,column:135},end:{line:41,column:136}},loc:{start:{line:41,column:148},end:{line:73,column:9}},line:41},"11":{name:"(anonymous_11)",decl:{start:{line:58,column:29},end:{line:58,column:30}},loc:{start:{line:58,column:37},end:{line:58,column:47}},line:58},"12":{name:"configure",decl:{start:{line:77,column:9},end:{line:77,column:18}},loc:{start:{line:77,column:28},end:{line:91,column:1}},line:77},"13":{name:"(anonymous_13)",decl:{start:{line:78,column:43},end:{line:78,column:44}},loc:{start:{line:78,column:56},end:{line:90,column:5}},line:78},"14":{name:"deleteNpmrc",decl:{start:{line:92,column:9},end:{line:92,column:20}},loc:{start:{line:92,column:23},end:{line:97,column:1}},line:92},"15":{name:"(anonymous_15)",decl:{start:{line:93,column:43},end:{line:93,column:44}},loc:{start:{line:93,column:56},end:{line:96,column:5}},line:93}},branchMap:{"0":{loc:{start:{line:17,column:16},end:{line:24,column:1}},type:"binary-expr",locations:[{start:{line:17,column:17},end:{line:17,column:21}},{start:{line:17,column:25},end:{line:17,column:39}},{start:{line:17,column:44},end:{line:24,column:1}}],line:17},"1":{loc:{start:{line:18,column:16},end:{line:18,column:34}},type:"binary-expr",locations:[{start:{line:18,column:16},end:{line:18,column:17}},{start:{line:18,column:22},end:{line:18,column:33}}],line:18},"2":{loc:{start:{line:21,column:32},end:{line:21,column:148}},type:"cond-expr",locations:[{start:{line:21,column:46},end:{line:21,column:67}},{start:{line:21,column:70},end:{line:21,column:148}}],line:21},"3":{loc:{start:{line:22,column:51},end:{line:22,column:67}},type:"binary-expr",locations:[{start:{line:22,column:51},end:{line:22,column:61}},{start:{line:22,column:65},end:{line:22,column:67}}],line:22},"4":{loc:{start:{line:38,column:58},end:{line:38,column:101}},type:"default-arg",locations:[{start:{line:38,column:73},end:{line:38,column:101}}],line:38},"5":{loc:{start:{line:44,column:16},end:{line:46,column:17}},type:"if",locations:[{start:{line:44,column:16},end:{line:46,column:17}},{start:{line:44,column:16},end:{line:46,column:17}}],line:44},"6":{loc:{start:{line:54,column:20},end:{line:54,column:66}},type:"cond-expr",locations:[{start:{line:54,column:37},end:{line:54,column:51}},{start:{line:54,column:54},end:{line:54,column:66}}],line:54},"7":{loc:{start:{line:60,column:12},end:{line:70,column:13}},type:"if",locations:[{start:{line:60,column:12},end:{line:70,column:13}},{start:{line:60,column:12},end:{line:70,column:13}}],line:60},"8":{loc:{start:{line:79,column:29},end:{line:79,column:69}},type:"binary-expr",locations:[{start:{line:79,column:29},end:{line:79,column:45}},{start:{line:79,column:49},end:{line:79,column:69}}],line:79},"9":{loc:{start:{line:81,column:8},end:{line:83,column:9}},type:"if",locations:[{start:{line:81,column:8},end:{line:83,column:9}},{start:{line:81,column:8},end:{line:83,column:9}}],line:81},"10":{loc:{start:{line:84,column:8},end:{line:87,column:9}},type:"if",locations:[{start:{line:84,column:8},end:{line:87,column:9}},{start:{line:84,column:8},end:{line:87,column:9}}],line:84},"11":{loc:{start:{line:94,column:29},end:{line:94,column:69}},type:"binary-expr",locations:[{start:{line:94,column:29},end:{line:94,column:45}},{start:{line:94,column:49},end:{line:94,column:69}}],line:94}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0},b:{"0":[0,0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0],"5":[0,0],"6":[0,0],"7":[0,0],"8":[0,0],"9":[0,0],"10":[0,0],"11":[0,0]},_coverageSchema:"332fd63041d2c1bcb487cc26dd0d5f7d97098a6c"},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var __awaiter=(cov_si1s2hdxy.s[0]++,(cov_si1s2hdxy.b[0][0]++,this)&&(cov_si1s2hdxy.b[0][1]++,this.__awaiter)||(cov_si1s2hdxy.b[0][2]++,function(thisArg,_arguments,P,generator){cov_si1s2hdxy.f[0]++;cov_si1s2hdxy.s[1]++;return new((cov_si1s2hdxy.b[1][0]++,P)||(cov_si1s2hdxy.b[1][1]++,P=Promise))(function(resolve,reject){cov_si1s2hdxy.f[1]++;function fulfilled(value){cov_si1s2hdxy.f[2]++;cov_si1s2hdxy.s[2]++;try{cov_si1s2hdxy.s[3]++;step(generator.next(value));}catch(e){cov_si1s2hdxy.s[4]++;reject(e);}}function rejected(value){cov_si1s2hdxy.f[3]++;cov_si1s2hdxy.s[5]++;try{cov_si1s2hdxy.s[6]++;step(generator["throw"](value));}catch(e){cov_si1s2hdxy.s[7]++;reject(e);}}function step(result){cov_si1s2hdxy.f[4]++;cov_si1s2hdxy.s[8]++;result.done?(cov_si1s2hdxy.b[2][0]++,resolve(result.value)):(cov_si1s2hdxy.b[2][1]++,new P(function(resolve){cov_si1s2hdxy.f[5]++;cov_si1s2hdxy.s[9]++;resolve(result.value);}).then(fulfilled,rejected));}cov_si1s2hdxy.s[10]++;step((generator=generator.apply(thisArg,(cov_si1s2hdxy.b[3][0]++,_arguments)||(cov_si1s2hdxy.b[3][1]++,[]))).next());});}));cov_si1s2hdxy.s[11]++;Object.defineProperty(exports,"__esModule",{value:true});const fs=(cov_si1s2hdxy.s[12]++,require("fs-extra"));const p=(cov_si1s2hdxy.s[13]++,require("path"));const ghub_1=(cov_si1s2hdxy.s[14]++,require("../../../../../util/github/ghub"));const spawned_1=(cov_si1s2hdxy.s[15]++,require("../../../../../util/misc/spawned"));const npmBuilder_1=(cov_si1s2hdxy.s[16]++,require("./npmBuilder"));/**
 * Execute npm publish
 * @param {ProjectLoader} projectLoader
 * @param {ProjectIdentifier} projectIdentifier
 * @param {PrepareForGoalExecution[]} preparations
 * @return {ExecuteGoalWithLog}
 */function executePublish(projectLoader,projectIdentifier,preparations=(cov_si1s2hdxy.b[4][0]++,npmBuilder_1.NpmPreparations),options){cov_si1s2hdxy.f[6]++;cov_si1s2hdxy.s[17]++;return rwlc=>{cov_si1s2hdxy.f[7]++;cov_si1s2hdxy.s[18]++;return __awaiter(this,void 0,void 0,function*(){cov_si1s2hdxy.f[8]++;const{credentials,id,context}=(cov_si1s2hdxy.s[19]++,rwlc);cov_si1s2hdxy.s[20]++;return projectLoader.doWithProject({credentials,id,context,readOnly:false},project=>{cov_si1s2hdxy.f[9]++;cov_si1s2hdxy.s[21]++;return __awaiter(this,void 0,void 0,function*(){cov_si1s2hdxy.f[10]++;cov_si1s2hdxy.s[22]++;for(const preparation of preparations){const pResult=(cov_si1s2hdxy.s[23]++,yield preparation(project,rwlc));cov_si1s2hdxy.s[24]++;if(pResult.code!==0){cov_si1s2hdxy.b[5][0]++;cov_si1s2hdxy.s[25]++;return pResult;}else{cov_si1s2hdxy.b[5][1]++;}}cov_si1s2hdxy.s[26]++;yield configure(options);const result=(cov_si1s2hdxy.s[27]++,yield spawned_1.spawnAndWatch({command:"bash",args:[p.join(__dirname,"..","..","..","..","..","scripts","npm-publish.bash"),`--registry=${options.registry}`,"--access",options.access?(cov_si1s2hdxy.b[6][0]++,options.access):(cov_si1s2hdxy.b[6][1]++,"restricted")]},{cwd:project.baseDir},rwlc.progressLog,{errorFinder:code=>{cov_si1s2hdxy.f[11]++;cov_si1s2hdxy.s[28]++;return code!==0;}}));cov_si1s2hdxy.s[29]++;if(result.code===0){cov_si1s2hdxy.b[7][0]++;const pi=(cov_si1s2hdxy.s[30]++,yield projectIdentifier(project));const url=(cov_si1s2hdxy.s[31]++,`${options.registry}/${pi.name}/-/${pi.name}-${pi.version}.tgz`);cov_si1s2hdxy.s[32]++;yield ghub_1.createStatus(credentials.token,id,{context:"npm/atomist/package",description:"NPM package",target_url:url,state:"success"});cov_si1s2hdxy.s[33]++;result.targetUrl=url;}else{cov_si1s2hdxy.b[7][1]++;}cov_si1s2hdxy.s[34]++;yield deleteNpmrc();cov_si1s2hdxy.s[35]++;return result;});});});};}cov_si1s2hdxy.s[36]++;exports.executePublish=executePublish;function configure(options){cov_si1s2hdxy.f[12]++;cov_si1s2hdxy.s[37]++;return __awaiter(this,void 0,void 0,function*(){cov_si1s2hdxy.f[13]++;const npmrc=(cov_si1s2hdxy.s[38]++,p.join((cov_si1s2hdxy.b[8][0]++,process.env.HOME)||(cov_si1s2hdxy.b[8][1]++,process.env.USER_DIR),".npmrc"));let npm=(cov_si1s2hdxy.s[39]++,"");cov_si1s2hdxy.s[40]++;if(fs.existsSync(npmrc)){cov_si1s2hdxy.b[9][0]++;cov_si1s2hdxy.s[41]++;npm=fs.readFileSync(npmrc).toString();}else{cov_si1s2hdxy.b[9][1]++;}cov_si1s2hdxy.s[42]++;if(!npm.includes(options.npmrc)){cov_si1s2hdxy.b[10][0]++;cov_si1s2hdxy.s[43]++;npm=`${npm}
${options.npmrc}`;}else{cov_si1s2hdxy.b[10][1]++;}cov_si1s2hdxy.s[44]++;yield fs.writeFile(npmrc,npm);cov_si1s2hdxy.s[45]++;return options;});}function deleteNpmrc(){cov_si1s2hdxy.f[14]++;cov_si1s2hdxy.s[46]++;return __awaiter(this,void 0,void 0,function*(){cov_si1s2hdxy.f[15]++;const npmrc=(cov_si1s2hdxy.s[47]++,p.join((cov_si1s2hdxy.b[11][0]++,process.env.HOME)||(cov_si1s2hdxy.b[11][1]++,process.env.USER_DIR),".npmrc"));cov_si1s2hdxy.s[48]++;return fs.unlink(npmrc);});}//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL2NvbW1vbi9kZWxpdmVyeS9idWlsZC9sb2NhbC9ucG0vZXhlY3V0ZVB1Ymxpc2gudHMiLCJzb3VyY2VzIjpbIi9Vc2Vycy9yb2Rqb2huc29uL3Nmb3J6YW5kby1kZXYvaWRlYS1wcm9qZWN0cy9teS1mbG93L3NyYy9jb21tb24vZGVsaXZlcnkvYnVpbGQvbG9jYWwvbnBtL2V4ZWN1dGVQdWJsaXNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7Ozs7R0FjRzs7Ozs7Ozs7OztBQUlILCtCQUErQjtBQUMvQiwwQkFBMEI7QUFDMUIsMERBQStEO0FBQy9ELDhEQUFpRTtBQVNqRSw2Q0FBK0M7QUFFL0M7Ozs7OztHQU1HO0FBQ0gsd0JBQStCLGFBQTRCLEVBQzVCLGlCQUFvQyxFQUNwQyxlQUEwQyw0QkFBZSxFQUN6RCxPQUFtQjtJQUM5QyxPQUFPLENBQU8sSUFBdUIsRUFBOEIsRUFBRTtRQUNqRSxNQUFNLEVBQUUsV0FBVyxFQUFFLEVBQUUsRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDMUMsT0FBTyxhQUFhLENBQUMsYUFBYSxDQUFDLEVBQUUsV0FBVyxFQUFFLEVBQUUsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxFQUFFLENBQU0sT0FBTyxFQUFDLEVBQUU7WUFDOUYsS0FBSyxNQUFNLFdBQVcsSUFBSSxZQUFZLEVBQUU7Z0JBQ3BDLE1BQU0sT0FBTyxHQUFHLE1BQU0sV0FBVyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDakQsSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLENBQUMsRUFBRTtvQkFDcEIsT0FBTyxPQUFPLENBQUM7aUJBQ2xCO2FBQ0o7WUFFRCxNQUFNLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUV6QixNQUFNLE1BQU0sR0FBc0IsTUFBTSx1QkFBYSxDQUFDO2dCQUM5QyxPQUFPLEVBQUUsTUFBTTtnQkFDZixJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxrQkFBa0IsQ0FBQztvQkFDakYsY0FBYyxPQUFPLENBQUMsUUFBUSxFQUFFO29CQUNoQyxVQUFVO29CQUNWLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQzthQUN0RCxFQUNEO2dCQUNJLEdBQUcsRUFBRSxPQUFPLENBQUMsT0FBTzthQUN2QixFQUNELElBQUksQ0FBQyxXQUFXLEVBQ2hCO2dCQUNJLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksS0FBSyxDQUFDO2FBQ2xDLENBQUMsQ0FBQztZQUVQLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLEVBQUU7Z0JBQ25CLE1BQU0sRUFBRSxHQUFHLE1BQU0saUJBQWlCLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQzVDLE1BQU0sR0FBRyxHQUFHLEdBQUcsT0FBTyxDQUFDLFFBQVEsSUFBSSxFQUFFLENBQUMsSUFBSSxNQUFNLEVBQUUsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sTUFBTSxDQUFDO2dCQUM1RSxNQUFNLG1CQUFZLENBQ2IsV0FBZ0MsQ0FBQyxLQUFLLEVBQ3ZDLEVBQW1CLEVBQ25CO29CQUNJLE9BQU8sRUFBRSxxQkFBcUI7b0JBQzlCLFdBQVcsRUFBRSxhQUFhO29CQUMxQixVQUFVLEVBQUUsR0FBRztvQkFDZixLQUFLLEVBQUUsU0FBUztpQkFDbkIsQ0FBQyxDQUFDO2dCQUNQLE1BQU0sQ0FBQyxTQUFTLEdBQUcsR0FBRyxDQUFDO2FBQzFCO1lBRUQsTUFBTSxXQUFXLEVBQUUsQ0FBQztZQUNwQixPQUFPLE1BQU0sQ0FBQztRQUNsQixDQUFDLENBQUEsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFBLENBQUM7QUFDTixDQUFDO0FBbERELHdDQWtEQztBQUVELG1CQUF5QixPQUFtQjs7UUFDeEMsTUFBTSxLQUFLLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUN6RSxJQUFJLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDYixJQUFJLEVBQUUsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEVBQUc7WUFDdkIsR0FBRyxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7U0FDM0M7UUFFRCxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDOUIsR0FBRyxHQUFHLEdBQUcsR0FBRztFQUNsQixPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDYjtRQUVELE1BQU0sRUFBRSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDL0IsT0FBTyxPQUFPLENBQUM7SUFDbkIsQ0FBQztDQUFBO0FBRUQ7O1FBQ0ksTUFBTSxLQUFLLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUN6RSxPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDNUIsQ0FBQztDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCDCqSAyMDE4IEF0b21pc3QsIEluYy5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgR2l0SHViUmVwb1JlZiB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudC9vcGVyYXRpb25zL2NvbW1vbi9HaXRIdWJSZXBvUmVmXCI7XG5pbXBvcnQgeyBUb2tlbkNyZWRlbnRpYWxzIH0gZnJvbSBcIkBhdG9taXN0L2F1dG9tYXRpb24tY2xpZW50L29wZXJhdGlvbnMvY29tbW9uL1Byb2plY3RPcGVyYXRpb25DcmVkZW50aWFsc1wiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzLWV4dHJhXCI7XG5pbXBvcnQgKiBhcyBwIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBjcmVhdGVTdGF0dXMgfSBmcm9tIFwiLi4vLi4vLi4vLi4vLi4vdXRpbC9naXRodWIvZ2h1YlwiO1xuaW1wb3J0IHsgc3Bhd25BbmRXYXRjaCB9IGZyb20gXCIuLi8uLi8uLi8uLi8uLi91dGlsL21pc2Mvc3Bhd25lZFwiO1xuaW1wb3J0IHsgUHJvamVjdExvYWRlciB9IGZyb20gXCIuLi8uLi8uLi8uLi9yZXBvL1Byb2plY3RMb2FkZXJcIjtcbmltcG9ydCB7IEV4ZWN1dGVHb2FsUmVzdWx0IH0gZnJvbSBcIi4uLy4uLy4uL2dvYWxzL0V4ZWN1dGVHb2FsUmVzdWx0XCI7XG5pbXBvcnQge1xuICAgIEV4ZWN1dGVHb2FsV2l0aExvZyxcbiAgICBQcmVwYXJlRm9yR29hbEV4ZWN1dGlvbixcbiAgICBSdW5XaXRoTG9nQ29udGV4dCxcbn0gZnJvbSBcIi4uLy4uLy4uL2dvYWxzL3N1cHBvcnQvcmVwb3J0R29hbEVycm9yXCI7XG5pbXBvcnQgeyBQcm9qZWN0SWRlbnRpZmllciB9IGZyb20gXCIuLi9wcm9qZWN0SWRlbnRpZmllclwiO1xuaW1wb3J0IHsgTnBtUHJlcGFyYXRpb25zIH0gZnJvbSBcIi4vbnBtQnVpbGRlclwiO1xuXG4vKipcbiAqIEV4ZWN1dGUgbnBtIHB1Ymxpc2hcbiAqIEBwYXJhbSB7UHJvamVjdExvYWRlcn0gcHJvamVjdExvYWRlclxuICogQHBhcmFtIHtQcm9qZWN0SWRlbnRpZmllcn0gcHJvamVjdElkZW50aWZpZXJcbiAqIEBwYXJhbSB7UHJlcGFyZUZvckdvYWxFeGVjdXRpb25bXX0gcHJlcGFyYXRpb25zXG4gKiBAcmV0dXJuIHtFeGVjdXRlR29hbFdpdGhMb2d9XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBleGVjdXRlUHVibGlzaChwcm9qZWN0TG9hZGVyOiBQcm9qZWN0TG9hZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2plY3RJZGVudGlmaWVyOiBQcm9qZWN0SWRlbnRpZmllcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVwYXJhdGlvbnM6IFByZXBhcmVGb3JHb2FsRXhlY3V0aW9uW10gPSBOcG1QcmVwYXJhdGlvbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uczogTnBtT3B0aW9ucyk6IEV4ZWN1dGVHb2FsV2l0aExvZyB7XG4gICAgcmV0dXJuIGFzeW5jIChyd2xjOiBSdW5XaXRoTG9nQ29udGV4dCk6IFByb21pc2U8RXhlY3V0ZUdvYWxSZXN1bHQ+ID0+IHtcbiAgICAgICAgY29uc3QgeyBjcmVkZW50aWFscywgaWQsIGNvbnRleHQgfSA9IHJ3bGM7XG4gICAgICAgIHJldHVybiBwcm9qZWN0TG9hZGVyLmRvV2l0aFByb2plY3QoeyBjcmVkZW50aWFscywgaWQsIGNvbnRleHQsIHJlYWRPbmx5OiBmYWxzZSB9LCBhc3luYyBwcm9qZWN0ID0+IHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgcHJlcGFyYXRpb24gb2YgcHJlcGFyYXRpb25zKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcFJlc3VsdCA9IGF3YWl0IHByZXBhcmF0aW9uKHByb2plY3QsIHJ3bGMpO1xuICAgICAgICAgICAgICAgIGlmIChwUmVzdWx0LmNvZGUgIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBSZXN1bHQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBhd2FpdCBjb25maWd1cmUob3B0aW9ucyk7XG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdDogRXhlY3V0ZUdvYWxSZXN1bHQgPSBhd2FpdCBzcGF3bkFuZFdhdGNoKHtcbiAgICAgICAgICAgICAgICAgICAgY29tbWFuZDogXCJiYXNoXCIsXG4gICAgICAgICAgICAgICAgICAgIGFyZ3M6IFtwLmpvaW4oX19kaXJuYW1lLCBcIi4uXCIsIFwiLi5cIiwgXCIuLlwiLCBcIi4uXCIsIFwiLi5cIiwgXCJzY3JpcHRzXCIsIFwibnBtLXB1Ymxpc2guYmFzaFwiKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGAtLXJlZ2lzdHJ5PSR7b3B0aW9ucy5yZWdpc3RyeX1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCItLWFjY2Vzc1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5hY2Nlc3MgPyBvcHRpb25zLmFjY2VzcyA6IFwicmVzdHJpY3RlZFwiXSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgY3dkOiBwcm9qZWN0LmJhc2VEaXIsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICByd2xjLnByb2dyZXNzTG9nLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgZXJyb3JGaW5kZXI6IGNvZGUgPT4gY29kZSAhPT0gMCxcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKHJlc3VsdC5jb2RlID09PSAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGkgPSBhd2FpdCBwcm9qZWN0SWRlbnRpZmllcihwcm9qZWN0KTtcbiAgICAgICAgICAgICAgICBjb25zdCB1cmwgPSBgJHtvcHRpb25zLnJlZ2lzdHJ5fS8ke3BpLm5hbWV9Ly0vJHtwaS5uYW1lfS0ke3BpLnZlcnNpb259LnRnemA7XG4gICAgICAgICAgICAgICAgYXdhaXQgY3JlYXRlU3RhdHVzKFxuICAgICAgICAgICAgICAgICAgICAoY3JlZGVudGlhbHMgYXMgVG9rZW5DcmVkZW50aWFscykudG9rZW4sXG4gICAgICAgICAgICAgICAgICAgIGlkIGFzIEdpdEh1YlJlcG9SZWYsXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQ6IFwibnBtL2F0b21pc3QvcGFja2FnZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IFwiTlBNIHBhY2thZ2VcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldF91cmw6IHVybCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlOiBcInN1Y2Nlc3NcIixcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnRhcmdldFVybCA9IHVybDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYXdhaXQgZGVsZXRlTnBtcmMoKTtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0pO1xuICAgIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbmZpZ3VyZShvcHRpb25zOiBOcG1PcHRpb25zKTogUHJvbWlzZTxOcG1PcHRpb25zPiB7XG4gICAgY29uc3QgbnBtcmMgPSBwLmpvaW4ocHJvY2Vzcy5lbnYuSE9NRSB8fCBwcm9jZXNzLmVudi5VU0VSX0RJUiwgXCIubnBtcmNcIik7XG4gICAgbGV0IG5wbSA9IFwiXCI7XG4gICAgaWYgKGZzLmV4aXN0c1N5bmMobnBtcmMpKSAge1xuICAgICAgICBucG0gPSBmcy5yZWFkRmlsZVN5bmMobnBtcmMpLnRvU3RyaW5nKCk7XG4gICAgfVxuXG4gICAgaWYgKCFucG0uaW5jbHVkZXMob3B0aW9ucy5ucG1yYykpIHtcbiAgICAgICAgbnBtID0gYCR7bnBtfVxuJHtvcHRpb25zLm5wbXJjfWA7XG4gICAgfVxuXG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKG5wbXJjLCBucG0pO1xuICAgIHJldHVybiBvcHRpb25zO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkZWxldGVOcG1yYygpIHtcbiAgICBjb25zdCBucG1yYyA9IHAuam9pbihwcm9jZXNzLmVudi5IT01FIHx8IHByb2Nlc3MuZW52LlVTRVJfRElSLCBcIi5ucG1yY1wiKTtcbiAgICByZXR1cm4gZnMudW5saW5rKG5wbXJjKTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOcG1PcHRpb25zIHtcbiAgICBucG1yYzogc3RyaW5nO1xuICAgIHJlZ2lzdHJ5OiBzdHJpbmc7XG4gICAgYWNjZXNzOiBzdHJpbmc7XG59XG4iXX0=