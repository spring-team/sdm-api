"use strict";var cov_huhlqwcdc=function(){var path="/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/command/editor/allReposInTeam.ts",hash="872f37abb1a3abd4f1799582611e1a167ca173de",Function=function(){}.constructor,global=new Function('return this')(),gcv="__coverage__",coverageData={path:"/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/command/editor/allReposInTeam.ts",statementMap:{"0":{start:{line:2,column:0},end:{line:2,column:62}},"1":{start:{line:3,column:26},end:{line:3,column:97}},"2":{start:{line:4,column:10},end:{line:4,column:27}},"3":{start:{line:5,column:18},end:{line:5,column:54}},"4":{start:{line:7,column:17},end:{line:7,column:20}},"5":{start:{line:15,column:4},end:{line:20,column:6}},"6":{start:{line:16,column:8},end:{line:18,column:9}},"7":{start:{line:17,column:12},end:{line:17,column:78}},"8":{start:{line:19,column:8},end:{line:19,column:40}},"9":{start:{line:22,column:0},end:{line:22,column:40}},"10":{start:{line:30,column:4},end:{line:42,column:7}},"11":{start:{line:35,column:8},end:{line:35,column:110}},"12":{start:{line:35,column:57},end:{line:35,column:108}},"13":{start:{line:35,column:75},end:{line:35,column:107}},"14":{start:{line:38,column:8},end:{line:41,column:60}},"15":{start:{line:41,column:35},end:{line:41,column:58}}},fnMap:{"0":{name:"allReposInTeam",decl:{start:{line:14,column:9},end:{line:14,column:23}},loc:{start:{line:14,column:29},end:{line:21,column:1}},line:14},"1":{name:"(anonymous_1)",decl:{start:{line:15,column:11},end:{line:15,column:12}},loc:{start:{line:15,column:24},end:{line:20,column:5}},line:15},"2":{name:"queryForPage",decl:{start:{line:29,column:9},end:{line:29,column:21}},loc:{start:{line:29,column:39},end:{line:43,column:1}},line:29},"3":{name:"(anonymous_3)",decl:{start:{line:34,column:14},end:{line:34,column:15}},loc:{start:{line:34,column:24},end:{line:36,column:5}},line:34},"4":{name:"(anonymous_4)",decl:{start:{line:35,column:50},end:{line:35,column:51}},loc:{start:{line:35,column:57},end:{line:35,column:108}},line:35},"5":{name:"(anonymous_5)",decl:{start:{line:35,column:70},end:{line:35,column:71}},loc:{start:{line:35,column:75},end:{line:35,column:107}},line:35},"6":{name:"(anonymous_6)",decl:{start:{line:37,column:14},end:{line:37,column:15}},loc:{start:{line:37,column:23},end:{line:42,column:5}},line:37},"7":{name:"(anonymous_7)",decl:{start:{line:41,column:22},end:{line:41,column:23}},loc:{start:{line:41,column:35},end:{line:41,column:58}},line:41}},branchMap:{"0":{loc:{start:{line:16,column:8},end:{line:18,column:9}},type:"if",locations:[{start:{line:16,column:8},end:{line:18,column:9}},{start:{line:16,column:8},end:{line:18,column:9}}],line:16},"1":{loc:{start:{line:38,column:15},end:{line:41,column:59}},type:"cond-expr",locations:[{start:{line:39,column:12},end:{line:39,column:17}},{start:{line:40,column:12},end:{line:41,column:59}}],line:38}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0},b:{"0":[0,0],"1":[0,0]},_coverageSchema:"332fd63041d2c1bcb487cc26dd0d5f7d97098a6c"},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();cov_huhlqwcdc.s[0]++;Object.defineProperty(exports,"__esModule",{value:true});const localRepoFinder_1=(cov_huhlqwcdc.s[1]++,require("@atomist/automation-client/operations/common/localRepoFinder"));const _=(cov_huhlqwcdc.s[2]++,require("lodash"));const repoRef_1=(cov_huhlqwcdc.s[3]++,require("../../../util/git/repoRef"));// Hard-coded limit in GraphQL queries. Not sure why we can't pass this
const PageSize=(cov_huhlqwcdc.s[4]++,100);/**
 * Use a GraphQL query to find all repos for the current team,
 * or look locally if appropriate, in current working directory
 * @param cwd directory to look in if this is local
 * @constructor
 */function allReposInTeam(cwd){cov_huhlqwcdc.f[0]++;cov_huhlqwcdc.s[5]++;return context=>{cov_huhlqwcdc.f[1]++;cov_huhlqwcdc.s[6]++;if(cwd){cov_huhlqwcdc.b[0][0]++;cov_huhlqwcdc.s[7]++;return localRepoFinder_1.twoTierDirectoryRepoFinder(cwd)(context);}else{cov_huhlqwcdc.b[0][1]++;}cov_huhlqwcdc.s[8]++;return queryForPage(context,0);};}cov_huhlqwcdc.s[9]++;exports.allReposInTeam=allReposInTeam;/**
 * Recursively query for repos from the present offset
 * @param {HandlerContext} context
 * @param {number} offset
 * @return {Promise<RepoRef[]>}
 */function queryForPage(context,offset){cov_huhlqwcdc.f[2]++;cov_huhlqwcdc.s[10]++;return context.graphClient.query({name:"ReposInTeam",variables:{teamId:context.teamId,offset}}).then(result=>{cov_huhlqwcdc.f[3]++;cov_huhlqwcdc.s[11]++;return _.flatMap(result.ChatTeam[0].orgs,org=>{cov_huhlqwcdc.f[4]++;cov_huhlqwcdc.s[12]++;return org.repo.map(r=>{cov_huhlqwcdc.f[5]++;cov_huhlqwcdc.s[13]++;return repoRef_1.toRemoteRepoRef(r,{});});});}).then(repos=>{cov_huhlqwcdc.f[6]++;cov_huhlqwcdc.s[14]++;return repos.length<PageSize?(cov_huhlqwcdc.b[1][0]++,repos):(cov_huhlqwcdc.b[1][1]++,queryForPage(context,offset+PageSize).then(moreRepos=>{cov_huhlqwcdc.f[7]++;cov_huhlqwcdc.s[15]++;return repos.concat(moreRepos);}));});}//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL2NvbW1vbi9jb21tYW5kL2VkaXRvci9hbGxSZXBvc0luVGVhbS50cyIsInNvdXJjZXMiOlsiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL2NvbW1vbi9jb21tYW5kL2VkaXRvci9hbGxSZXBvc0luVGVhbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLGtHQUEwRztBQUcxRyw0QkFBNEI7QUFFNUIsdURBQTREO0FBRTVELHVFQUF1RTtBQUN2RSxNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUM7QUFFckI7Ozs7O0dBS0c7QUFDSCx3QkFBK0IsR0FBWTtJQUN2QyxPQUFPLENBQUMsT0FBdUIsRUFBRSxFQUFFO1FBQy9CLElBQUksR0FBRyxFQUFFO1lBQ0wsT0FBTyw0Q0FBMEIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUNuRDtRQUNELE9BQU8sWUFBWSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNwQyxDQUFDLENBQUM7QUFDTixDQUFDO0FBUEQsd0NBT0M7QUFFRDs7Ozs7R0FLRztBQUNILHNCQUFzQixPQUF1QixFQUFFLE1BQWM7SUFDekQsT0FBTyxPQUFPLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBMkM7UUFDdkUsSUFBSSxFQUFFLGFBQWE7UUFDbkIsU0FBUyxFQUFFLEVBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFDO0tBQzlDLENBQUM7U0FDRyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7UUFDWCxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FDNUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyx5QkFBZSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbkQsQ0FBQyxDQUFDO1NBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQ1YsT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUM5QixLQUFLLENBQUMsQ0FBQztZQUNQLFlBQVksQ0FBQyxPQUFPLEVBQUUsTUFBTSxHQUFHLFFBQVEsQ0FBQztpQkFDbkMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO0lBQ3hELENBQUMsQ0FBQyxDQUFDO0FBQ1gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEhhbmRsZXJDb250ZXh0IH0gZnJvbSBcIkBhdG9taXN0L2F1dG9tYXRpb24tY2xpZW50XCI7XG5pbXBvcnQgeyB0d29UaWVyRGlyZWN0b3J5UmVwb0ZpbmRlciB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudC9vcGVyYXRpb25zL2NvbW1vbi9sb2NhbFJlcG9GaW5kZXJcIjtcbmltcG9ydCB7IFJlcG9GaW5kZXIgfSBmcm9tIFwiQGF0b21pc3QvYXV0b21hdGlvbi1jbGllbnQvb3BlcmF0aW9ucy9jb21tb24vcmVwb0ZpbmRlclwiO1xuaW1wb3J0IHsgUmVtb3RlUmVwb1JlZiB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudC9vcGVyYXRpb25zL2NvbW1vbi9SZXBvSWRcIjtcbmltcG9ydCAqIGFzIF8gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0IHsgUmVwb3NJblRlYW0gfSBmcm9tIFwiLi4vLi4vLi4vdHlwaW5ncy90eXBlc1wiO1xuaW1wb3J0IHsgdG9SZW1vdGVSZXBvUmVmIH0gZnJvbSBcIi4uLy4uLy4uL3V0aWwvZ2l0L3JlcG9SZWZcIjtcblxuLy8gSGFyZC1jb2RlZCBsaW1pdCBpbiBHcmFwaFFMIHF1ZXJpZXMuIE5vdCBzdXJlIHdoeSB3ZSBjYW4ndCBwYXNzIHRoaXNcbmNvbnN0IFBhZ2VTaXplID0gMTAwO1xuXG4vKipcbiAqIFVzZSBhIEdyYXBoUUwgcXVlcnkgdG8gZmluZCBhbGwgcmVwb3MgZm9yIHRoZSBjdXJyZW50IHRlYW0sXG4gKiBvciBsb29rIGxvY2FsbHkgaWYgYXBwcm9wcmlhdGUsIGluIGN1cnJlbnQgd29ya2luZyBkaXJlY3RvcnlcbiAqIEBwYXJhbSBjd2QgZGlyZWN0b3J5IHRvIGxvb2sgaW4gaWYgdGhpcyBpcyBsb2NhbFxuICogQGNvbnN0cnVjdG9yXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhbGxSZXBvc0luVGVhbShjd2Q/OiBzdHJpbmcpOiBSZXBvRmluZGVyIHtcbiAgICByZXR1cm4gKGNvbnRleHQ6IEhhbmRsZXJDb250ZXh0KSA9PiB7XG4gICAgICAgIGlmIChjd2QpIHtcbiAgICAgICAgICAgIHJldHVybiB0d29UaWVyRGlyZWN0b3J5UmVwb0ZpbmRlcihjd2QpKGNvbnRleHQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBxdWVyeUZvclBhZ2UoY29udGV4dCwgMCk7XG4gICAgfTtcbn1cblxuLyoqXG4gKiBSZWN1cnNpdmVseSBxdWVyeSBmb3IgcmVwb3MgZnJvbSB0aGUgcHJlc2VudCBvZmZzZXRcbiAqIEBwYXJhbSB7SGFuZGxlckNvbnRleHR9IGNvbnRleHRcbiAqIEBwYXJhbSB7bnVtYmVyfSBvZmZzZXRcbiAqIEByZXR1cm4ge1Byb21pc2U8UmVwb1JlZltdPn1cbiAqL1xuZnVuY3Rpb24gcXVlcnlGb3JQYWdlKGNvbnRleHQ6IEhhbmRsZXJDb250ZXh0LCBvZmZzZXQ6IG51bWJlcik6IFByb21pc2U8UmVtb3RlUmVwb1JlZltdPiB7XG4gICAgcmV0dXJuIGNvbnRleHQuZ3JhcGhDbGllbnQucXVlcnk8UmVwb3NJblRlYW0uUXVlcnksIFJlcG9zSW5UZWFtLlZhcmlhYmxlcz4oe1xuICAgICAgICBuYW1lOiBcIlJlcG9zSW5UZWFtXCIsXG4gICAgICAgIHZhcmlhYmxlczoge3RlYW1JZDogY29udGV4dC50ZWFtSWQsIG9mZnNldH0sXG4gICAgfSlcbiAgICAgICAgLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgIHJldHVybiBfLmZsYXRNYXAocmVzdWx0LkNoYXRUZWFtWzBdLm9yZ3MsIG9yZyA9PlxuICAgICAgICAgICAgICAgIG9yZy5yZXBvLm1hcChyID0+IHRvUmVtb3RlUmVwb1JlZihyLCB7fSkpKTtcbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4ocmVwb3MgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIChyZXBvcy5sZW5ndGggPCBQYWdlU2l6ZSkgP1xuICAgICAgICAgICAgICAgIHJlcG9zIDpcbiAgICAgICAgICAgICAgICBxdWVyeUZvclBhZ2UoY29udGV4dCwgb2Zmc2V0ICsgUGFnZVNpemUpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKG1vcmVSZXBvcyA9PiByZXBvcy5jb25jYXQobW9yZVJlcG9zKSk7XG4gICAgICAgIH0pO1xufVxuIl19