"use strict";/*
 * Copyright Â© 2018 Atomist, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var cov_144cgafpfa=function(){var path="/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/delivery/deploy/local/ManagedDeployments.ts",hash="c72e0c0241631890d96f8e6510ef9ed1e44798f7",Function=function(){}.constructor,global=new Function('return this')(),gcv="__coverage__",coverageData={path:"/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/delivery/deploy/local/ManagedDeployments.ts",statementMap:{"0":{start:{line:17,column:16},end:{line:24,column:1}},"1":{start:{line:18,column:4},end:{line:23,column:7}},"2":{start:{line:19,column:36},end:{line:19,column:97}},"3":{start:{line:19,column:42},end:{line:19,column:70}},"4":{start:{line:19,column:85},end:{line:19,column:95}},"5":{start:{line:20,column:35},end:{line:20,column:100}},"6":{start:{line:20,column:41},end:{line:20,column:73}},"7":{start:{line:20,column:88},end:{line:20,column:98}},"8":{start:{line:21,column:32},end:{line:21,column:149}},"9":{start:{line:21,column:97},end:{line:21,column:119}},"10":{start:{line:22,column:8},end:{line:22,column:78}},"11":{start:{line:25,column:0},end:{line:25,column:62}},"12":{start:{line:26,column:28},end:{line:26,column:65}},"13":{start:{line:27,column:16},end:{line:27,column:32}},"14":{start:{line:28,column:14},end:{line:28,column:30}},"15":{start:{line:29,column:18},end:{line:29,column:58}},"16":{start:{line:30,column:0},end:{line:37,column:2}},"17":{start:{line:31,column:21},end:{line:31,column:54}},"18":{start:{line:32,column:4},end:{line:36,column:6}},"19":{start:{line:42,column:0},end:{line:46,column:77}},"20":{start:{line:43,column:4},end:{line:43,column:42}},"21":{start:{line:44,column:4},end:{line:44,column:40}},"22":{start:{line:45,column:4},end:{line:45,column:34}},"23":{start:{line:54,column:8},end:{line:54,column:39}},"24":{start:{line:55,column:8},end:{line:55,column:30}},"25":{start:{line:65,column:8},end:{line:68,column:11}},"26":{start:{line:66,column:28},end:{line:66,column:67}},"27":{start:{line:67,column:12},end:{line:67,column:70}},"28":{start:{line:71,column:8},end:{line:71,column:112}},"29":{start:{line:72,column:8},end:{line:72,column:34}},"30":{start:{line:75,column:8},end:{line:91,column:9}},"31":{start:{line:77,column:16},end:{line:79,column:17}},"32":{start:{line:78,column:20},end:{line:78,column:92}},"33":{start:{line:81,column:16},end:{line:81,column:71}},"34":{start:{line:81,column:50},end:{line:81,column:69}},"35":{start:{line:83,column:16},end:{line:85,column:17}},"36":{start:{line:84,column:20},end:{line:84,column:98}},"37":{start:{line:86,column:16},end:{line:87,column:110}},"38":{start:{line:87,column:31},end:{line:87,column:108}},"39":{start:{line:89,column:16},end:{line:90,column:81}},"40":{start:{line:90,column:31},end:{line:90,column:79}},"41":{start:{line:100,column:8},end:{line:111,column:11}},"42":{start:{line:101,column:27},end:{line:101,column:66}},"43":{start:{line:102,column:12},end:{line:110,column:13}},"44":{start:{line:103,column:16},end:{line:103,column:67}},"45":{start:{line:105,column:16},end:{line:105,column:158}},"46":{start:{line:106,column:16},end:{line:106,column:48}},"47":{start:{line:109,column:16},end:{line:109,column:113}},"48":{start:{line:114,column:8},end:{line:130,column:11}},"49":{start:{line:115,column:23},end:{line:115,column:39}},"50":{start:{line:116,column:12},end:{line:128,column:13}},"51":{start:{line:117,column:16},end:{line:127,column:17}},"52":{start:{line:117,column:47},end:{line:117,column:62}},"53":{start:{line:118,column:20},end:{line:118,column:27}},"54":{start:{line:120,column:21},end:{line:127,column:17}},"55":{start:{line:122,column:20},end:{line:122,column:104}},"56":{start:{line:123,column:20},end:{line:123,column:27}},"57":{start:{line:126,column:20},end:{line:126,column:26}},"58":{start:{line:129,column:12},end:{line:129,column:24}},"59":{start:{line:133,column:0},end:{line:133,column:48}},"60":{start:{line:135,column:4},end:{line:146,column:7}},"61":{start:{line:136,column:22},end:{line:138,column:10}},"62":{start:{line:139,column:8},end:{line:145,column:9}},"63":{start:{line:140,column:12},end:{line:140,column:81}},"64":{start:{line:141,column:12},end:{line:141,column:24}},"65":{start:{line:144,column:12},end:{line:144,column:25}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:17,column:44},end:{line:17,column:45}},loc:{start:{line:17,column:89},end:{line:24,column:1}},line:17},"1":{name:"(anonymous_1)",decl:{start:{line:18,column:36},end:{line:18,column:37}},loc:{start:{line:18,column:63},end:{line:23,column:5}},line:18},"2":{name:"fulfilled",decl:{start:{line:19,column:17},end:{line:19,column:26}},loc:{start:{line:19,column:34},end:{line:19,column:99}},line:19},"3":{name:"rejected",decl:{start:{line:20,column:17},end:{line:20,column:25}},loc:{start:{line:20,column:33},end:{line:20,column:102}},line:20},"4":{name:"step",decl:{start:{line:21,column:17},end:{line:21,column:21}},loc:{start:{line:21,column:30},end:{line:21,column:151}},line:21},"5":{name:"(anonymous_5)",decl:{start:{line:21,column:76},end:{line:21,column:77}},loc:{start:{line:21,column:95},end:{line:21,column:121}},line:21},"6":{name:"(anonymous_6)",decl:{start:{line:30,column:36},end:{line:30,column:37}},loc:{start:{line:30,column:52},end:{line:37,column:1}},line:30},"7":{name:"(anonymous_7)",decl:{start:{line:42,column:1},end:{line:42,column:2}},loc:{start:{line:42,column:27},end:{line:46,column:1}},line:42},"8":{name:"(anonymous_8)",decl:{start:{line:53,column:4},end:{line:53,column:5}},loc:{start:{line:53,column:29},end:{line:56,column:5}},line:53},"9":{name:"(anonymous_9)",decl:{start:{line:64,column:4},end:{line:64,column:5}},loc:{start:{line:64,column:39},end:{line:69,column:5}},line:64},"10":{name:"(anonymous_10)",decl:{start:{line:65,column:47},end:{line:65,column:48}},loc:{start:{line:65,column:60},end:{line:68,column:9}},line:65},"11":{name:"(anonymous_11)",decl:{start:{line:70,column:4},end:{line:70,column:5}},loc:{start:{line:70,column:25},end:{line:73,column:5}},line:70},"12":{name:"(anonymous_12)",decl:{start:{line:74,column:4},end:{line:74,column:5}},loc:{start:{line:74,column:39},end:{line:92,column:5}},line:74},"13":{name:"(anonymous_13)",decl:{start:{line:81,column:45},end:{line:81,column:46}},loc:{start:{line:81,column:50},end:{line:81,column:69}},line:81},"14":{name:"(anonymous_14)",decl:{start:{line:87,column:26},end:{line:87,column:27}},loc:{start:{line:87,column:31},end:{line:87,column:108}},line:87},"15":{name:"(anonymous_15)",decl:{start:{line:90,column:26},end:{line:90,column:27}},loc:{start:{line:90,column:31},end:{line:90,column:79}},line:90},"16":{name:"(anonymous_16)",decl:{start:{line:99,column:4},end:{line:99,column:5}},loc:{start:{line:99,column:43},end:{line:112,column:5}},line:99},"17":{name:"(anonymous_17)",decl:{start:{line:100,column:47},end:{line:100,column:48}},loc:{start:{line:100,column:60},end:{line:111,column:9}},line:100},"18":{name:"(anonymous_18)",decl:{start:{line:113,column:4},end:{line:113,column:5}},loc:{start:{line:113,column:23},end:{line:131,column:5}},line:113},"19":{name:"(anonymous_19)",decl:{start:{line:114,column:47},end:{line:114,column:48}},loc:{start:{line:114,column:60},end:{line:130,column:9}},line:114},"20":{name:"(anonymous_20)",decl:{start:{line:117,column:42},end:{line:117,column:43}},loc:{start:{line:117,column:47},end:{line:117,column:62}},line:117},"21":{name:"portIsInUse",decl:{start:{line:134,column:9},end:{line:134,column:20}},loc:{start:{line:134,column:33},end:{line:147,column:1}},line:134},"22":{name:"(anonymous_22)",decl:{start:{line:135,column:43},end:{line:135,column:44}},loc:{start:{line:135,column:56},end:{line:146,column:5}},line:135}},branchMap:{"0":{loc:{start:{line:17,column:16},end:{line:24,column:1}},type:"binary-expr",locations:[{start:{line:17,column:17},end:{line:17,column:21}},{start:{line:17,column:25},end:{line:17,column:39}},{start:{line:17,column:44},end:{line:24,column:1}}],line:17},"1":{loc:{start:{line:18,column:16},end:{line:18,column:34}},type:"binary-expr",locations:[{start:{line:18,column:16},end:{line:18,column:17}},{start:{line:18,column:22},end:{line:18,column:33}}],line:18},"2":{loc:{start:{line:21,column:32},end:{line:21,column:148}},type:"cond-expr",locations:[{start:{line:21,column:46},end:{line:21,column:67}},{start:{line:21,column:70},end:{line:21,column:148}}],line:21},"3":{loc:{start:{line:22,column:51},end:{line:22,column:67}},type:"binary-expr",locations:[{start:{line:22,column:51},end:{line:22,column:61}},{start:{line:22,column:65},end:{line:22,column:67}}],line:22},"4":{loc:{start:{line:46,column:20},end:{line:46,column:75}},type:"binary-expr",locations:[{start:{line:46,column:20},end:{line:46,column:42}},{start:{line:46,column:47},end:{line:46,column:74}}],line:46},"5":{loc:{start:{line:67,column:19},end:{line:67,column:69}},type:"cond-expr",locations:[{start:{line:67,column:31},end:{line:67,column:43}},{start:{line:67,column:46},end:{line:67,column:69}}],line:67},"6":{loc:{start:{line:75,column:8},end:{line:91,column:9}},type:"switch",locations:[{start:{line:76,column:12},end:{line:81,column:71}},{start:{line:82,column:12},end:{line:87,column:110}},{start:{line:88,column:12},end:{line:90,column:81}}],line:75},"7":{loc:{start:{line:77,column:16},end:{line:79,column:17}},type:"if",locations:[{start:{line:77,column:16},end:{line:79,column:17}},{start:{line:77,column:16},end:{line:79,column:17}}],line:77},"8":{loc:{start:{line:83,column:16},end:{line:85,column:17}},type:"if",locations:[{start:{line:83,column:16},end:{line:85,column:17}},{start:{line:83,column:16},end:{line:85,column:17}}],line:83},"9":{loc:{start:{line:87,column:31},end:{line:87,column:108}},type:"binary-expr",locations:[{start:{line:87,column:31},end:{line:87,column:54}},{start:{line:87,column:58},end:{line:87,column:79}},{start:{line:87,column:83},end:{line:87,column:108}}],line:87},"10":{loc:{start:{line:90,column:31},end:{line:90,column:79}},type:"binary-expr",locations:[{start:{line:90,column:31},end:{line:90,column:54}},{start:{line:90,column:58},end:{line:90,column:79}}],line:90},"11":{loc:{start:{line:102,column:12},end:{line:110,column:13}},type:"if",locations:[{start:{line:102,column:12},end:{line:110,column:13}},{start:{line:102,column:12},end:{line:110,column:13}}],line:102},"12":{loc:{start:{line:102,column:16},end:{line:102,column:49}},type:"binary-expr",locations:[{start:{line:102,column:16},end:{line:102,column:24}},{start:{line:102,column:28},end:{line:102,column:49}}],line:102},"13":{loc:{start:{line:117,column:16},end:{line:127,column:17}},type:"if",locations:[{start:{line:117,column:16},end:{line:127,column:17}},{start:{line:117,column:16},end:{line:127,column:17}}],line:117},"14":{loc:{start:{line:120,column:21},end:{line:127,column:17}},type:"if",locations:[{start:{line:120,column:21},end:{line:127,column:17}},{start:{line:120,column:21},end:{line:127,column:17}}],line:120}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0,"49":0,"50":0,"51":0,"52":0,"53":0,"54":0,"55":0,"56":0,"57":0,"58":0,"59":0,"60":0,"61":0,"62":0,"63":0,"64":0,"65":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0},b:{"0":[0,0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0,0],"7":[0,0],"8":[0,0],"9":[0,0,0],"10":[0,0],"11":[0,0],"12":[0,0],"13":[0,0],"14":[0,0]},_coverageSchema:"332fd63041d2c1bcb487cc26dd0d5f7d97098a6c"},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var __awaiter=(cov_144cgafpfa.s[0]++,(cov_144cgafpfa.b[0][0]++,this)&&(cov_144cgafpfa.b[0][1]++,this.__awaiter)||(cov_144cgafpfa.b[0][2]++,function(thisArg,_arguments,P,generator){cov_144cgafpfa.f[0]++;cov_144cgafpfa.s[1]++;return new((cov_144cgafpfa.b[1][0]++,P)||(cov_144cgafpfa.b[1][1]++,P=Promise))(function(resolve,reject){cov_144cgafpfa.f[1]++;function fulfilled(value){cov_144cgafpfa.f[2]++;cov_144cgafpfa.s[2]++;try{cov_144cgafpfa.s[3]++;step(generator.next(value));}catch(e){cov_144cgafpfa.s[4]++;reject(e);}}function rejected(value){cov_144cgafpfa.f[3]++;cov_144cgafpfa.s[5]++;try{cov_144cgafpfa.s[6]++;step(generator["throw"](value));}catch(e){cov_144cgafpfa.s[7]++;reject(e);}}function step(result){cov_144cgafpfa.f[4]++;cov_144cgafpfa.s[8]++;result.done?(cov_144cgafpfa.b[2][0]++,resolve(result.value)):(cov_144cgafpfa.b[2][1]++,new P(function(resolve){cov_144cgafpfa.f[5]++;cov_144cgafpfa.s[9]++;resolve(result.value);}).then(fulfilled,rejected));}cov_144cgafpfa.s[10]++;step((generator=generator.apply(thisArg,(cov_144cgafpfa.b[3][0]++,_arguments)||(cov_144cgafpfa.b[3][1]++,[]))).next());});}));cov_144cgafpfa.s[11]++;Object.defineProperty(exports,"__esModule",{value:true});const automation_client_1=(cov_144cgafpfa.s[12]++,require("@atomist/automation-client"));const axios_1=(cov_144cgafpfa.s[13]++,require("axios"));const https=(cov_144cgafpfa.s[14]++,require("https"));const spawned_1=(cov_144cgafpfa.s[15]++,require("../../../../util/misc/spawned"));cov_144cgafpfa.s[16]++;exports.ManagedDeploymentTargeter=(id,branch)=>{cov_144cgafpfa.f[6]++;const branchId=(cov_144cgafpfa.s[17]++,Object.assign({},id,{branch}));cov_144cgafpfa.s[18]++;return{name:"Run alongside this automation",description:`Locally run ${id.sha} from branch ${branch}`,managedDeploymentKey:branchId};};/**
 * Strategy for looking up a service
 */var LookupStrategy;cov_144cgafpfa.s[19]++;(function(LookupStrategy){cov_144cgafpfa.f[7]++;cov_144cgafpfa.s[20]++;LookupStrategy["service"]="service";cov_144cgafpfa.s[21]++;LookupStrategy["branch"]="branch";cov_144cgafpfa.s[22]++;LookupStrategy["sha"]="sha";})(LookupStrategy=(cov_144cgafpfa.b[4][0]++,exports.LookupStrategy)||(cov_144cgafpfa.b[4][1]++,exports.LookupStrategy={}));/**
 * Manages local deployments to the automation server node
 * This is not intended for production use
 * @type {Array}
 */class ManagedDeployments{constructor(initialPort){cov_144cgafpfa.f[8]++;cov_144cgafpfa.s[23]++;this.initialPort=initialPort;cov_144cgafpfa.s[24]++;this.deployments=[];}/**
     * Find the appropriate port for this app
     * @param {RemoteRepoRef} id
     * @param lookupStrategy strategy for looking up the instance
     * @param host it will be on. Check for ports not in use
     * @return {number}
     */findPort(id,lookupStrategy,host){cov_144cgafpfa.f[9]++;cov_144cgafpfa.s[25]++;return __awaiter(this,void 0,void 0,function*(){cov_144cgafpfa.f[10]++;const running=(cov_144cgafpfa.s[26]++,this.findDeployment(id,lookupStrategy));cov_144cgafpfa.s[27]++;return!!running?(cov_144cgafpfa.b[5][0]++,running.port):(cov_144cgafpfa.b[5][1]++,this.nextFreePort(host));});}recordDeployment(da){cov_144cgafpfa.f[11]++;cov_144cgafpfa.s[28]++;automation_client_1.logger.info("Recording app [%s:%s] on port [%d]",da.id.owner,da.id.repo,da.port);cov_144cgafpfa.s[29]++;this.deployments.push(da);}findDeployment(id,lookupStrategy){cov_144cgafpfa.f[12]++;cov_144cgafpfa.s[30]++;switch(lookupStrategy){case LookupStrategy.sha:cov_144cgafpfa.b[6][0]++;cov_144cgafpfa.s[31]++;if(!id.sha){cov_144cgafpfa.b[7][0]++;cov_144cgafpfa.s[32]++;throw new Error("Sha should have been set to use 'sha' LookupStrategy");}else{cov_144cgafpfa.b[7][1]++;}// Probability of a sha collision is tiny
cov_144cgafpfa.s[33]++;return this.deployments.find(d=>{cov_144cgafpfa.f[13]++;cov_144cgafpfa.s[34]++;return d.id.sha===id.sha;});case LookupStrategy.branch:cov_144cgafpfa.b[6][1]++;cov_144cgafpfa.s[35]++;if(!id.branch){cov_144cgafpfa.b[8][0]++;cov_144cgafpfa.s[36]++;throw new Error("Branch should have been set to use 'branch' LookupStrategy");}else{cov_144cgafpfa.b[8][1]++;}cov_144cgafpfa.s[37]++;return this.deployments.find(d=>{cov_144cgafpfa.f[14]++;cov_144cgafpfa.s[38]++;return(cov_144cgafpfa.b[9][0]++,d.id.owner===id.owner)&&(cov_144cgafpfa.b[9][1]++,d.id.repo===id.repo)&&(cov_144cgafpfa.b[9][2]++,d.id.branch===id.branch);});case LookupStrategy.service:cov_144cgafpfa.b[6][2]++;cov_144cgafpfa.s[39]++;this.deployments.find(d=>{cov_144cgafpfa.f[15]++;cov_144cgafpfa.s[40]++;return(cov_144cgafpfa.b[10][0]++,d.id.owner===id.owner)&&(cov_144cgafpfa.b[10][1]++,d.id.repo===id.repo);});}}/**
     * Terminate any process we're managing on behalf of this id
     * @param {RemoteRepoRef} id
     * @param lookupStrategy strategy for finding the instance
     * @return {Promise<any>}
     */terminateIfRunning(id,lookupStrategy){cov_144cgafpfa.f[16]++;cov_144cgafpfa.s[41]++;return __awaiter(this,void 0,void 0,function*(){cov_144cgafpfa.f[17]++;const victim=(cov_144cgafpfa.s[42]++,this.findDeployment(id,lookupStrategy));cov_144cgafpfa.s[43]++;if((cov_144cgafpfa.b[12][0]++,!!victim)&&(cov_144cgafpfa.b[12][1]++,!!victim.childProcess)){cov_144cgafpfa.b[11][0]++;cov_144cgafpfa.s[44]++;yield spawned_1.poisonAndWait(victim.childProcess);// Keep the port but deallocate the process
cov_144cgafpfa.s[45]++;automation_client_1.logger.info("Killed app [%j] with pid %d, but continuing to reserve port [%d]",id,victim.childProcess.pid,victim.port);cov_144cgafpfa.s[46]++;victim.childProcess=undefined;}else{cov_144cgafpfa.b[11][1]++;cov_144cgafpfa.s[47]++;automation_client_1.logger.info("Was asked to kill app [%j], but no eligible process found",id);}});}nextFreePort(host){cov_144cgafpfa.f[18]++;cov_144cgafpfa.s[48]++;return __awaiter(this,void 0,void 0,function*(){cov_144cgafpfa.f[19]++;let port=(cov_144cgafpfa.s[49]++,this.initialPort);cov_144cgafpfa.s[50]++;while(true){cov_144cgafpfa.s[51]++;if(this.deployments.some(d=>{cov_144cgafpfa.f[20]++;cov_144cgafpfa.s[52]++;return d.port===port;})){cov_144cgafpfa.b[13][0]++;cov_144cgafpfa.s[53]++;port++;}else{cov_144cgafpfa.b[13][1]++;cov_144cgafpfa.s[54]++;if(yield portIsInUse(host,port)){cov_144cgafpfa.b[14][0]++;cov_144cgafpfa.s[55]++;// Skip this port, too
automation_client_1.logger.warn("Unexpected: %s is serving on port %d",host,port);cov_144cgafpfa.s[56]++;port++;}else{cov_144cgafpfa.b[14][1]++;cov_144cgafpfa.s[57]++;break;}}}cov_144cgafpfa.s[58]++;return port;});}}cov_144cgafpfa.s[59]++;exports.ManagedDeployments=ManagedDeployments;function portIsInUse(host,port){cov_144cgafpfa.f[21]++;cov_144cgafpfa.s[60]++;return __awaiter(this,void 0,void 0,function*(){cov_144cgafpfa.f[22]++;const agent=(cov_144cgafpfa.s[61]++,new https.Agent({rejectUnauthorized:false}));cov_144cgafpfa.s[62]++;try{cov_144cgafpfa.s[63]++;yield axios_1.default.head(`${host}:${port}`,{httpsAgent:agent});cov_144cgafpfa.s[64]++;return true;}catch(_a){cov_144cgafpfa.s[65]++;return false;}});}//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL2NvbW1vbi9kZWxpdmVyeS9kZXBsb3kvbG9jYWwvTWFuYWdlZERlcGxveW1lbnRzLnRzIiwic291cmNlcyI6WyIvVXNlcnMvcm9kam9obnNvbi9zZm9yemFuZG8tZGV2L2lkZWEtcHJvamVjdHMvbXktZmxvdy9zcmMvY29tbW9uL2RlbGl2ZXJ5L2RlcGxveS9sb2NhbC9NYW5hZ2VkRGVwbG95bWVudHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7OztHQWNHOzs7Ozs7Ozs7O0FBRUgsa0VBQW9EO0FBRXBELGlDQUEwQjtBQUUxQiwrQkFBK0I7QUFFL0IsMkRBQThEO0FBT2pELFFBQUEseUJBQXlCLEdBQTBDLENBQUMsRUFBaUIsRUFBRSxNQUFjLEVBQUUsRUFBRTtJQUNsSCxNQUFNLFFBQVEscUJBQU8sRUFBRSxJQUFFLE1BQU0sR0FBQyxDQUFDO0lBQ2pDLE9BQU87UUFDSCxJQUFJLEVBQUUsK0JBQStCO1FBQ3JDLFdBQVcsRUFBRSxlQUFlLEVBQUUsQ0FBQyxHQUFHLGdCQUFnQixNQUFNLEVBQUU7UUFDMUQsb0JBQW9CLEVBQUUsUUFBUTtLQUNqQyxDQUFDO0FBQ04sQ0FBQyxDQUFDO0FBRUY7O0dBRUc7QUFDSCxJQUFZLGNBSVg7QUFKRCxXQUFZLGNBQWM7SUFDdEIscUNBQW1CLENBQUE7SUFDbkIsbUNBQWlCLENBQUE7SUFDakIsNkJBQVcsQ0FBQTtBQUNmLENBQUMsRUFKVyxjQUFjLEdBQWQsc0JBQWMsS0FBZCxzQkFBYyxRQUl6QjtBQW1CRDs7OztHQUlHO0FBQ0g7SUFJSSxZQUFtQixXQUFtQjtRQUFuQixnQkFBVyxHQUFYLFdBQVcsQ0FBUTtRQUZ0QixnQkFBVyxHQUFrQixFQUFFLENBQUM7SUFHaEQsQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNVLFFBQVEsQ0FBQyxFQUFpQixFQUFFLGNBQThCLEVBQUUsSUFBWTs7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V0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDLEVBQUU7b0JBQzdDLElBQUksRUFBRSxDQUFDO2lCQUNWO3FCQUFNLElBQUksTUFBTSxXQUFXLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFO29CQUN0QyxzQkFBc0I7b0JBQ3RCLDBCQUFNLENBQUMsSUFBSSxDQUFDLHNDQUFzQyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztvQkFDaEUsSUFBSSxFQUFFLENBQUM7aUJBQ1Y7cUJBQU07b0JBQ0gsTUFBTTtpQkFDVDthQUNKO1lBQ0QsT0FBTyxJQUFJLENBQUM7UUFDaEIsQ0FBQztLQUFBO0NBRUo7QUEvRUQsZ0RBK0VDO0FBRUQscUJBQTJCLElBQVksRUFBRSxJQUFZOztRQUNqRCxNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUM7WUFDMUIsa0JBQWtCLEVBQUUsS0FBSztTQUM1QixDQUFDLENBQUM7UUFDSCxJQUFJO1lBQ0EsTUFBTSxlQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxJQUFJLElBQUksRUFBRSxFQUFFLEVBQUMsVUFBVSxFQUFFLEtBQUssRUFBQyxDQUFDLENBQUM7WUFDekQsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUFDLFdBQU07WUFDSixPQUFPLEtBQUssQ0FBQztTQUNoQjtJQUNMLENBQUM7Q0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgwqkgMjAxOCBBdG9taXN0LCBJbmMuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudFwiO1xuaW1wb3J0IHsgUmVtb3RlUmVwb1JlZiwgUmVwb1JlZiB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudC9vcGVyYXRpb25zL2NvbW1vbi9SZXBvSWRcIjtcbmltcG9ydCBheGlvcyBmcm9tIFwiYXhpb3NcIjtcbmltcG9ydCB7IENoaWxkUHJvY2VzcyB9IGZyb20gXCJjaGlsZF9wcm9jZXNzXCI7XG5pbXBvcnQgKiBhcyBodHRwcyBmcm9tIFwiaHR0cHNcIjtcbmltcG9ydCB7IERlcGxveW1lbnQsIFRhcmdldEluZm8gfSBmcm9tIFwiLi4vLi4vLi4vLi4vc3BpL2RlcGxveS9EZXBsb3ltZW50XCI7XG5pbXBvcnQgeyBwb2lzb25BbmRXYWl0IH0gZnJvbSBcIi4uLy4uLy4uLy4uL3V0aWwvbWlzYy9zcGF3bmVkXCI7XG5pbXBvcnQgeyBUYXJnZXRlciB9IGZyb20gXCIuLi9kZXBsb3lcIjtcblxuZXhwb3J0IGludGVyZmFjZSBNYW5hZ2VkRGVwbG95bWVudFRhcmdldEluZm8gZXh0ZW5kcyBUYXJnZXRJbmZvIHtcbiAgICBtYW5hZ2VkRGVwbG95bWVudEtleTogUmVtb3RlUmVwb1JlZjtcbn1cblxuZXhwb3J0IGNvbnN0IE1hbmFnZWREZXBsb3ltZW50VGFyZ2V0ZXI6IFRhcmdldGVyPE1hbmFnZWREZXBsb3ltZW50VGFyZ2V0SW5mbz4gPSAoaWQ6IFJlbW90ZVJlcG9SZWYsIGJyYW5jaDogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgYnJhbmNoSWQgPSB7Li4uaWQsIGJyYW5jaH07XG4gICAgcmV0dXJuIHtcbiAgICAgICAgbmFtZTogXCJSdW4gYWxvbmdzaWRlIHRoaXMgYXV0b21hdGlvblwiLFxuICAgICAgICBkZXNjcmlwdGlvbjogYExvY2FsbHkgcnVuICR7aWQuc2hhfSBmcm9tIGJyYW5jaCAke2JyYW5jaH1gLFxuICAgICAgICBtYW5hZ2VkRGVwbG95bWVudEtleTogYnJhbmNoSWQsXG4gICAgfTtcbn07XG5cbi8qKlxuICogU3RyYXRlZ3kgZm9yIGxvb2tpbmcgdXAgYSBzZXJ2aWNlXG4gKi9cbmV4cG9ydCBlbnVtIExvb2t1cFN0cmF0ZWd5IHtcbiAgICBzZXJ2aWNlID0gXCJzZXJ2aWNlXCIsXG4gICAgYnJhbmNoID0gXCJicmFuY2hcIixcbiAgICBzaGEgPSBcInNoYVwiLFxufVxuXG4vKipcbiAqIFBvcnRzIHdpbGwgYmUgcmV1c2VkIGZvciB0aGUgc2FtZSBhcHBcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBEZXBsb3llZEFwcCB7XG5cbiAgICBpZDogUmVwb1JlZjtcblxuICAgIHBvcnQ6IG51bWJlcjtcblxuICAgIC8qKiBXaWxsIGJlIHVuZGVmaW5lZCBpZiB0aGUgYXBwIGlzIG5vdCBjdXJyZW50bHkgZGVwbG95ZWQgKi9cbiAgICBjaGlsZFByb2Nlc3M6IENoaWxkUHJvY2VzcztcblxuICAgIGRlcGxveW1lbnQ6IERlcGxveW1lbnQ7XG5cbiAgICBsb29rdXBTdHJhdGVneTogTG9va3VwU3RyYXRlZ3k7XG59XG5cbi8qKlxuICogTWFuYWdlcyBsb2NhbCBkZXBsb3ltZW50cyB0byB0aGUgYXV0b21hdGlvbiBzZXJ2ZXIgbm9kZVxuICogVGhpcyBpcyBub3QgaW50ZW5kZWQgZm9yIHByb2R1Y3Rpb24gdXNlXG4gKiBAdHlwZSB7QXJyYXl9XG4gKi9cbmV4cG9ydCBjbGFzcyBNYW5hZ2VkRGVwbG95bWVudHMge1xuXG4gICAgcHVibGljIHJlYWRvbmx5IGRlcGxveW1lbnRzOiBEZXBsb3llZEFwcFtdID0gW107XG5cbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgaW5pdGlhbFBvcnQ6IG51bWJlcikge1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZpbmQgdGhlIGFwcHJvcHJpYXRlIHBvcnQgZm9yIHRoaXMgYXBwXG4gICAgICogQHBhcmFtIHtSZW1vdGVSZXBvUmVmfSBpZFxuICAgICAqIEBwYXJhbSBsb29rdXBTdHJhdGVneSBzdHJhdGVneSBmb3IgbG9va2luZyB1cCB0aGUgaW5zdGFuY2VcbiAgICAgKiBAcGFyYW0gaG9zdCBpdCB3aWxsIGJlIG9uLiBDaGVjayBmb3IgcG9ydHMgbm90IGluIHVzZVxuICAgICAqIEByZXR1cm4ge251bWJlcn1cbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgZmluZFBvcnQoaWQ6IFJlbW90ZVJlcG9SZWYsIGxvb2t1cFN0cmF0ZWd5OiBMb29rdXBTdHJhdGVneSwgaG9zdDogc3RyaW5nKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICAgICAgY29uc3QgcnVubmluZyA9IHRoaXMuZmluZERlcGxveW1lbnQoaWQsIGxvb2t1cFN0cmF0ZWd5KTtcbiAgICAgICAgcmV0dXJuICEhcnVubmluZyA/IHJ1bm5pbmcucG9ydCA6IHRoaXMubmV4dEZyZWVQb3J0KGhvc3QpO1xuICAgIH1cblxuICAgIHB1YmxpYyByZWNvcmREZXBsb3ltZW50KGRhOiBEZXBsb3llZEFwcCkge1xuICAgICAgICBsb2dnZXIuaW5mbyhcIlJlY29yZGluZyBhcHAgWyVzOiVzXSBvbiBwb3J0IFslZF1cIiwgZGEuaWQub3duZXIsIGRhLmlkLnJlcG8sIGRhLnBvcnQpO1xuICAgICAgICB0aGlzLmRlcGxveW1lbnRzLnB1c2goZGEpO1xuICAgIH1cblxuICAgIHB1YmxpYyBmaW5kRGVwbG95bWVudChpZDogUmVtb3RlUmVwb1JlZiwgbG9va3VwU3RyYXRlZ3k6IExvb2t1cFN0cmF0ZWd5KTogRGVwbG95ZWRBcHAge1xuICAgICAgICBzd2l0Y2ggKGxvb2t1cFN0cmF0ZWd5KSB7XG4gICAgICAgICAgICBjYXNlICBMb29rdXBTdHJhdGVneS5zaGEgOlxuICAgICAgICAgICAgICAgIGlmICghaWQuc2hhKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlNoYSBzaG91bGQgaGF2ZSBiZWVuIHNldCB0byB1c2UgJ3NoYScgTG9va3VwU3RyYXRlZ3lcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIFByb2JhYmlsaXR5IG9mIGEgc2hhIGNvbGxpc2lvbiBpcyB0aW55XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGVwbG95bWVudHMuZmluZChkID0+IGQuaWQuc2hhID09PSBpZC5zaGEpO1xuICAgICAgICAgICAgY2FzZSBMb29rdXBTdHJhdGVneS5icmFuY2ggOlxuICAgICAgICAgICAgICAgIGlmICghaWQuYnJhbmNoKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkJyYW5jaCBzaG91bGQgaGF2ZSBiZWVuIHNldCB0byB1c2UgJ2JyYW5jaCcgTG9va3VwU3RyYXRlZ3lcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRlcGxveW1lbnRzXG4gICAgICAgICAgICAgICAgICAgIC5maW5kKGQgPT4gZC5pZC5vd25lciA9PT0gaWQub3duZXIgJiYgZC5pZC5yZXBvID09PSBpZC5yZXBvICYmIGQuaWQuYnJhbmNoID09PSBpZC5icmFuY2gpO1xuICAgICAgICAgICAgY2FzZSBMb29rdXBTdHJhdGVneS5zZXJ2aWNlOlxuICAgICAgICAgICAgICAgIHRoaXMuZGVwbG95bWVudHNcbiAgICAgICAgICAgICAgICAgICAgLmZpbmQoZCA9PiBkLmlkLm93bmVyID09PSBpZC5vd25lciAmJiBkLmlkLnJlcG8gPT09IGlkLnJlcG8pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGVybWluYXRlIGFueSBwcm9jZXNzIHdlJ3JlIG1hbmFnaW5nIG9uIGJlaGFsZiBvZiB0aGlzIGlkXG4gICAgICogQHBhcmFtIHtSZW1vdGVSZXBvUmVmfSBpZFxuICAgICAqIEBwYXJhbSBsb29rdXBTdHJhdGVneSBzdHJhdGVneSBmb3IgZmluZGluZyB0aGUgaW5zdGFuY2VcbiAgICAgKiBAcmV0dXJuIHtQcm9taXNlPGFueT59XG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIHRlcm1pbmF0ZUlmUnVubmluZyhpZDogUmVtb3RlUmVwb1JlZiwgbG9va3VwU3RyYXRlZ3k6IExvb2t1cFN0cmF0ZWd5KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgdmljdGltID0gdGhpcy5maW5kRGVwbG95bWVudChpZCwgbG9va3VwU3RyYXRlZ3kpO1xuICAgICAgICBpZiAoISF2aWN0aW0gJiYgISF2aWN0aW0uY2hpbGRQcm9jZXNzKSB7XG4gICAgICAgICAgICBhd2FpdCBwb2lzb25BbmRXYWl0KHZpY3RpbS5jaGlsZFByb2Nlc3MpO1xuICAgICAgICAgICAgLy8gS2VlcCB0aGUgcG9ydCBidXQgZGVhbGxvY2F0ZSB0aGUgcHJvY2Vzc1xuICAgICAgICAgICAgbG9nZ2VyLmluZm8oXCJLaWxsZWQgYXBwIFslal0gd2l0aCBwaWQgJWQsIGJ1dCBjb250aW51aW5nIHRvIHJlc2VydmUgcG9ydCBbJWRdXCIsXG4gICAgICAgICAgICAgICAgaWQsIHZpY3RpbS5jaGlsZFByb2Nlc3MucGlkLCB2aWN0aW0ucG9ydCk7XG4gICAgICAgICAgICB2aWN0aW0uY2hpbGRQcm9jZXNzID0gdW5kZWZpbmVkO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbG9nZ2VyLmluZm8oXCJXYXMgYXNrZWQgdG8ga2lsbCBhcHAgWyVqXSwgYnV0IG5vIGVsaWdpYmxlIHByb2Nlc3MgZm91bmRcIiwgaWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBuZXh0RnJlZVBvcnQoaG9zdDogc3RyaW5nKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICAgICAgbGV0IHBvcnQgPSB0aGlzLmluaXRpYWxQb3J0O1xuICAgICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuZGVwbG95bWVudHMuc29tZShkID0+IGQucG9ydCA9PT0gcG9ydCkpIHtcbiAgICAgICAgICAgICAgICBwb3J0Kys7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGF3YWl0IHBvcnRJc0luVXNlKGhvc3QsIHBvcnQpKSB7XG4gICAgICAgICAgICAgICAgLy8gU2tpcCB0aGlzIHBvcnQsIHRvb1xuICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuKFwiVW5leHBlY3RlZDogJXMgaXMgc2VydmluZyBvbiBwb3J0ICVkXCIsIGhvc3QsIHBvcnQpO1xuICAgICAgICAgICAgICAgIHBvcnQrKztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHBvcnQ7XG4gICAgfVxuXG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBvcnRJc0luVXNlKGhvc3Q6IHN0cmluZywgcG9ydDogbnVtYmVyKSB7XG4gICAgY29uc3QgYWdlbnQgPSBuZXcgaHR0cHMuQWdlbnQoe1xuICAgICAgICByZWplY3RVbmF1dGhvcml6ZWQ6IGZhbHNlLFxuICAgIH0pO1xuICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGF4aW9zLmhlYWQoYCR7aG9zdH06JHtwb3J0fWAsIHtodHRwc0FnZW50OiBhZ2VudH0pO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbn1cbiJdfQ==