"use strict";/*
 * Copyright Â© 2018 Atomist, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var cov_2hk31teq5h=function(){var path="/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/delivery/deploy/local/jar/executableJarDeployer.ts",hash="716349e185949b4963e880ded35cb1b619467e54",Function=function(){}.constructor,global=new Function('return this')(),gcv="__coverage__",coverageData={path:"/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/delivery/deploy/local/jar/executableJarDeployer.ts",statementMap:{"0":{start:{line:17,column:16},end:{line:24,column:1}},"1":{start:{line:18,column:4},end:{line:23,column:7}},"2":{start:{line:19,column:36},end:{line:19,column:97}},"3":{start:{line:19,column:42},end:{line:19,column:70}},"4":{start:{line:19,column:85},end:{line:19,column:95}},"5":{start:{line:20,column:35},end:{line:20,column:100}},"6":{start:{line:20,column:41},end:{line:20,column:73}},"7":{start:{line:20,column:88},end:{line:20,column:98}},"8":{start:{line:21,column:32},end:{line:21,column:149}},"9":{start:{line:21,column:97},end:{line:21,column:119}},"10":{start:{line:22,column:8},end:{line:22,column:78}},"11":{start:{line:25,column:0},end:{line:25,column:62}},"12":{start:{line:26,column:28},end:{line:26,column:65}},"13":{start:{line:27,column:24},end:{line:27,column:48}},"14":{start:{line:28,column:45},end:{line:28,column:106}},"15":{start:{line:29,column:26},end:{line:29,column:75}},"16":{start:{line:30,column:31},end:{line:30,column:65}},"17":{start:{line:31,column:29},end:{line:31,column:61}},"18":{start:{line:39,column:4},end:{line:42,column:5}},"19":{start:{line:40,column:8},end:{line:40,column:75}},"20":{start:{line:41,column:8},end:{line:41,column:110}},"21":{start:{line:43,column:4},end:{line:43,column:114}},"22":{start:{line:45,column:0},end:{line:45,column:54}},"23":{start:{line:48,column:8},end:{line:48,column:25}},"24":{start:{line:49,column:8},end:{line:49,column:101}},"25":{start:{line:52,column:8},end:{line:55,column:11}},"26":{start:{line:53,column:35},end:{line:53,column:57}},"27":{start:{line:54,column:12},end:{line:54,column:58}},"28":{start:{line:58,column:8},end:{line:60,column:11}},"29":{start:{line:59,column:12},end:{line:59,column:148}},"30":{start:{line:63,column:24},end:{line:63,column:148}},"31":{start:{line:64,column:8},end:{line:66,column:9}},"32":{start:{line:65,column:12},end:{line:65,column:29}},"33":{start:{line:67,column:21},end:{line:67,column:33}},"34":{start:{line:68,column:24},end:{line:68,column:41}},"35":{start:{line:69,column:8},end:{line:71,column:10}},"36":{start:{line:74,column:8},end:{line:74,column:49}},"37":{start:{line:77,column:8},end:{line:120,column:11}},"38":{start:{line:78,column:12},end:{line:80,column:13}},"39":{start:{line:79,column:16},end:{line:79,column:71}},"40":{start:{line:81,column:25},end:{line:81,column:168}},"41":{start:{line:82,column:12},end:{line:82,column:114}},"42":{start:{line:83,column:32},end:{line:87,column:13}},"43":{start:{line:88,column:12},end:{line:88,column:147}},"44":{start:{line:89,column:33},end:{line:94,column:14}},"45":{start:{line:95,column:40},end:{line:95,column:126}},"46":{start:{line:96,column:12},end:{line:96,column:95}},"47":{start:{line:96,column:51},end:{line:96,column:93}},"48":{start:{line:97,column:12},end:{line:97,column:95}},"49":{start:{line:97,column:51},end:{line:97,column:93}},"50":{start:{line:98,column:31},end:{line:101,column:13}},"51":{start:{line:102,column:12},end:{line:108,column:15}},"52":{start:{line:109,column:12},end:{line:119,column:20}},"53":{start:{line:110,column:20},end:{line:114,column:24}},"54":{start:{line:110,column:70},end:{line:114,column:22}},"55":{start:{line:111,column:24},end:{line:113,column:25}},"56":{start:{line:111,column:87},end:{line:111,column:123}},"57":{start:{line:112,column:28},end:{line:112,column:48}},"58":{start:{line:115,column:20},end:{line:117,column:23}},"59":{start:{line:116,column:24},end:{line:116,column:122}},"60":{start:{line:118,column:20},end:{line:118,column:62}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:17,column:44},end:{line:17,column:45}},loc:{start:{line:17,column:89},end:{line:24,column:1}},line:17},"1":{name:"(anonymous_1)",decl:{start:{line:18,column:36},end:{line:18,column:37}},loc:{start:{line:18,column:63},end:{line:23,column:5}},line:18},"2":{name:"fulfilled",decl:{start:{line:19,column:17},end:{line:19,column:26}},loc:{start:{line:19,column:34},end:{line:19,column:99}},line:19},"3":{name:"rejected",decl:{start:{line:20,column:17},end:{line:20,column:25}},loc:{start:{line:20,column:33},end:{line:20,column:102}},line:20},"4":{name:"step",decl:{start:{line:21,column:17},end:{line:21,column:21}},loc:{start:{line:21,column:30},end:{line:21,column:151}},line:21},"5":{name:"(anonymous_5)",decl:{start:{line:21,column:76},end:{line:21,column:77}},loc:{start:{line:21,column:95},end:{line:21,column:121}},line:21},"6":{name:"executableJarDeployer",decl:{start:{line:38,column:9},end:{line:38,column:30}},loc:{start:{line:38,column:37},end:{line:44,column:1}},line:38},"7":{name:"(anonymous_7)",decl:{start:{line:47,column:4},end:{line:47,column:5}},loc:{start:{line:47,column:22},end:{line:50,column:5}},line:47},"8":{name:"(anonymous_8)",decl:{start:{line:51,column:4},end:{line:51,column:5}},loc:{start:{line:51,column:35},end:{line:56,column:5}},line:51},"9":{name:"(anonymous_9)",decl:{start:{line:52,column:47},end:{line:52,column:48}},loc:{start:{line:52,column:60},end:{line:55,column:9}},line:52},"10":{name:"(anonymous_10)",decl:{start:{line:57,column:4},end:{line:57,column:5}},loc:{start:{line:57,column:34},end:{line:61,column:5}},line:57},"11":{name:"(anonymous_11)",decl:{start:{line:58,column:47},end:{line:58,column:48}},loc:{start:{line:58,column:60},end:{line:60,column:9}},line:58},"12":{name:"(anonymous_12)",decl:{start:{line:62,column:4},end:{line:62,column:5}},loc:{start:{line:62,column:22},end:{line:72,column:5}},line:62},"13":{name:"(anonymous_13)",decl:{start:{line:73,column:4},end:{line:73,column:5}},loc:{start:{line:73,column:20},end:{line:75,column:5}},line:73},"14":{name:"(anonymous_14)",decl:{start:{line:76,column:4},end:{line:76,column:5}},loc:{start:{line:76,column:50},end:{line:121,column:5}},line:76},"15":{name:"(anonymous_15)",decl:{start:{line:77,column:47},end:{line:77,column:48}},loc:{start:{line:77,column:60},end:{line:120,column:9}},line:77},"16":{name:"(anonymous_16)",decl:{start:{line:96,column:43},end:{line:96,column:44}},loc:{start:{line:96,column:51},end:{line:96,column:93}},line:96},"17":{name:"(anonymous_17)",decl:{start:{line:97,column:43},end:{line:97,column:44}},loc:{start:{line:97,column:51},end:{line:97,column:93}},line:97},"18":{name:"(anonymous_18)",decl:{start:{line:109,column:38},end:{line:109,column:39}},loc:{start:{line:109,column:59},end:{line:119,column:17}},line:109},"19":{name:"(anonymous_19)",decl:{start:{line:110,column:60},end:{line:110,column:61}},loc:{start:{line:110,column:70},end:{line:114,column:22}},line:110},"20":{name:"(anonymous_20)",decl:{start:{line:110,column:102},end:{line:110,column:103}},loc:{start:{line:110,column:115},end:{line:114,column:21}},line:110},"21":{name:"(anonymous_21)",decl:{start:{line:111,column:69},end:{line:111,column:70}},loc:{start:{line:111,column:87},end:{line:111,column:123}},line:111},"22":{name:"(anonymous_22)",decl:{start:{line:115,column:53},end:{line:115,column:54}},loc:{start:{line:115,column:59},end:{line:117,column:21}},line:115}},branchMap:{"0":{loc:{start:{line:17,column:16},end:{line:24,column:1}},type:"binary-expr",locations:[{start:{line:17,column:17},end:{line:17,column:21}},{start:{line:17,column:25},end:{line:17,column:39}},{start:{line:17,column:44},end:{line:24,column:1}}],line:17},"1":{loc:{start:{line:18,column:16},end:{line:18,column:34}},type:"binary-expr",locations:[{start:{line:18,column:16},end:{line:18,column:17}},{start:{line:18,column:22},end:{line:18,column:33}}],line:18},"2":{loc:{start:{line:21,column:32},end:{line:21,column:148}},type:"cond-expr",locations:[{start:{line:21,column:46},end:{line:21,column:67}},{start:{line:21,column:70},end:{line:21,column:148}}],line:21},"3":{loc:{start:{line:22,column:51},end:{line:22,column:67}},type:"binary-expr",locations:[{start:{line:22,column:51},end:{line:22,column:61}},{start:{line:22,column:65},end:{line:22,column:67}}],line:22},"4":{loc:{start:{line:39,column:4},end:{line:42,column:5}},type:"if",locations:[{start:{line:39,column:4},end:{line:42,column:5}},{start:{line:39,column:4},end:{line:42,column:5}}],line:39},"5":{loc:{start:{line:54,column:19},end:{line:54,column:57}},type:"cond-expr",locations:[{start:{line:54,column:36},end:{line:54,column:52}},{start:{line:54,column:55},end:{line:54,column:57}}],line:54},"6":{loc:{start:{line:64,column:8},end:{line:66,column:9}},type:"if",locations:[{start:{line:64,column:8},end:{line:66,column:9}},{start:{line:64,column:8},end:{line:66,column:9}}],line:64},"7":{loc:{start:{line:78,column:12},end:{line:80,column:13}},type:"if",locations:[{start:{line:78,column:12},end:{line:80,column:13}},{start:{line:78,column:12},end:{line:80,column:13}}],line:78},"8":{loc:{start:{line:111,column:24},end:{line:113,column:25}},type:"if",locations:[{start:{line:111,column:24},end:{line:113,column:25}},{start:{line:111,column:24},end:{line:113,column:25}}],line:111},"9":{loc:{start:{line:111,column:28},end:{line:111,column:124}},type:"binary-expr",locations:[{start:{line:111,column:28},end:{line:111,column:34}},{start:{line:111,column:38},end:{line:111,column:124}}],line:111}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0,"49":0,"50":0,"51":0,"52":0,"53":0,"54":0,"55":0,"56":0,"57":0,"58":0,"59":0,"60":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0},b:{"0":[0,0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0,0],"8":[0,0],"9":[0,0]},_coverageSchema:"332fd63041d2c1bcb487cc26dd0d5f7d97098a6c"},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var __awaiter=(cov_2hk31teq5h.s[0]++,(cov_2hk31teq5h.b[0][0]++,this)&&(cov_2hk31teq5h.b[0][1]++,this.__awaiter)||(cov_2hk31teq5h.b[0][2]++,function(thisArg,_arguments,P,generator){cov_2hk31teq5h.f[0]++;cov_2hk31teq5h.s[1]++;return new((cov_2hk31teq5h.b[1][0]++,P)||(cov_2hk31teq5h.b[1][1]++,P=Promise))(function(resolve,reject){cov_2hk31teq5h.f[1]++;function fulfilled(value){cov_2hk31teq5h.f[2]++;cov_2hk31teq5h.s[2]++;try{cov_2hk31teq5h.s[3]++;step(generator.next(value));}catch(e){cov_2hk31teq5h.s[4]++;reject(e);}}function rejected(value){cov_2hk31teq5h.f[3]++;cov_2hk31teq5h.s[5]++;try{cov_2hk31teq5h.s[6]++;step(generator["throw"](value));}catch(e){cov_2hk31teq5h.s[7]++;reject(e);}}function step(result){cov_2hk31teq5h.f[4]++;cov_2hk31teq5h.s[8]++;result.done?(cov_2hk31teq5h.b[2][0]++,resolve(result.value)):(cov_2hk31teq5h.b[2][1]++,new P(function(resolve){cov_2hk31teq5h.f[5]++;cov_2hk31teq5h.s[9]++;resolve(result.value);}).then(fulfilled,rejected));}cov_2hk31teq5h.s[10]++;step((generator=generator.apply(thisArg,(cov_2hk31teq5h.b[3][0]++,_arguments)||(cov_2hk31teq5h.b[3][1]++,[]))).next());});}));cov_2hk31teq5h.s[11]++;Object.defineProperty(exports,"__esModule",{value:true});const automation_client_1=(cov_2hk31teq5h.s[12]++,require("@atomist/automation-client"));const child_process_1=(cov_2hk31teq5h.s[13]++,require("child_process"));const DelimitedWriteProgressLogDecorator_1=(cov_2hk31teq5h.s[14]++,require("../../../../log/DelimitedWriteProgressLogDecorator"));const logInterpreters_1=(cov_2hk31teq5h.s[15]++,require("../../../goals/support/logInterpreters"));const LocalDeployerOptions_1=(cov_2hk31teq5h.s[16]++,require("../LocalDeployerOptions"));const ManagedDeployments_1=(cov_2hk31teq5h.s[17]++,require("../ManagedDeployments"));/**
 * Start up an executable Jar on the same node as the automation client.
 * Not intended as a Paas, but for use during demos and development.
 * Always uses the same URL, whatever the branch and sha.
 * @param opts options
 */function executableJarDeployer(opts){cov_2hk31teq5h.f[6]++;cov_2hk31teq5h.s[18]++;if(!exports.managedExecutableJarDeployments){cov_2hk31teq5h.b[4][0]++;cov_2hk31teq5h.s[19]++;automation_client_1.logger.debug("Created new deployments record");cov_2hk31teq5h.s[20]++;exports.managedExecutableJarDeployments=new ManagedDeployments_1.ManagedDeployments(opts.lowerPort);}else{cov_2hk31teq5h.b[4][1]++;}cov_2hk31teq5h.s[21]++;return new ExecutableJarDeployer(Object.assign({},LocalDeployerOptions_1.DefaultLocalDeployerOptions,opts));}cov_2hk31teq5h.s[22]++;exports.executableJarDeployer=executableJarDeployer;class ExecutableJarDeployer{constructor(opts){cov_2hk31teq5h.f[7]++;cov_2hk31teq5h.s[23]++;this.opts=opts;cov_2hk31teq5h.s[24]++;this.logInterpreter=logInterpreters_1.lastLinesLogInterpreter("Executable jar deployment");}findDeployments(id,ti,creds){cov_2hk31teq5h.f[8]++;cov_2hk31teq5h.s[25]++;return __awaiter(this,void 0,void 0,function*(){cov_2hk31teq5h.f[9]++;const thisDeployment=(cov_2hk31teq5h.s[26]++,this.deploymentFor(ti));cov_2hk31teq5h.s[27]++;return thisDeployment?(cov_2hk31teq5h.b[5][0]++,[thisDeployment]):(cov_2hk31teq5h.b[5][1]++,[]);});}undeploy(id,deployment,log){cov_2hk31teq5h.f[10]++;cov_2hk31teq5h.s[28]++;return __awaiter(this,void 0,void 0,function*(){cov_2hk31teq5h.f[11]++;cov_2hk31teq5h.s[29]++;return exports.managedExecutableJarDeployments.terminateIfRunning(id.managedDeploymentKey,ManagedDeployments_1.LookupStrategy.service);});}deploymentFor(ti){cov_2hk31teq5h.f[12]++;const managed=(cov_2hk31teq5h.s[30]++,exports.managedExecutableJarDeployments.findDeployment(ti.managedDeploymentKey,ManagedDeployments_1.LookupStrategy.service));cov_2hk31teq5h.s[31]++;if(!managed){cov_2hk31teq5h.b[6][0]++;cov_2hk31teq5h.s[32]++;return undefined;}else{cov_2hk31teq5h.b[6][1]++;}const port=(cov_2hk31teq5h.s[33]++,managed.port);const baseUrl=(cov_2hk31teq5h.s[34]++,this.opts.baseUrl);cov_2hk31teq5h.s[35]++;return{endpoint:`${baseUrl}:${port}/${this.contextRoot(ti.managedDeploymentKey)}`};}contextRoot(id){cov_2hk31teq5h.f[13]++;cov_2hk31teq5h.s[36]++;return`/${id.owner}/${id.repo}/staging`;}deploy(da,ti,log,credentials,atomistTeam){cov_2hk31teq5h.f[14]++;cov_2hk31teq5h.s[37]++;return __awaiter(this,void 0,void 0,function*(){cov_2hk31teq5h.f[15]++;cov_2hk31teq5h.s[38]++;if(!da.filename){cov_2hk31teq5h.b[7][0]++;cov_2hk31teq5h.s[39]++;throw new Error("No filename in deployable artifact!");}else{cov_2hk31teq5h.b[7][1]++;}const port=(cov_2hk31teq5h.s[40]++,yield exports.managedExecutableJarDeployments.findPort(ti.managedDeploymentKey,ManagedDeployments_1.LookupStrategy.service,this.opts.baseUrl));cov_2hk31teq5h.s[41]++;automation_client_1.logger.info("Deploying app [%j] on port [%d] for team %s",da,port,atomistTeam);const startupInfo=(cov_2hk31teq5h.s[42]++,{port,atomistTeam,contextRoot:this.contextRoot(da.id)});cov_2hk31teq5h.s[43]++;yield exports.managedExecutableJarDeployments.terminateIfRunning(ti.managedDeploymentKey,ManagedDeployments_1.LookupStrategy.service);const childProcess=(cov_2hk31teq5h.s[44]++,child_process_1.spawn("java",["-jar",da.filename].concat(this.opts.commandLineArgumentsFor(startupInfo)),{cwd:da.cwd}));const newLineDelimitedLog=(cov_2hk31teq5h.s[45]++,new DelimitedWriteProgressLogDecorator_1.DelimitedWriteProgressLogDecorator(log,"\n"));cov_2hk31teq5h.s[46]++;childProcess.stdout.on("data",what=>{cov_2hk31teq5h.f[16]++;cov_2hk31teq5h.s[47]++;return newLineDelimitedLog.write(what.toString());});cov_2hk31teq5h.s[48]++;childProcess.stderr.on("data",what=>{cov_2hk31teq5h.f[17]++;cov_2hk31teq5h.s[49]++;return newLineDelimitedLog.write(what.toString());});const deployment=(cov_2hk31teq5h.s[50]++,{childProcess,endpoint:`${this.opts.baseUrl}:${port}/${this.contextRoot(ti.managedDeploymentKey)}`});cov_2hk31teq5h.s[51]++;exports.managedExecutableJarDeployments.recordDeployment({id:ti.managedDeploymentKey,port,childProcess,deployment,lookupStrategy:ManagedDeployments_1.LookupStrategy.service});cov_2hk31teq5h.s[52]++;return[yield new Promise((resolve,reject)=>{cov_2hk31teq5h.f[18]++;cov_2hk31teq5h.s[53]++;childProcess.stdout.addListener("data",what=>{cov_2hk31teq5h.f[19]++;cov_2hk31teq5h.s[54]++;return __awaiter(this,void 0,void 0,function*(){cov_2hk31teq5h.f[20]++;cov_2hk31teq5h.s[55]++;if((cov_2hk31teq5h.b[9][0]++,!!what)&&(cov_2hk31teq5h.b[9][1]++,this.opts.successPatterns.some(successPattern=>{cov_2hk31teq5h.f[21]++;cov_2hk31teq5h.s[56]++;return successPattern.test(what.toString());}))){cov_2hk31teq5h.b[8][0]++;cov_2hk31teq5h.s[57]++;resolve(deployment);}else{cov_2hk31teq5h.b[8][1]++;}});});cov_2hk31teq5h.s[58]++;childProcess.addListener("exit",()=>{cov_2hk31teq5h.f[22]++;cov_2hk31teq5h.s[59]++;reject(new Error("ExecutableJarDeployer: We should have found success message pattern by now!!"));});cov_2hk31teq5h.s[60]++;childProcess.addListener("error",reject);})];});}}//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL2NvbW1vbi9kZWxpdmVyeS9kZXBsb3kvbG9jYWwvamFyL2V4ZWN1dGFibGVKYXJEZXBsb3llci50cyIsInNvdXJjZXMiOlsiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL2NvbW1vbi9kZWxpdmVyeS9kZXBsb3kvbG9jYWwvamFyL2V4ZWN1dGFibGVKYXJEZXBsb3llci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7O0dBY0c7Ozs7Ozs7Ozs7QUFFSCxrRUFBb0Q7QUFHcEQsaURBQXNDO0FBS3RDLDJHQUFzRztBQUN0Ryw0RUFBaUY7QUFDakYsa0VBQTRIO0FBQzVILDhEQUF3RztBQU94Rzs7Ozs7R0FLRztBQUNILCtCQUFzQyxJQUEwQjtJQUM1RCxJQUFJLENBQUMsdUNBQStCLEVBQUU7UUFDbEMsMEJBQU0sQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztRQUMvQyx1Q0FBK0IsR0FBRyxJQUFJLHVDQUFrQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztLQUM1RTtJQUNELE9BQU8sSUFBSSxxQkFBcUIsbUJBQ3pCLGtEQUEyQixFQUMzQixJQUFJLEVBQ1QsQ0FBQztBQUNQLENBQUM7QUFURCxzREFTQztBQUVEO0lBRUksWUFBbUIsSUFBMEI7UUFBMUIsU0FBSSxHQUFKLElBQUksQ0FBc0I7UUFtRnRDLG1CQUFjLEdBQUcseUNBQXVCLENBQUMsMkJBQTJCLENBQUMsQ0FBQztJQWxGN0UsQ0FBQztJQUVZLGVBQWUsQ0FBQyxFQUFpQixFQUNqQixFQUErQixFQUMvQixLQUFrQzs7WUFDM0QsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUM5QyxPQUFPLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxjQUFj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SSxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFO2FBQ3hGLENBQUM7WUFDRix1Q0FBK0IsQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDN0MsRUFBRSxFQUFFLEVBQUUsQ0FBQyxvQkFBb0I7Z0JBQzNCLElBQUk7Z0JBQ0osWUFBWTtnQkFDWixVQUFVO2dCQUNWLGNBQWMsRUFBRSxtQ0FBYyxDQUFDLE9BQU87YUFDekMsQ0FBQyxDQUFDO1lBRUgsT0FBTyxDQUFDLE1BQU0sSUFBSSxPQUFPLENBQW9CLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO29CQUM3RCxZQUFZLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBTSxJQUFJLEVBQUMsRUFBRTt3QkFDakQsSUFBSSxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsRUFBRTs0QkFDbEcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO3lCQUN2QjtvQkFDTCxDQUFDLENBQUEsQ0FBQyxDQUFDO29CQUNILFlBQVksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRTt3QkFDbEMsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLDhFQUE4RSxDQUFDLENBQUMsQ0FBQztvQkFDdEcsQ0FBQyxDQUFDLENBQUM7b0JBQ0gsWUFBWSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7Z0JBQzlDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDUixDQUFDO0tBQUE7Q0FHSiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgwqkgMjAxOCBBdG9taXN0LCBJbmMuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudFwiO1xuaW1wb3J0IHsgUHJvamVjdE9wZXJhdGlvbkNyZWRlbnRpYWxzIH0gZnJvbSBcIkBhdG9taXN0L2F1dG9tYXRpb24tY2xpZW50L29wZXJhdGlvbnMvY29tbW9uL1Byb2plY3RPcGVyYXRpb25DcmVkZW50aWFsc1wiO1xuaW1wb3J0IHsgUmVtb3RlUmVwb1JlZiB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudC9vcGVyYXRpb25zL2NvbW1vbi9SZXBvSWRcIjtcbmltcG9ydCB7IHNwYXduIH0gZnJvbSBcImNoaWxkX3Byb2Nlc3NcIjtcbmltcG9ydCB7IERlcGxveWFibGVBcnRpZmFjdCB9IGZyb20gXCIuLi8uLi8uLi8uLi8uLi9zcGkvYXJ0aWZhY3QvQXJ0aWZhY3RTdG9yZVwiO1xuaW1wb3J0IHsgRGVwbG95ZXIgfSBmcm9tIFwiLi4vLi4vLi4vLi4vLi4vc3BpL2RlcGxveS9EZXBsb3llclwiO1xuaW1wb3J0IHsgRGVwbG95bWVudCB9IGZyb20gXCIuLi8uLi8uLi8uLi8uLi9zcGkvZGVwbG95L0RlcGxveW1lbnRcIjtcbmltcG9ydCB7IFByb2dyZXNzTG9nIH0gZnJvbSBcIi4uLy4uLy4uLy4uLy4uL3NwaS9sb2cvUHJvZ3Jlc3NMb2dcIjtcbmltcG9ydCB7RGVsaW1pdGVkV3JpdGVQcm9ncmVzc0xvZ0RlY29yYXRvcn0gZnJvbSBcIi4uLy4uLy4uLy4uL2xvZy9EZWxpbWl0ZWRXcml0ZVByb2dyZXNzTG9nRGVjb3JhdG9yXCI7XG5pbXBvcnQgeyBsYXN0TGluZXNMb2dJbnRlcnByZXRlciB9IGZyb20gXCIuLi8uLi8uLi9nb2Fscy9zdXBwb3J0L2xvZ0ludGVycHJldGVyc1wiO1xuaW1wb3J0IHsgRGVmYXVsdExvY2FsRGVwbG95ZXJPcHRpb25zLCBMb2NhbERlcGxveWVyT3B0aW9ucywgU3Bhd25lZERlcGxveW1lbnQsIFN0YXJ0dXBJbmZvIH0gZnJvbSBcIi4uL0xvY2FsRGVwbG95ZXJPcHRpb25zXCI7XG5pbXBvcnQgeyBMb29rdXBTdHJhdGVneSwgTWFuYWdlZERlcGxveW1lbnRzLCBNYW5hZ2VkRGVwbG95bWVudFRhcmdldEluZm8gfSBmcm9tIFwiLi4vTWFuYWdlZERlcGxveW1lbnRzXCI7XG5cbi8qKlxuICogTWFuYWdlZCBkZXBsb3ltZW50c1xuICovXG5leHBvcnQgbGV0IG1hbmFnZWRFeGVjdXRhYmxlSmFyRGVwbG95bWVudHM6IE1hbmFnZWREZXBsb3ltZW50cztcblxuLyoqXG4gKiBTdGFydCB1cCBhbiBleGVjdXRhYmxlIEphciBvbiB0aGUgc2FtZSBub2RlIGFzIHRoZSBhdXRvbWF0aW9uIGNsaWVudC5cbiAqIE5vdCBpbnRlbmRlZCBhcyBhIFBhYXMsIGJ1dCBmb3IgdXNlIGR1cmluZyBkZW1vcyBhbmQgZGV2ZWxvcG1lbnQuXG4gKiBBbHdheXMgdXNlcyB0aGUgc2FtZSBVUkwsIHdoYXRldmVyIHRoZSBicmFuY2ggYW5kIHNoYS5cbiAqIEBwYXJhbSBvcHRzIG9wdGlvbnNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGV4ZWN1dGFibGVKYXJEZXBsb3llcihvcHRzOiBMb2NhbERlcGxveWVyT3B0aW9ucyk6IERlcGxveWVyPE1hbmFnZWREZXBsb3ltZW50VGFyZ2V0SW5mbz4ge1xuICAgIGlmICghbWFuYWdlZEV4ZWN1dGFibGVKYXJEZXBsb3ltZW50cykge1xuICAgICAgICBsb2dnZXIuZGVidWcoXCJDcmVhdGVkIG5ldyBkZXBsb3ltZW50cyByZWNvcmRcIik7XG4gICAgICAgIG1hbmFnZWRFeGVjdXRhYmxlSmFyRGVwbG95bWVudHMgPSBuZXcgTWFuYWdlZERlcGxveW1lbnRzKG9wdHMubG93ZXJQb3J0KTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBFeGVjdXRhYmxlSmFyRGVwbG95ZXIoe1xuICAgICAgICAuLi5EZWZhdWx0TG9jYWxEZXBsb3llck9wdGlvbnMsXG4gICAgICAgIC4uLm9wdHMsXG4gICAgfSk7XG59XG5cbmNsYXNzIEV4ZWN1dGFibGVKYXJEZXBsb3llciBpbXBsZW1lbnRzIERlcGxveWVyPE1hbmFnZWREZXBsb3ltZW50VGFyZ2V0SW5mbywgRGVwbG95bWVudD4ge1xuXG4gICAgY29uc3RydWN0b3IocHVibGljIG9wdHM6IExvY2FsRGVwbG95ZXJPcHRpb25zKSB7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGZpbmREZXBsb3ltZW50cyhpZDogUmVtb3RlUmVwb1JlZixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpOiBNYW5hZ2VkRGVwbG95bWVudFRhcmdldEluZm8sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVkczogUHJvamVjdE9wZXJhdGlvbkNyZWRlbnRpYWxzKSB7XG4gICAgICAgIGNvbnN0IHRoaXNEZXBsb3ltZW50ID0gdGhpcy5kZXBsb3ltZW50Rm9yKHRpKTtcbiAgICAgICAgcmV0dXJuIHRoaXNEZXBsb3ltZW50ID8gW3RoaXNEZXBsb3ltZW50XSA6IFtdO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyB1bmRlcGxveShpZDogTWFuYWdlZERlcGxveW1lbnRUYXJnZXRJbmZvLCBkZXBsb3ltZW50OiBEZXBsb3ltZW50LCBsb2c6IFByb2dyZXNzTG9nKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIG1hbmFnZWRFeGVjdXRhYmxlSmFyRGVwbG95bWVudHMudGVybWluYXRlSWZSdW5uaW5nKGlkLm1hbmFnZWREZXBsb3ltZW50S2V5LCBMb29rdXBTdHJhdGVneS5zZXJ2aWNlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGRlcGxveW1lbnRGb3IodGk6IE1hbmFnZWREZXBsb3ltZW50VGFyZ2V0SW5mbyk6IERlcGxveW1lbnQge1xuICAgICAgICBjb25zdCBtYW5hZ2VkID0gbWFuYWdlZEV4ZWN1dGFibGVKYXJEZXBsb3ltZW50cy5maW5kRGVwbG95bWVudCh0aS5tYW5hZ2VkRGVwbG95bWVudEtleSwgTG9va3VwU3RyYXRlZ3kuc2VydmljZSk7XG4gICAgICAgIGlmICghbWFuYWdlZCkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBwb3J0ID0gbWFuYWdlZC5wb3J0O1xuICAgICAgICBjb25zdCBiYXNlVXJsID0gdGhpcy5vcHRzLmJhc2VVcmw7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBlbmRwb2ludDogYCR7YmFzZVVybH06JHtwb3J0fS8ke3RoaXMuY29udGV4dFJvb3QodGkubWFuYWdlZERlcGxveW1lbnRLZXkpfWAsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjb250ZXh0Um9vdChpZDogUmVtb3RlUmVwb1JlZikge1xuICAgICAgICByZXR1cm4gYC8ke2lkLm93bmVyfS8ke2lkLnJlcG99L3N0YWdpbmdgO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBkZXBsb3koZGE6IERlcGxveWFibGVBcnRpZmFjdCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpOiBNYW5hZ2VkRGVwbG95bWVudFRhcmdldEluZm8sXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2c6IFByb2dyZXNzTG9nLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3JlZGVudGlhbHM6IFByb2plY3RPcGVyYXRpb25DcmVkZW50aWFscyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGF0b21pc3RUZWFtOiBzdHJpbmcpOiBQcm9taXNlPFNwYXduZWREZXBsb3ltZW50W10+IHtcbiAgICAgICAgaWYgKCFkYS5maWxlbmFtZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTm8gZmlsZW5hbWUgaW4gZGVwbG95YWJsZSBhcnRpZmFjdCFcIik7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcG9ydCA9IGF3YWl0IG1hbmFnZWRFeGVjdXRhYmxlSmFyRGVwbG95bWVudHMuZmluZFBvcnQodGkubWFuYWdlZERlcGxveW1lbnRLZXksIExvb2t1cFN0cmF0ZWd5LnNlcnZpY2UsIHRoaXMub3B0cy5iYXNlVXJsKTtcbiAgICAgICAgbG9nZ2VyLmluZm8oXCJEZXBsb3lpbmcgYXBwIFslal0gb24gcG9ydCBbJWRdIGZvciB0ZWFtICVzXCIsIGRhLCBwb3J0LCBhdG9taXN0VGVhbSk7XG4gICAgICAgIGNvbnN0IHN0YXJ0dXBJbmZvOiBTdGFydHVwSW5mbyA9IHtcbiAgICAgICAgICAgIHBvcnQsXG4gICAgICAgICAgICBhdG9taXN0VGVhbSxcbiAgICAgICAgICAgIGNvbnRleHRSb290OiB0aGlzLmNvbnRleHRSb290KGRhLmlkKSxcbiAgICAgICAgfTtcbiAgICAgICAgYXdhaXQgbWFuYWdlZEV4ZWN1dGFibGVKYXJEZXBsb3ltZW50cy50ZXJtaW5hdGVJZlJ1bm5pbmcodGkubWFuYWdlZERlcGxveW1lbnRLZXksIExvb2t1cFN0cmF0ZWd5LnNlcnZpY2UpO1xuICAgICAgICBjb25zdCBjaGlsZFByb2Nlc3MgPSBzcGF3bihcImphdmFcIixcbiAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAgICBcIi1qYXJcIixcbiAgICAgICAgICAgICAgICBkYS5maWxlbmFtZSxcbiAgICAgICAgICAgIF0uY29uY2F0KHRoaXMub3B0cy5jb21tYW5kTGluZUFyZ3VtZW50c0ZvcihzdGFydHVwSW5mbykpLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGN3ZDogZGEuY3dkLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IG5ld0xpbmVEZWxpbWl0ZWRMb2cgPSBuZXcgRGVsaW1pdGVkV3JpdGVQcm9ncmVzc0xvZ0RlY29yYXRvcihsb2csIFwiXFxuXCIpO1xuICAgICAgICBjaGlsZFByb2Nlc3Muc3Rkb3V0Lm9uKFwiZGF0YVwiLCB3aGF0ID0+IG5ld0xpbmVEZWxpbWl0ZWRMb2cud3JpdGUod2hhdC50b1N0cmluZygpKSk7XG4gICAgICAgIGNoaWxkUHJvY2Vzcy5zdGRlcnIub24oXCJkYXRhXCIsIHdoYXQgPT4gbmV3TGluZURlbGltaXRlZExvZy53cml0ZSh3aGF0LnRvU3RyaW5nKCkpKTtcblxuICAgICAgICBjb25zdCBkZXBsb3ltZW50ID0ge1xuICAgICAgICAgICAgY2hpbGRQcm9jZXNzLFxuICAgICAgICAgICAgZW5kcG9pbnQ6IGAke3RoaXMub3B0cy5iYXNlVXJsfToke3BvcnR9LyR7dGhpcy5jb250ZXh0Um9vdCh0aS5tYW5hZ2VkRGVwbG95bWVudEtleSl9YCxcbiAgICAgICAgfTtcbiAgICAgICAgbWFuYWdlZEV4ZWN1dGFibGVKYXJEZXBsb3ltZW50cy5yZWNvcmREZXBsb3ltZW50KHtcbiAgICAgICAgICAgIGlkOiB0aS5tYW5hZ2VkRGVwbG95bWVudEtleSxcbiAgICAgICAgICAgIHBvcnQsXG4gICAgICAgICAgICBjaGlsZFByb2Nlc3MsXG4gICAgICAgICAgICBkZXBsb3ltZW50LFxuICAgICAgICAgICAgbG9va3VwU3RyYXRlZ3k6IExvb2t1cFN0cmF0ZWd5LnNlcnZpY2UsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBbYXdhaXQgbmV3IFByb21pc2U8U3Bhd25lZERlcGxveW1lbnQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNoaWxkUHJvY2Vzcy5zdGRvdXQuYWRkTGlzdGVuZXIoXCJkYXRhXCIsIGFzeW5jIHdoYXQgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghIXdoYXQgJiYgdGhpcy5vcHRzLnN1Y2Nlc3NQYXR0ZXJucy5zb21lKHN1Y2Nlc3NQYXR0ZXJuID0+IHN1Y2Nlc3NQYXR0ZXJuLnRlc3Qod2hhdC50b1N0cmluZygpKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkZXBsb3ltZW50KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNoaWxkUHJvY2Vzcy5hZGRMaXN0ZW5lcihcImV4aXRcIiwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoXCJFeGVjdXRhYmxlSmFyRGVwbG95ZXI6IFdlIHNob3VsZCBoYXZlIGZvdW5kIHN1Y2Nlc3MgbWVzc2FnZSBwYXR0ZXJuIGJ5IG5vdyEhXCIpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgY2hpbGRQcm9jZXNzLmFkZExpc3RlbmVyKFwiZXJyb3JcIiwgcmVqZWN0KTtcbiAgICAgICAgfSldO1xuICAgIH1cblxuICAgIHB1YmxpYyBsb2dJbnRlcnByZXRlciA9IGxhc3RMaW5lc0xvZ0ludGVycHJldGVyKFwiRXhlY3V0YWJsZSBqYXIgZGVwbG95bWVudFwiKTtcbn1cbiJdfQ==