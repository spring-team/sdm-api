"use strict";/*
 * Copyright Â© 2018 Atomist, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var cov_1c2y7ttw4o=function(){var path="/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/delivery/build/local/SpawnBuilder.ts",hash="fc958988fa3f923bef5b3e3a7273739f0ca4c2f9",Function=function(){}.constructor,global=new Function('return this')(),gcv="__coverage__",coverageData={path:"/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/delivery/build/local/SpawnBuilder.ts",statementMap:{"0":{start:{line:17,column:16},end:{line:24,column:1}},"1":{start:{line:18,column:4},end:{line:23,column:7}},"2":{start:{line:19,column:36},end:{line:19,column:97}},"3":{start:{line:19,column:42},end:{line:19,column:70}},"4":{start:{line:19,column:85},end:{line:19,column:95}},"5":{start:{line:20,column:35},end:{line:20,column:100}},"6":{start:{line:20,column:41},end:{line:20,column:73}},"7":{start:{line:20,column:88},end:{line:20,column:98}},"8":{start:{line:21,column:32},end:{line:21,column:149}},"9":{start:{line:21,column:97},end:{line:21,column:119}},"10":{start:{line:22,column:8},end:{line:22,column:78}},"11":{start:{line:25,column:0},end:{line:25,column:62}},"12":{start:{line:26,column:28},end:{line:26,column:65}},"13":{start:{line:27,column:21},end:{line:27,column:42}},"14":{start:{line:28,column:18},end:{line:28,column:58}},"15":{start:{line:29,column:23},end:{line:29,column:48}},"16":{start:{line:39,column:8},end:{line:39,column:79}},"17":{start:{line:40,column:8},end:{line:40,column:38}},"18":{start:{line:41,column:8},end:{line:43,column:9}},"19":{start:{line:42,column:12},end:{line:42,column:112}},"20":{start:{line:46,column:8},end:{line:46,column:43}},"21":{start:{line:49,column:8},end:{line:88,column:11}},"22":{start:{line:50,column:32},end:{line:50,column:56}},"23":{start:{line:51,column:12},end:{line:51,column:168}},"24":{start:{line:52,column:12},end:{line:87,column:16}},"25":{start:{line:52,column:96},end:{line:87,column:14}},"26":{start:{line:53,column:33},end:{line:53,column:115}},"27":{start:{line:54,column:30},end:{line:54,column:68}},"28":{start:{line:55,column:29},end:{line:55,column:92}},"29":{start:{line:57,column:20},end:{line:68,column:23}},"30":{start:{line:62,column:24},end:{line:66,column:25}},"31":{start:{line:63,column:44},end:{line:63,column:134}},"32":{start:{line:64,column:28},end:{line:64,column:47}},"33":{start:{line:65,column:28},end:{line:65,column:75}},"34":{start:{line:67,column:24},end:{line:67,column:34}},"35":{start:{line:70,column:34},end:{line:70,column:57}},"36":{start:{line:71,column:16},end:{line:80,column:17}},"37":{start:{line:72,column:20},end:{line:79,column:23}},"38":{start:{line:74,column:24},end:{line:76,column:25}},"39":{start:{line:75,column:28},end:{line:75,column:74}},"40":{start:{line:77,column:24},end:{line:77,column:132}},"41":{start:{line:78,column:24},end:{line:78,column:56}},"42":{start:{line:81,column:16},end:{line:84,column:19}},"43":{start:{line:82,column:20},end:{line:82,column:76}},"44":{start:{line:83,column:20},end:{line:83,column:30}},"45":{start:{line:85,column:26},end:{line:85,column:176}},"46":{start:{line:86,column:16},end:{line:86,column:25}},"47":{start:{line:91,column:0},end:{line:91,column:36}},"48":{start:{line:93,column:4},end:{line:105,column:7}},"49":{start:{line:94,column:26},end:{line:94,column:47}},"50":{start:{line:95,column:8},end:{line:97,column:9}},"51":{start:{line:96,column:12},end:{line:96,column:29}},"52":{start:{line:98,column:24},end:{line:98,column:52}},"53":{start:{line:99,column:25},end:{line:102,column:54}},"54":{start:{line:100,column:25},end:{line:100,column:28}},"55":{start:{line:101,column:25},end:{line:101,column:43}},"56":{start:{line:102,column:22},end:{line:102,column:53}},"57":{start:{line:103,column:8},end:{line:103,column:115}},"58":{start:{line:104,column:8},end:{line:104,column:24}},"59":{start:{line:109,column:8},end:{line:109,column:31}},"60":{start:{line:110,column:8},end:{line:110,column:31}},"61":{start:{line:111,column:8},end:{line:111,column:39}},"62":{start:{line:112,column:8},end:{line:112,column:25}},"63":{start:{line:113,column:8},end:{line:113,column:23}},"64":{start:{line:114,column:8},end:{line:114,column:53}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:17,column:44},end:{line:17,column:45}},loc:{start:{line:17,column:89},end:{line:24,column:1}},line:17},"1":{name:"(anonymous_1)",decl:{start:{line:18,column:36},end:{line:18,column:37}},loc:{start:{line:18,column:63},end:{line:23,column:5}},line:18},"2":{name:"fulfilled",decl:{start:{line:19,column:17},end:{line:19,column:26}},loc:{start:{line:19,column:34},end:{line:19,column:99}},line:19},"3":{name:"rejected",decl:{start:{line:20,column:17},end:{line:20,column:25}},loc:{start:{line:20,column:33},end:{line:20,column:102}},line:20},"4":{name:"step",decl:{start:{line:21,column:17},end:{line:21,column:21}},loc:{start:{line:21,column:30},end:{line:21,column:151}},line:21},"5":{name:"(anonymous_5)",decl:{start:{line:21,column:76},end:{line:21,column:77}},loc:{start:{line:21,column:95},end:{line:21,column:121}},line:21},"6":{name:"(anonymous_6)",decl:{start:{line:38,column:4},end:{line:38,column:5}},loc:{start:{line:38,column:24},end:{line:44,column:5}},line:38},"7":{name:"(anonymous_7)",decl:{start:{line:45,column:4},end:{line:45,column:5}},loc:{start:{line:45,column:25},end:{line:47,column:5}},line:45},"8":{name:"(anonymous_8)",decl:{start:{line:48,column:4},end:{line:48,column:5}},loc:{start:{line:48,column:43},end:{line:89,column:5}},line:48},"9":{name:"(anonymous_9)",decl:{start:{line:49,column:47},end:{line:49,column:48}},loc:{start:{line:49,column:60},end:{line:88,column:9}},line:49},"10":{name:"(anonymous_10)",decl:{start:{line:52,column:89},end:{line:52,column:90}},loc:{start:{line:52,column:96},end:{line:87,column:14}},line:52},"11":{name:"(anonymous_11)",decl:{start:{line:52,column:128},end:{line:52,column:129}},loc:{start:{line:52,column:141},end:{line:87,column:13}},line:52},"12":{name:"executeOne",decl:{start:{line:56,column:25},end:{line:56,column:35}},loc:{start:{line:56,column:50},end:{line:69,column:17}},line:56},"13":{name:"(anonymous_13)",decl:{start:{line:61,column:30},end:{line:61,column:31}},loc:{start:{line:61,column:36},end:{line:68,column:21}},line:61},"14":{name:"(anonymous_14)",decl:{start:{line:73,column:30},end:{line:73,column:31}},loc:{start:{line:73,column:36},end:{line:79,column:21}},line:73},"15":{name:"(anonymous_15)",decl:{start:{line:81,column:47},end:{line:81,column:48}},loc:{start:{line:81,column:53},end:{line:84,column:17}},line:81},"16":{name:"loadCommandsFromFile",decl:{start:{line:92,column:9},end:{line:92,column:29}},loc:{start:{line:92,column:39},end:{line:106,column:1}},line:92},"17":{name:"(anonymous_17)",decl:{start:{line:93,column:43},end:{line:93,column:44}},loc:{start:{line:93,column:56},end:{line:105,column:5}},line:93},"18":{name:"(anonymous_18)",decl:{start:{line:100,column:20},end:{line:100,column:21}},loc:{start:{line:100,column:25},end:{line:100,column:28}},line:100},"19":{name:"(anonymous_19)",decl:{start:{line:101,column:20},end:{line:101,column:21}},loc:{start:{line:101,column:25},end:{line:101,column:43}},line:101},"20":{name:"(anonymous_20)",decl:{start:{line:102,column:17},end:{line:102,column:18}},loc:{start:{line:102,column:22},end:{line:102,column:53}},line:102},"21":{name:"(anonymous_21)",decl:{start:{line:108,column:4},end:{line:108,column:5}},loc:{start:{line:108,column:78},end:{line:115,column:5}},line:108}},branchMap:{"0":{loc:{start:{line:17,column:16},end:{line:24,column:1}},type:"binary-expr",locations:[{start:{line:17,column:17},end:{line:17,column:21}},{start:{line:17,column:25},end:{line:17,column:39}},{start:{line:17,column:44},end:{line:24,column:1}}],line:17},"1":{loc:{start:{line:18,column:16},end:{line:18,column:34}},type:"binary-expr",locations:[{start:{line:18,column:16},end:{line:18,column:17}},{start:{line:18,column:22},end:{line:18,column:33}}],line:18},"2":{loc:{start:{line:21,column:32},end:{line:21,column:148}},type:"cond-expr",locations:[{start:{line:21,column:46},end:{line:21,column:67}},{start:{line:21,column:70},end:{line:21,column:148}}],line:21},"3":{loc:{start:{line:22,column:51},end:{line:22,column:67}},type:"binary-expr",locations:[{start:{line:22,column:51},end:{line:22,column:61}},{start:{line:22,column:65},end:{line:22,column:67}}],line:22},"4":{loc:{start:{line:41,column:8},end:{line:43,column:9}},type:"if",locations:[{start:{line:41,column:8},end:{line:43,column:9}},{start:{line:41,column:8},end:{line:43,column:9}}],line:41},"5":{loc:{start:{line:41,column:12},end:{line:41,column:63}},type:"binary-expr",locations:[{start:{line:41,column:12},end:{line:41,column:34}},{start:{line:41,column:38},end:{line:41,column:63}}],line:41},"6":{loc:{start:{line:53,column:33},end:{line:53,column:115}},type:"binary-expr",locations:[{start:{line:53,column:33},end:{line:53,column:54}},{start:{line:53,column:59},end:{line:53,column:114}}],line:53},"7":{loc:{start:{line:55,column:64},end:{line:55,column:90}},type:"binary-expr",locations:[{start:{line:55,column:64},end:{line:55,column:84}},{start:{line:55,column:88},end:{line:55,column:90}}],line:55},"8":{loc:{start:{line:62,column:24},end:{line:66,column:25}},type:"if",locations:[{start:{line:62,column:24},end:{line:66,column:25}},{start:{line:62,column:24},end:{line:66,column:25}}],line:62},"9":{loc:{start:{line:74,column:24},end:{line:76,column:25}},type:"if",locations:[{start:{line:74,column:24},end:{line:76,column:25}},{start:{line:74,column:24},end:{line:76,column:25}}],line:74},"10":{loc:{start:{line:85,column:82},end:{line:85,column:175}},type:"cond-expr",locations:[{start:{line:85,column:117},end:{line:85,column:163}},{start:{line:85,column:166},end:{line:85,column:175}}],line:85},"11":{loc:{start:{line:95,column:8},end:{line:97,column:9}},type:"if",locations:[{start:{line:95,column:8},end:{line:97,column:9}},{start:{line:95,column:8},end:{line:97,column:9}}],line:95}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0,"49":0,"50":0,"51":0,"52":0,"53":0,"54":0,"55":0,"56":0,"57":0,"58":0,"59":0,"60":0,"61":0,"62":0,"63":0,"64":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0},b:{"0":[0,0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0,0],"8":[0,0],"9":[0,0],"10":[0,0],"11":[0,0]},_coverageSchema:"332fd63041d2c1bcb487cc26dd0d5f7d97098a6c"},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var __awaiter=(cov_1c2y7ttw4o.s[0]++,(cov_1c2y7ttw4o.b[0][0]++,this)&&(cov_1c2y7ttw4o.b[0][1]++,this.__awaiter)||(cov_1c2y7ttw4o.b[0][2]++,function(thisArg,_arguments,P,generator){cov_1c2y7ttw4o.f[0]++;cov_1c2y7ttw4o.s[1]++;return new((cov_1c2y7ttw4o.b[1][0]++,P)||(cov_1c2y7ttw4o.b[1][1]++,P=Promise))(function(resolve,reject){cov_1c2y7ttw4o.f[1]++;function fulfilled(value){cov_1c2y7ttw4o.f[2]++;cov_1c2y7ttw4o.s[2]++;try{cov_1c2y7ttw4o.s[3]++;step(generator.next(value));}catch(e){cov_1c2y7ttw4o.s[4]++;reject(e);}}function rejected(value){cov_1c2y7ttw4o.f[3]++;cov_1c2y7ttw4o.s[5]++;try{cov_1c2y7ttw4o.s[6]++;step(generator["throw"](value));}catch(e){cov_1c2y7ttw4o.s[7]++;reject(e);}}function step(result){cov_1c2y7ttw4o.f[4]++;cov_1c2y7ttw4o.s[8]++;result.done?(cov_1c2y7ttw4o.b[2][0]++,resolve(result.value)):(cov_1c2y7ttw4o.b[2][1]++,new P(function(resolve){cov_1c2y7ttw4o.f[5]++;cov_1c2y7ttw4o.s[9]++;resolve(result.value);}).then(fulfilled,rejected));}cov_1c2y7ttw4o.s[10]++;step((generator=generator.apply(thisArg,(cov_1c2y7ttw4o.b[3][0]++,_arguments)||(cov_1c2y7ttw4o.b[3][1]++,[]))).next());});}));cov_1c2y7ttw4o.s[11]++;Object.defineProperty(exports,"__esModule",{value:true});const automation_client_1=(cov_1c2y7ttw4o.s[12]++,require("@atomist/automation-client"));const sprintf_js_1=(cov_1c2y7ttw4o.s[13]++,require("sprintf-js"));const spawned_1=(cov_1c2y7ttw4o.s[14]++,require("../../../../util/misc/spawned"));const LocalBuilder_1=(cov_1c2y7ttw4o.s[15]++,require("./LocalBuilder"));/**
 * Build using spawn on the automation client node.
 * Note it is NOT intended for use for multiple organizations. It's OK
 * for one organization to use inside its firewall, but there is potential
 * vulnerability in builds of unrelated tenants getting at each others
 * artifacts.
 */class SpawnBuilder extends(LocalBuilder_1.LocalBuilder){constructor(params){cov_1c2y7ttw4o.f[6]++;cov_1c2y7ttw4o.s[16]++;super(params.options.name,params.artifactStore,params.projectLoader);cov_1c2y7ttw4o.s[17]++;this.options=params.options;cov_1c2y7ttw4o.s[18]++;if((cov_1c2y7ttw4o.b[5][0]++,!this.options.commands)&&(cov_1c2y7ttw4o.b[5][1]++,!this.options.commandFile)){cov_1c2y7ttw4o.b[4][0]++;cov_1c2y7ttw4o.s[19]++;throw new Error("Please supply either commands or a path to a file in the project containing them");}else{cov_1c2y7ttw4o.b[4][1]++;}}get logInterpreter(){cov_1c2y7ttw4o.f[7]++;cov_1c2y7ttw4o.s[20]++;return this.options.logInterpreter;}startBuild(credentials,id,team,log){cov_1c2y7ttw4o.f[8]++;cov_1c2y7ttw4o.s[21]++;return __awaiter(this,void 0,void 0,function*(){cov_1c2y7ttw4o.f[9]++;const errorFinder=(cov_1c2y7ttw4o.s[22]++,this.options.errorFinder);cov_1c2y7ttw4o.s[23]++;automation_client_1.logger.info("%s.startBuild on %s, buildCommands=[%j] or file=[%s]",this.name,id.url,this.options.commands,this.options.commandFile);cov_1c2y7ttw4o.s[24]++;return this.projectLoader.doWithProject({credentials,id,readOnly:true},p=>{cov_1c2y7ttw4o.f[10]++;cov_1c2y7ttw4o.s[25]++;return __awaiter(this,void 0,void 0,function*(){cov_1c2y7ttw4o.f[11]++;const commands=(cov_1c2y7ttw4o.s[26]++,(cov_1c2y7ttw4o.b[6][0]++,this.options.commands)||(cov_1c2y7ttw4o.b[6][1]++,yield loadCommandsFromFile(p,this.options.commandFile)));const appId=(cov_1c2y7ttw4o.s[27]++,yield this.options.projectToAppInfo(p));const opts=(cov_1c2y7ttw4o.s[28]++,Object.assign({cwd:p.baseDir},(cov_1c2y7ttw4o.b[7][0]++,this.options.options)||(cov_1c2y7ttw4o.b[7][1]++,{})));function executeOne(buildCommand){cov_1c2y7ttw4o.f[12]++;cov_1c2y7ttw4o.s[29]++;return spawned_1.spawnAndWatch(buildCommand,Object.assign({},opts,buildCommand.options),log,{errorFinder,stripAnsi:true}).then(br=>{cov_1c2y7ttw4o.f[13]++;cov_1c2y7ttw4o.s[30]++;if(br.error){cov_1c2y7ttw4o.b[8][0]++;const message=(cov_1c2y7ttw4o.s[31]++,"Stopping build commands due to error on "+spawned_1.stringifySpawnCommand(buildCommand));cov_1c2y7ttw4o.s[32]++;log.write(message);cov_1c2y7ttw4o.s[33]++;return{error:true,code:br.code,message};}else{cov_1c2y7ttw4o.b[8][1]++;}cov_1c2y7ttw4o.s[34]++;return br;});}let buildResult=(cov_1c2y7ttw4o.s[35]++,executeOne(commands[0]));cov_1c2y7ttw4o.s[36]++;for(const buildCommand of commands.slice(1)){cov_1c2y7ttw4o.s[37]++;buildResult=buildResult.then(br=>{cov_1c2y7ttw4o.f[14]++;cov_1c2y7ttw4o.s[38]++;if(br.error){cov_1c2y7ttw4o.b[9][0]++;cov_1c2y7ttw4o.s[39]++;throw new Error("Build failure: "+br.error);}else{cov_1c2y7ttw4o.b[9][1]++;}cov_1c2y7ttw4o.s[40]++;log.write(sprintf_js_1.sprintf("Next after %j is...%s",br,spawned_1.stringifySpawnCommand(buildCommand)));cov_1c2y7ttw4o.s[41]++;return executeOne(buildCommand);});}cov_1c2y7ttw4o.s[42]++;buildResult=buildResult.then(br=>{cov_1c2y7ttw4o.f[15]++;cov_1c2y7ttw4o.s[43]++;automation_client_1.logger.info("Build RETURN: %j",br);cov_1c2y7ttw4o.s[44]++;return br;});const b=(cov_1c2y7ttw4o.s[45]++,new SpawnedBuild(appId,id,buildResult,team,log.url,!!this.options.deploymentUnitFor?(cov_1c2y7ttw4o.b[10][0]++,yield this.options.deploymentUnitFor(p,appId)):(cov_1c2y7ttw4o.b[10][1]++,undefined)));cov_1c2y7ttw4o.s[46]++;return b;});});});}}cov_1c2y7ttw4o.s[47]++;exports.SpawnBuilder=SpawnBuilder;function loadCommandsFromFile(p,path){cov_1c2y7ttw4o.f[16]++;cov_1c2y7ttw4o.s[48]++;return __awaiter(this,void 0,void 0,function*(){cov_1c2y7ttw4o.f[17]++;const buildFile=(cov_1c2y7ttw4o.s[49]++,yield p.getFile(path));cov_1c2y7ttw4o.s[50]++;if(!buildFile){cov_1c2y7ttw4o.b[11][0]++;cov_1c2y7ttw4o.s[51]++;return undefined;}else{cov_1c2y7ttw4o.b[11][1]++;}const content=(cov_1c2y7ttw4o.s[52]++,yield buildFile.getContent());const commands=(cov_1c2y7ttw4o.s[53]++,content.split("\n").filter(l=>{cov_1c2y7ttw4o.f[18]++;cov_1c2y7ttw4o.s[54]++;return!!l;}).filter(l=>{cov_1c2y7ttw4o.f[19]++;cov_1c2y7ttw4o.s[55]++;return!l.startsWith("#");}).map(l=>{cov_1c2y7ttw4o.f[20]++;cov_1c2y7ttw4o.s[56]++;return spawned_1.asSpawnCommand(l,{});}));cov_1c2y7ttw4o.s[57]++;automation_client_1.logger.info("Found Atomist build file in project %j: Commands are %j",p.id,commands);cov_1c2y7ttw4o.s[58]++;return commands;});}class SpawnedBuild{constructor(appInfo,repoRef,buildResult,team,url,deploymentUnitFile){cov_1c2y7ttw4o.f[21]++;cov_1c2y7ttw4o.s[59]++;this.appInfo=appInfo;cov_1c2y7ttw4o.s[60]++;this.repoRef=repoRef;cov_1c2y7ttw4o.s[61]++;this.buildResult=buildResult;cov_1c2y7ttw4o.s[62]++;this.team=team;cov_1c2y7ttw4o.s[63]++;this.url=url;cov_1c2y7ttw4o.s[64]++;this.deploymentUnitFile=deploymentUnitFile;}}//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL2NvbW1vbi9kZWxpdmVyeS9idWlsZC9sb2NhbC9TcGF3bkJ1aWxkZXIudHMiLCJzb3VyY2VzIjpbIi9Vc2Vycy9yb2Rqb2huc29uL3Nmb3J6YW5kby1kZXYvaWRlYS1wcm9qZWN0cy9teS1mbG93L3NyYy9jb21tb24vZGVsaXZlcnkvYnVpbGQvbG9jYWwvU3Bhd25CdWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7Ozs7R0FjRzs7Ozs7Ozs7OztBQUVILGtFQUFvRDtBQU1wRCwyQ0FBcUM7QUFLckMsMkRBT3VDO0FBRXZDLGlEQUFvRTtBQWtEcEU7Ozs7OztHQU1HO0FBQ0gsa0JBQTBCLFNBQVEsMkJBQVk7SUFJMUMsWUFBWSxNQUlYO1FBQ0csS0FBSyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxhQUFhLEVBQUUsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3ZFLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQztRQUM5QixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRTtZQUNyRCxNQUFNLElBQUksS0FBSyxDQUFDLGtGQUFrRixDQUFDLENBQUM7U0FDdkc7SUFDTCxDQUFDO0lBRUQsSUFBVyxjQUFjO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUM7SUFDdkMsQ0FBQztJQUVlLFVBQVUsQ0FBQyxXQUF3QyxFQUN4QyxFQUFpQixFQUNqQixJQUFZLEVBQ1osR0FBZ0I7O1lBQ3ZDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDO1lBQzdDLDBCQUFNLENBQUMsSUFBSSxDQUFDLHNEQUFzRCxFQUFFLElBQUksQ0FB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LypcbiAqIENvcHlyaWdodCDCqSAyMDE4IEF0b21pc3QsIEluYy5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIkBhdG9taXN0L2F1dG9tYXRpb24tY2xpZW50XCI7XG5pbXBvcnQgeyBQcm9qZWN0T3BlcmF0aW9uQ3JlZGVudGlhbHMgfSBmcm9tIFwiQGF0b21pc3QvYXV0b21hdGlvbi1jbGllbnQvb3BlcmF0aW9ucy9jb21tb24vUHJvamVjdE9wZXJhdGlvbkNyZWRlbnRpYWxzXCI7XG5pbXBvcnQgeyBSZW1vdGVSZXBvUmVmIH0gZnJvbSBcIkBhdG9taXN0L2F1dG9tYXRpb24tY2xpZW50L29wZXJhdGlvbnMvY29tbW9uL1JlcG9JZFwiO1xuaW1wb3J0IHsgR2l0UHJvamVjdCB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudC9wcm9qZWN0L2dpdC9HaXRQcm9qZWN0XCI7XG5pbXBvcnQgeyBQcm9qZWN0IH0gZnJvbSBcIkBhdG9taXN0L2F1dG9tYXRpb24tY2xpZW50L3Byb2plY3QvUHJvamVjdFwiO1xuaW1wb3J0IHsgU3Bhd25PcHRpb25zIH0gZnJvbSBcImNoaWxkX3Byb2Nlc3NcIjtcbmltcG9ydCB7IHNwcmludGYgfSBmcm9tIFwic3ByaW50Zi1qc1wiO1xuaW1wb3J0IHsgQXJ0aWZhY3RTdG9yZSB9IGZyb20gXCIuLi8uLi8uLi8uLi9zcGkvYXJ0aWZhY3QvQXJ0aWZhY3RTdG9yZVwiO1xuaW1wb3J0IHsgQXBwSW5mbyB9IGZyb20gXCIuLi8uLi8uLi8uLi9zcGkvZGVwbG95L0RlcGxveW1lbnRcIjtcbmltcG9ydCB7IEludGVycHJldExvZywgTG9nSW50ZXJwcmV0YXRpb24gfSBmcm9tIFwiLi4vLi4vLi4vLi4vc3BpL2xvZy9JbnRlcnByZXRlZExvZ1wiO1xuaW1wb3J0IHsgUHJvZ3Jlc3NMb2cgfSBmcm9tIFwiLi4vLi4vLi4vLi4vc3BpL2xvZy9Qcm9ncmVzc0xvZ1wiO1xuaW1wb3J0IHtcbiAgICBhc1NwYXduQ29tbWFuZCxcbiAgICBDaGlsZFByb2Nlc3NSZXN1bHQsXG4gICAgRXJyb3JGaW5kZXIsXG4gICAgc3Bhd25BbmRXYXRjaCxcbiAgICBTcGF3bkNvbW1hbmQsXG4gICAgc3RyaW5naWZ5U3Bhd25Db21tYW5kLFxufSBmcm9tIFwiLi4vLi4vLi4vLi4vdXRpbC9taXNjL3NwYXduZWRcIjtcbmltcG9ydCB7IFByb2plY3RMb2FkZXIgfSBmcm9tIFwiLi4vLi4vLi4vcmVwby9Qcm9qZWN0TG9hZGVyXCI7XG5pbXBvcnQgeyBMb2NhbEJ1aWxkZXIsIExvY2FsQnVpbGRJblByb2dyZXNzIH0gZnJvbSBcIi4vTG9jYWxCdWlsZGVyXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3Bhd25CdWlsZGVyT3B0aW9ucyB7XG5cbiAgICBuYW1lOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBDb21tYW5kcyB3ZSdsbCBleGVjdXRlIHZpYSBOb2RlIHNwYXduLlxuICAgICAqIENvbW1hbmQgZXhlY3V0aW9uIHdpbGwgdGVybWluYXRlIG9uIHRoZSBmaXJzdCBlcnJvci5cbiAgICAgKi9cbiAgICBjb21tYW5kcz86IFNwYXduQ29tbWFuZFtdO1xuXG4gICAgLyoqXG4gICAgICogQWx0ZXJuYXRpdmUgdG8gY29tbWFuZHMuIEZpbGUgY29udGFpbmluZyBhIGxpc3Qgb2ZcbiAgICAgKiBuZXdsaW5lLXNlcGFyYXRlZCBjb21tYW5kcy4gTWF5IGNvbnRhaW4gYmxhbmsgbGluZXNcbiAgICAgKiBvciBjb21tZW50cyBiZWdpbm5pbmcgd2l0aCAjLlxuICAgICAqL1xuICAgIGNvbW1hbmRGaWxlPzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogRXJyb3IgZmluZGVyOiBOZWNlc3Nhcnkgb25seSBpZiBhIHNwYXduZWQgcHJvY2Vzc1xuICAgICAqIGNhbiByZXR1cm4gbm9uLXplcm8gb24gc3VjY2Vzcy5cbiAgICAgKi9cbiAgICBlcnJvckZpbmRlcj86IEVycm9yRmluZGVyO1xuXG4gICAgLyoqXG4gICAgICogSW50ZXJwcmV0ZXIgb2YgY29tbWFuZCBvdXRwdXRcbiAgICAgKi9cbiAgICBsb2dJbnRlcnByZXRlcjogSW50ZXJwcmV0TG9nO1xuXG4gICAgb3B0aW9ucz86IFNwYXduT3B0aW9ucztcblxuICAgIC8qKlxuICAgICAqIEZpbmQgYXJ0aWZhY3QgaW5mbyBmcm9tIHRoZSBzb3VyY2VzIG9mIHRoaXMgcHJvamVjdCxcbiAgICAgKiBmb3IgZXhhbXBsZSBieSBwYXJzaW5nIGEgcGFja2FnZS5qc29uIG9yIE1hdmVuIFBPTSBmaWxlLlxuICAgICAqIEBwYXJhbSB7UHJvamVjdH0gcFxuICAgICAqIEByZXR1cm4ge1Byb21pc2U8QXBwSW5mbz59XG4gICAgICovXG4gICAgcHJvamVjdFRvQXBwSW5mbyhwOiBQcm9qZWN0KTogUHJvbWlzZTxBcHBJbmZvPjtcblxuICAgIC8qKlxuICAgICAqIEZpbmQgdGhlIGRlcGxveW1lbnRVbml0IGFmdGVyIGEgc3VjY2Vzc2Z1bCBidWlsZFxuICAgICAqIEBwYXJhbSB7UHJvamVjdH0gcFxuICAgICAqIEBwYXJhbSB7QXBwSW5mb30gYXBwSWRcbiAgICAgKiBAcmV0dXJuIHtQcm9taXNlPHN0cmluZz59XG4gICAgICovXG4gICAgZGVwbG95bWVudFVuaXRGb3I/KHA6IEdpdFByb2plY3QsIGFwcElkOiBBcHBJbmZvKTogUHJvbWlzZTxzdHJpbmc+O1xuXG59XG5cbi8qKlxuICogQnVpbGQgdXNpbmcgc3Bhd24gb24gdGhlIGF1dG9tYXRpb24gY2xpZW50IG5vZGUuXG4gKiBOb3RlIGl0IGlzIE5PVCBpbnRlbmRlZCBmb3IgdXNlIGZvciBtdWx0aXBsZSBvcmdhbml6YXRpb25zLiBJdCdzIE9LXG4gKiBmb3Igb25lIG9yZ2FuaXphdGlvbiB0byB1c2UgaW5zaWRlIGl0cyBmaXJld2FsbCwgYnV0IHRoZXJlIGlzIHBvdGVudGlhbFxuICogdnVsbmVyYWJpbGl0eSBpbiBidWlsZHMgb2YgdW5yZWxhdGVkIHRlbmFudHMgZ2V0dGluZyBhdCBlYWNoIG90aGVyc1xuICogYXJ0aWZhY3RzLlxuICovXG5leHBvcnQgY2xhc3MgU3Bhd25CdWlsZGVyIGV4dGVuZHMgTG9jYWxCdWlsZGVyIGltcGxlbWVudHMgTG9nSW50ZXJwcmV0YXRpb24ge1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBvcHRpb25zOiBTcGF3bkJ1aWxkZXJPcHRpb25zO1xuXG4gICAgY29uc3RydWN0b3IocGFyYW1zOiB7XG4gICAgICAgIGFydGlmYWN0U3RvcmU/OiBBcnRpZmFjdFN0b3JlLFxuICAgICAgICBwcm9qZWN0TG9hZGVyOiBQcm9qZWN0TG9hZGVyLFxuICAgICAgICBvcHRpb25zOiBTcGF3bkJ1aWxkZXJPcHRpb25zLFxuICAgIH0pIHtcbiAgICAgICAgc3VwZXIocGFyYW1zLm9wdGlvbnMubmFtZSwgcGFyYW1zLmFydGlmYWN0U3RvcmUsIHBhcmFtcy5wcm9qZWN0TG9hZGVyKTtcbiAgICAgICAgdGhpcy5vcHRpb25zID0gcGFyYW1zLm9wdGlvbnM7XG4gICAgICAgIGlmICghdGhpcy5vcHRpb25zLmNvbW1hbmRzICYmICF0aGlzLm9wdGlvbnMuY29tbWFuZEZpbGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlBsZWFzZSBzdXBwbHkgZWl0aGVyIGNvbW1hbmRzIG9yIGEgcGF0aCB0byBhIGZpbGUgaW4gdGhlIHByb2plY3QgY29udGFpbmluZyB0aGVtXCIpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBsb2dJbnRlcnByZXRlcigpOiBJbnRlcnByZXRMb2cge1xuICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zLmxvZ0ludGVycHJldGVyO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBzdGFydEJ1aWxkKGNyZWRlbnRpYWxzOiBQcm9qZWN0T3BlcmF0aW9uQ3JlZGVudGlhbHMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IFJlbW90ZVJlcG9SZWYsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVhbTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZzogUHJvZ3Jlc3NMb2cpOiBQcm9taXNlPExvY2FsQnVpbGRJblByb2dyZXNzPiB7XG4gICAgICAgIGNvbnN0IGVycm9yRmluZGVyID0gdGhpcy5vcHRpb25zLmVycm9yRmluZGVyO1xuICAgICAgICBsb2dnZXIuaW5mbyhcIiVzLnN0YXJ0QnVpbGQgb24gJXMsIGJ1aWxkQ29tbWFuZHM9WyVqXSBvciBmaWxlPVslc11cIiwgdGhpcy5uYW1lLCBpZC51cmwsIHRoaXMub3B0aW9ucy5jb21tYW5kcyxcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5jb21tYW5kRmlsZSk7XG4gICAgICAgIHJldHVybiB0aGlzLnByb2plY3RMb2FkZXIuZG9XaXRoUHJvamVjdCh7Y3JlZGVudGlhbHMsIGlkLCByZWFkT25seTogdHJ1ZX0sIGFzeW5jIHAgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBjb21tYW5kczogU3Bhd25Db21tYW5kW10gPSB0aGlzLm9wdGlvbnMuY29tbWFuZHMgfHwgYXdhaXQgbG9hZENvbW1hbmRzRnJvbUZpbGUocCwgdGhpcy5vcHRpb25zLmNvbW1hbmRGaWxlKTtcblxuICAgICAgICAgICAgY29uc3QgYXBwSWQ6IEFwcEluZm8gPSBhd2FpdCB0aGlzLm9wdGlvbnMucHJvamVjdFRvQXBwSW5mbyhwKTtcbiAgICAgICAgICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICAgICAgICAgICAgY3dkOiBwLmJhc2VEaXIsXG4gICAgICAgICAgICAgICAgLi4uKHRoaXMub3B0aW9ucy5vcHRpb25zIHx8IHt9KSxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGZ1bmN0aW9uIGV4ZWN1dGVPbmUoYnVpbGRDb21tYW5kOiBTcGF3bkNvbW1hbmQpOiBQcm9taXNlPENoaWxkUHJvY2Vzc1Jlc3VsdD4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBzcGF3bkFuZFdhdGNoKGJ1aWxkQ29tbWFuZCxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgLi4ub3B0cyxcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLmJ1aWxkQ29tbWFuZC5vcHRpb25zLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBsb2csXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yRmluZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RyaXBBbnNpOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAudGhlbihiciA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnIuZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gXCJTdG9wcGluZyBidWlsZCBjb21tYW5kcyBkdWUgdG8gZXJyb3Igb24gXCIgKyBzdHJpbmdpZnlTcGF3bkNvbW1hbmQoYnVpbGRDb21tYW5kKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cud3JpdGUobWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtlcnJvcjogdHJ1ZSwgY29kZTogYnIuY29kZSwgbWVzc2FnZX07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYnI7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgYnVpbGRSZXN1bHQ6IFByb21pc2U8Q2hpbGRQcm9jZXNzUmVzdWx0PiA9IGV4ZWN1dGVPbmUoY29tbWFuZHNbMF0pO1xuICAgICAgICAgICAgZm9yIChjb25zdCBidWlsZENvbW1hbmQgb2YgY29tbWFuZHMuc2xpY2UoMSkpIHtcbiAgICAgICAgICAgICAgICBidWlsZFJlc3VsdCA9IGJ1aWxkUmVzdWx0XG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGJyID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChici5lcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkJ1aWxkIGZhaWx1cmU6IFwiICsgYnIuZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgbG9nLndyaXRlKHNwcmludGYoXCJOZXh0IGFmdGVyICVqIGlzLi4uJXNcIiwgYnIsIHN0cmluZ2lmeVNwYXduQ29tbWFuZChidWlsZENvbW1hbmQpKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhlY3V0ZU9uZShidWlsZENvbW1hbmQpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJ1aWxkUmVzdWx0ID0gYnVpbGRSZXN1bHQudGhlbihiciA9PiB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oXCJCdWlsZCBSRVRVUk46ICVqXCIsIGJyKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gYnI7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNvbnN0IGIgPSBuZXcgU3Bhd25lZEJ1aWxkKGFwcElkLCBpZCwgYnVpbGRSZXN1bHQsIHRlYW0sIGxvZy51cmwsXG4gICAgICAgICAgICAgICAgISF0aGlzLm9wdGlvbnMuZGVwbG95bWVudFVuaXRGb3IgPyBhd2FpdCB0aGlzLm9wdGlvbnMuZGVwbG95bWVudFVuaXRGb3IocCwgYXBwSWQpIDogdW5kZWZpbmVkKTtcbiAgICAgICAgICAgIHJldHVybiBiO1xuICAgICAgICB9KTtcbiAgICB9XG5cbn1cblxuYXN5bmMgZnVuY3Rpb24gbG9hZENvbW1hbmRzRnJvbUZpbGUocDogUHJvamVjdCwgcGF0aDogc3RyaW5nKSB7XG4gICAgY29uc3QgYnVpbGRGaWxlID0gYXdhaXQgcC5nZXRGaWxlKHBhdGgpO1xuICAgIGlmICghYnVpbGRGaWxlKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCBidWlsZEZpbGUuZ2V0Q29udGVudCgpO1xuICAgIGNvbnN0IGNvbW1hbmRzID0gY29udGVudC5zcGxpdChcIlxcblwiKVxuICAgICAgICAuZmlsdGVyKGwgPT4gISFsKVxuICAgICAgICAuZmlsdGVyKGwgPT4gIWwuc3RhcnRzV2l0aChcIiNcIikpXG4gICAgICAgIC5tYXAobCA9PiBhc1NwYXduQ29tbWFuZChsLCB7fSkpO1xuICAgIGxvZ2dlci5pbmZvKFwiRm91bmQgQXRvbWlzdCBidWlsZCBmaWxlIGluIHByb2plY3QgJWo6IENvbW1hbmRzIGFyZSAlalwiLCBwLmlkLFxuICAgICAgICBjb21tYW5kcyk7XG5cbiAgICByZXR1cm4gY29tbWFuZHM7XG59XG5cbmNsYXNzIFNwYXduZWRCdWlsZCBpbXBsZW1lbnRzIExvY2FsQnVpbGRJblByb2dyZXNzIHtcblxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBhcHBJbmZvOiBBcHBJbmZvLFxuICAgICAgICAgICAgICAgIHB1YmxpYyByZXBvUmVmOiBSZW1vdGVSZXBvUmVmLFxuICAgICAgICAgICAgICAgIHB1YmxpYyBidWlsZFJlc3VsdDogUHJvbWlzZTxDaGlsZFByb2Nlc3NSZXN1bHQ+LFxuICAgICAgICAgICAgICAgIHB1YmxpYyB0ZWFtOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgcHVibGljIHVybDogc3RyaW5nLFxuICAgICAgICAgICAgICAgIHB1YmxpYyBkZXBsb3ltZW50VW5pdEZpbGU6IHN0cmluZykge1xuICAgIH1cblxufVxuIl19