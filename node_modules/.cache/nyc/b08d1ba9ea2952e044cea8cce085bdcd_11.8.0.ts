"use strict";/*
 * Copyright Â© 2018 Atomist, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var cov_1h66qts8kz=function(){var path="/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/log/RolarProgressLog.ts",hash="dbc85f8eb4622975ce0a8432f9ad7045ce297704",Function=function(){}.constructor,global=new Function('return this')(),gcv="__coverage__",coverageData={path:"/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/log/RolarProgressLog.ts",statementMap:{"0":{start:{line:17,column:16},end:{line:24,column:1}},"1":{start:{line:18,column:4},end:{line:23,column:7}},"2":{start:{line:19,column:36},end:{line:19,column:97}},"3":{start:{line:19,column:42},end:{line:19,column:70}},"4":{start:{line:19,column:85},end:{line:19,column:95}},"5":{start:{line:20,column:35},end:{line:20,column:100}},"6":{start:{line:20,column:41},end:{line:20,column:73}},"7":{start:{line:20,column:88},end:{line:20,column:98}},"8":{start:{line:21,column:32},end:{line:21,column:149}},"9":{start:{line:21,column:97},end:{line:21,column:119}},"10":{start:{line:22,column:8},end:{line:22,column:78}},"11":{start:{line:25,column:0},end:{line:25,column:62}},"12":{start:{line:26,column:10},end:{line:26,column:27}},"13":{start:{line:27,column:16},end:{line:27,column:32}},"14":{start:{line:28,column:28},end:{line:28,column:65}},"15":{start:{line:29,column:16},end:{line:29,column:64}},"16":{start:{line:30,column:11},end:{line:30,column:24}},"17":{start:{line:32,column:4},end:{line:34,column:5}},"18":{start:{line:33,column:8},end:{line:33,column:25}},"19":{start:{line:41,column:8},end:{line:41,column:41}},"20":{start:{line:42,column:8},end:{line:42,column:31}},"21":{start:{line:43,column:8},end:{line:43,column:47}},"22":{start:{line:44,column:8},end:{line:44,column:33}},"23":{start:{line:45,column:8},end:{line:45,column:39}},"24":{start:{line:46,column:8},end:{line:46,column:41}},"25":{start:{line:47,column:8},end:{line:47,column:43}},"26":{start:{line:48,column:8},end:{line:48,column:28}},"27":{start:{line:51,column:8},end:{line:51,column:38}},"28":{start:{line:54,column:8},end:{line:54,column:56}},"29":{start:{line:57,column:8},end:{line:67,column:11}},"30":{start:{line:58,column:24},end:{line:58,column:55}},"31":{start:{line:59,column:12},end:{line:66,column:13}},"32":{start:{line:60,column:16},end:{line:60,column:136}},"33":{start:{line:60,column:48},end:{line:60,column:76}},"34":{start:{line:61,column:16},end:{line:61,column:28}},"35":{start:{line:64,column:16},end:{line:64,column:97}},"36":{start:{line:65,column:16},end:{line:65,column:29}},"37":{start:{line:70,column:21},end:{line:70,column:25}},"38":{start:{line:71,column:8},end:{line:75,column:11}},"39":{start:{line:76,column:27},end:{line:76,column:99}},"40":{start:{line:76,column:67},end:{line:76,column:95}},"41":{start:{line:77,column:8},end:{line:80,column:9}},"42":{start:{line:79,column:12},end:{line:79,column:25}},"43":{start:{line:83,column:8},end:{line:83,column:36}},"44":{start:{line:86,column:8},end:{line:86,column:35}},"45":{start:{line:89,column:8},end:{line:104,column:11}},"46":{start:{line:90,column:39},end:{line:90,column:69}},"47":{start:{line:91,column:24},end:{line:91,column:102}},"48":{start:{line:92,column:32},end:{line:92,column:46}},"49":{start:{line:93,column:12},end:{line:93,column:32}},"50":{start:{line:94,column:27},end:{line:102,column:14}},"51":{start:{line:94,column:59},end:{line:99,column:14}},"52":{start:{line:100,column:16},end:{line:100,column:68}},"53":{start:{line:101,column:16},end:{line:101,column:52}},"54":{start:{line:103,column:12},end:{line:103,column:26}},"55":{start:{line:107,column:8},end:{line:109,column:9}},"56":{start:{line:108,column:12},end:{line:108,column:22}},"57":{start:{line:110,column:20},end:{line:110,column:49}},"58":{start:{line:111,column:21},end:{line:112,column:55}},"59":{start:{line:112,column:22},end:{line:112,column:54}},"60":{start:{line:113,column:21},end:{line:114,column:55}},"61":{start:{line:114,column:22},end:{line:114,column:54}},"62":{start:{line:115,column:8},end:{line:115,column:112}},"63":{start:{line:118,column:0},end:{line:118,column:44}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:17,column:44},end:{line:17,column:45}},loc:{start:{line:17,column:89},end:{line:24,column:1}},line:17},"1":{name:"(anonymous_1)",decl:{start:{line:18,column:36},end:{line:18,column:37}},loc:{start:{line:18,column:63},end:{line:23,column:5}},line:18},"2":{name:"fulfilled",decl:{start:{line:19,column:17},end:{line:19,column:26}},loc:{start:{line:19,column:34},end:{line:19,column:99}},line:19},"3":{name:"rejected",decl:{start:{line:20,column:17},end:{line:20,column:25}},loc:{start:{line:20,column:33},end:{line:20,column:102}},line:20},"4":{name:"step",decl:{start:{line:21,column:17},end:{line:21,column:21}},loc:{start:{line:21,column:30},end:{line:21,column:151}},line:21},"5":{name:"(anonymous_5)",decl:{start:{line:21,column:76},end:{line:21,column:77}},loc:{start:{line:21,column:95},end:{line:21,column:121}},line:21},"6":{name:"timestampGenerator",decl:{start:{line:31,column:10},end:{line:31,column:28}},loc:{start:{line:31,column:31},end:{line:35,column:1}},line:31},"7":{name:"(anonymous_7)",decl:{start:{line:40,column:4},end:{line:40,column:5}},loc:{start:{line:40,column:171},end:{line:49,column:5}},line:40},"8":{name:"(anonymous_8)",decl:{start:{line:50,column:4},end:{line:50,column:5}},loc:{start:{line:50,column:15},end:{line:52,column:5}},line:50},"9":{name:"(anonymous_9)",decl:{start:{line:53,column:4},end:{line:53,column:5}},loc:{start:{line:53,column:14},end:{line:55,column:5}},line:53},"10":{name:"(anonymous_10)",decl:{start:{line:56,column:4},end:{line:56,column:5}},loc:{start:{line:56,column:18},end:{line:68,column:5}},line:56},"11":{name:"(anonymous_11)",decl:{start:{line:57,column:47},end:{line:57,column:48}},loc:{start:{line:57,column:60},end:{line:67,column:9}},line:57},"12":{name:"(anonymous_12)",decl:{start:{line:60,column:42},end:{line:60,column:43}},loc:{start:{line:60,column:48},end:{line:60,column:76}},line:60},"13":{name:"(anonymous_13)",decl:{start:{line:69,column:4},end:{line:69,column:5}},loc:{start:{line:69,column:16},end:{line:81,column:5}},line:69},"14":{name:"(anonymous_14)",decl:{start:{line:76,column:49},end:{line:76,column:50}},loc:{start:{line:76,column:67},end:{line:76,column:95}},line:76},"15":{name:"(anonymous_15)",decl:{start:{line:82,column:4},end:{line:82,column:5}},loc:{start:{line:82,column:12},end:{line:84,column:5}},line:82},"16":{name:"(anonymous_16)",decl:{start:{line:85,column:4},end:{line:85,column:5}},loc:{start:{line:85,column:12},end:{line:87,column:5}},line:85},"17":{name:"(anonymous_17)",decl:{start:{line:88,column:4},end:{line:88,column:5}},loc:{start:{line:88,column:23},end:{line:105,column:5}},line:88},"18":{name:"(anonymous_18)",decl:{start:{line:89,column:47},end:{line:89,column:48}},loc:{start:{line:89,column:60},end:{line:104,column:9}},line:89},"19":{name:"(anonymous_19)",decl:{start:{line:94,column:53},end:{line:94,column:54}},loc:{start:{line:94,column:59},end:{line:99,column:14}},line:94},"20":{name:"(anonymous_20)",decl:{start:{line:99,column:62},end:{line:99,column:63}},loc:{start:{line:99,column:67},end:{line:102,column:13}},line:99},"21":{name:"(anonymous_21)",decl:{start:{line:106,column:4},end:{line:106,column:5}},loc:{start:{line:106,column:28},end:{line:116,column:5}},line:106},"22":{name:"(anonymous_22)",decl:{start:{line:112,column:17},end:{line:112,column:18}},loc:{start:{line:112,column:22},end:{line:112,column:54}},line:112},"23":{name:"(anonymous_23)",decl:{start:{line:114,column:17},end:{line:114,column:18}},loc:{start:{line:114,column:22},end:{line:114,column:54}},line:114}},branchMap:{"0":{loc:{start:{line:17,column:16},end:{line:24,column:1}},type:"binary-expr",locations:[{start:{line:17,column:17},end:{line:17,column:21}},{start:{line:17,column:25},end:{line:17,column:39}},{start:{line:17,column:44},end:{line:24,column:1}}],line:17},"1":{loc:{start:{line:18,column:16},end:{line:18,column:34}},type:"binary-expr",locations:[{start:{line:18,column:16},end:{line:18,column:17}},{start:{line:18,column:22},end:{line:18,column:33}}],line:18},"2":{loc:{start:{line:21,column:32},end:{line:21,column:148}},type:"cond-expr",locations:[{start:{line:21,column:46},end:{line:21,column:67}},{start:{line:21,column:70},end:{line:21,column:148}}],line:21},"3":{loc:{start:{line:22,column:51},end:{line:22,column:67}},type:"binary-expr",locations:[{start:{line:22,column:51},end:{line:22,column:61}},{start:{line:22,column:65},end:{line:22,column:67}}],line:22},"4":{loc:{start:{line:40,column:39},end:{line:40,column:62}},type:"default-arg",locations:[{start:{line:40,column:57},end:{line:40,column:62}}],line:40},"5":{loc:{start:{line:40,column:64},end:{line:40,column:81}},type:"default-arg",locations:[{start:{line:40,column:75},end:{line:40,column:81}}],line:40},"6":{loc:{start:{line:40,column:83},end:{line:40,column:117}},type:"default-arg",locations:[{start:{line:40,column:97},end:{line:40,column:117}}],line:40},"7":{loc:{start:{line:40,column:119},end:{line:40,column:136}},type:"default-arg",locations:[{start:{line:40,column:134},end:{line:40,column:136}}],line:40},"8":{loc:{start:{line:40,column:138},end:{line:40,column:169}},type:"default-arg",locations:[{start:{line:40,column:154},end:{line:40,column:169}}],line:40},"9":{loc:{start:{line:77,column:8},end:{line:80,column:9}},type:"if",locations:[{start:{line:77,column:8},end:{line:80,column:9}},{start:{line:77,column:8},end:{line:80,column:9}}],line:77},"10":{loc:{start:{line:90,column:39},end:{line:90,column:69}},type:"cond-expr",locations:[{start:{line:90,column:50},end:{line:90,column:64}},{start:{line:90,column:67},end:{line:90,column:69}}],line:90},"11":{loc:{start:{line:107,column:8},end:{line:109,column:9}},type:"if",locations:[{start:{line:107,column:8},end:{line:109,column:9}},{start:{line:107,column:8},end:{line:109,column:9}}],line:107}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0,"49":0,"50":0,"51":0,"52":0,"53":0,"54":0,"55":0,"56":0,"57":0,"58":0,"59":0,"60":0,"61":0,"62":0,"63":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0},b:{"0":[0,0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0],"5":[0],"6":[0],"7":[0],"8":[0],"9":[0,0],"10":[0,0],"11":[0,0]},_coverageSchema:"332fd63041d2c1bcb487cc26dd0d5f7d97098a6c"},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var __awaiter=(cov_1h66qts8kz.s[0]++,(cov_1h66qts8kz.b[0][0]++,this)&&(cov_1h66qts8kz.b[0][1]++,this.__awaiter)||(cov_1h66qts8kz.b[0][2]++,function(thisArg,_arguments,P,generator){cov_1h66qts8kz.f[0]++;cov_1h66qts8kz.s[1]++;return new((cov_1h66qts8kz.b[1][0]++,P)||(cov_1h66qts8kz.b[1][1]++,P=Promise))(function(resolve,reject){cov_1h66qts8kz.f[1]++;function fulfilled(value){cov_1h66qts8kz.f[2]++;cov_1h66qts8kz.s[2]++;try{cov_1h66qts8kz.s[3]++;step(generator.next(value));}catch(e){cov_1h66qts8kz.s[4]++;reject(e);}}function rejected(value){cov_1h66qts8kz.f[3]++;cov_1h66qts8kz.s[5]++;try{cov_1h66qts8kz.s[6]++;step(generator["throw"](value));}catch(e){cov_1h66qts8kz.s[7]++;reject(e);}}function step(result){cov_1h66qts8kz.f[4]++;cov_1h66qts8kz.s[8]++;result.done?(cov_1h66qts8kz.b[2][0]++,resolve(result.value)):(cov_1h66qts8kz.b[2][1]++,new P(function(resolve){cov_1h66qts8kz.f[5]++;cov_1h66qts8kz.s[9]++;resolve(result.value);}).then(fulfilled,rejected));}cov_1h66qts8kz.s[10]++;step((generator=generator.apply(thisArg,(cov_1h66qts8kz.b[3][0]++,_arguments)||(cov_1h66qts8kz.b[3][1]++,[]))).next());});}));cov_1h66qts8kz.s[11]++;Object.defineProperty(exports,"__esModule",{value:true});const _=(cov_1h66qts8kz.s[12]++,require("lodash"));const axios_1=(cov_1h66qts8kz.s[13]++,require("axios"));const automation_client_1=(cov_1h66qts8kz.s[14]++,require("@atomist/automation-client"));const retry_1=(cov_1h66qts8kz.s[15]++,require("@atomist/automation-client/util/retry"));const os=(cov_1h66qts8kz.s[16]++,require("os"));function*timestampGenerator(){cov_1h66qts8kz.f[6]++;cov_1h66qts8kz.s[17]++;while(true){cov_1h66qts8kz.s[18]++;yield new Date();}}/**
 * Post log to Atomist Rolar service for it to persist
 */class RolarProgressLog{constructor(rolarBaseUrl,logPath,bufferSizeLimit=(cov_1h66qts8kz.b[4][0]++,10000),logLevel=(cov_1h66qts8kz.b[5][0]++,"info"),timestamper=(cov_1h66qts8kz.b[6][0]++,timestampGenerator()),retryOptions=(cov_1h66qts8kz.b[7][0]++,{}),axiosInstance=(cov_1h66qts8kz.b[8][0]++,axios_1.default)){cov_1h66qts8kz.f[7]++;cov_1h66qts8kz.s[19]++;this.rolarBaseUrl=rolarBaseUrl;cov_1h66qts8kz.s[20]++;this.logPath=logPath;cov_1h66qts8kz.s[21]++;this.bufferSizeLimit=bufferSizeLimit;cov_1h66qts8kz.s[22]++;this.logLevel=logLevel;cov_1h66qts8kz.s[23]++;this.timestamper=timestamper;cov_1h66qts8kz.s[24]++;this.retryOptions=retryOptions;cov_1h66qts8kz.s[25]++;this.axiosInstance=axiosInstance;cov_1h66qts8kz.s[26]++;this.localLogs=[];}get name(){cov_1h66qts8kz.f[8]++;cov_1h66qts8kz.s[27]++;return this.logPath.join("/");}get url(){cov_1h66qts8kz.f[9]++;cov_1h66qts8kz.s[28]++;return`${this.rolarBaseUrl}/logs/${this.name}`;}isAvailable(){cov_1h66qts8kz.f[10]++;cov_1h66qts8kz.s[29]++;return __awaiter(this,void 0,void 0,function*(){cov_1h66qts8kz.f[11]++;const url=(cov_1h66qts8kz.s[30]++,`${this.rolarBaseUrl}/api/logs`);cov_1h66qts8kz.s[31]++;try{cov_1h66qts8kz.s[32]++;yield retry_1.doWithRetry(()=>{cov_1h66qts8kz.f[12]++;cov_1h66qts8kz.s[33]++;return this.axiosInstance.head(url);},`check if Rolar service is available`,this.retryOptions);cov_1h66qts8kz.s[34]++;return true;}catch(e){cov_1h66qts8kz.s[35]++;automation_client_1.logger.warn(`Rolar logger is NOT available at ${url}: ${e}`);cov_1h66qts8kz.s[36]++;return false;}});}write(what){cov_1h66qts8kz.f[13]++;const line=(cov_1h66qts8kz.s[37]++,what);cov_1h66qts8kz.s[38]++;this.localLogs.push({level:this.logLevel,message:line,timestamp:this.constructUtcTimestamp()});const bufferSize=(cov_1h66qts8kz.s[39]++,this.localLogs.reduce((acc,logData)=>{cov_1h66qts8kz.f[14]++;cov_1h66qts8kz.s[40]++;return acc+logData.message.length;},0));cov_1h66qts8kz.s[41]++;if(bufferSize>this.bufferSizeLimit){cov_1h66qts8kz.b[9][0]++;cov_1h66qts8kz.s[42]++;// tslint:disable-next-line:no-floating-promises
this.flush();}else{cov_1h66qts8kz.b[9][1]++;}}flush(){cov_1h66qts8kz.f[15]++;cov_1h66qts8kz.s[43]++;return this.postLogs(false);}close(){cov_1h66qts8kz.f[16]++;cov_1h66qts8kz.s[44]++;return this.postLogs(true);}postLogs(isClosed){cov_1h66qts8kz.f[17]++;cov_1h66qts8kz.s[45]++;return __awaiter(this,void 0,void 0,function*(){cov_1h66qts8kz.f[18]++;const closedRequestParam=(cov_1h66qts8kz.s[46]++,isClosed?(cov_1h66qts8kz.b[10][0]++,"?closed=true"):(cov_1h66qts8kz.b[10][1]++,""));const url=(cov_1h66qts8kz.s[47]++,`${this.rolarBaseUrl}/api/logs/${this.logPath.join("/")}${closedRequestParam}`);const postingLogs=(cov_1h66qts8kz.s[48]++,this.localLogs);cov_1h66qts8kz.s[49]++;this.localLogs=[];const result=(cov_1h66qts8kz.s[50]++,yield retry_1.doWithRetry(()=>{cov_1h66qts8kz.f[19]++;cov_1h66qts8kz.s[51]++;return this.axiosInstance.post(url,{host:os.hostname(),content:postingLogs},{headers:{"Content-Type":"application/json"}});},`post log to Rolar`,this.retryOptions).catch(e=>{cov_1h66qts8kz.f[20]++;cov_1h66qts8kz.s[52]++;this.localLogs=postingLogs.concat(this.localLogs);cov_1h66qts8kz.s[53]++;automation_client_1.logger.error(e);}));cov_1h66qts8kz.s[54]++;return result;});}constructUtcTimestamp(){cov_1h66qts8kz.f[21]++;cov_1h66qts8kz.s[55]++;if(!this.timestamper){cov_1h66qts8kz.b[11][0]++;cov_1h66qts8kz.s[56]++;return"";}else{cov_1h66qts8kz.b[11][1]++;}const now=(cov_1h66qts8kz.s[57]++,this.timestamper.next().value);const date=(cov_1h66qts8kz.s[58]++,[now.getUTCMonth()+1,now.getUTCDate(),now.getUTCFullYear()].map(t=>{cov_1h66qts8kz.f[22]++;cov_1h66qts8kz.s[59]++;return _.padStart(t.toString(),2,"0");}));const time=(cov_1h66qts8kz.s[60]++,[now.getUTCHours(),now.getUTCMinutes(),now.getUTCSeconds()].map(t=>{cov_1h66qts8kz.f[23]++;cov_1h66qts8kz.s[61]++;return _.padStart(t.toString(),2,"0");}));cov_1h66qts8kz.s[62]++;return`${date.join("/")} ${time.join(":")}.${_.padStart(now.getUTCMilliseconds().toString(),3,"0")}`;}}cov_1h66qts8kz.s[63]++;exports.RolarProgressLog=RolarProgressLog;//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL2NvbW1vbi9sb2cvUm9sYXJQcm9ncmVzc0xvZy50cyIsInNvdXJjZXMiOlsiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL2NvbW1vbi9sb2cvUm9sYXJQcm9ncmVzc0xvZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7O0dBY0c7Ozs7Ozs7Ozs7QUFFSCw0QkFBNEI7QUFFNUIsaUNBQTBCO0FBRzFCLGtFQUFrRDtBQUNsRCxpRUFBb0U7QUFHcEUseUJBQTBCO0FBRzFCLFFBQVEsQ0FBQztJQUNMLE9BQU8sSUFBSSxFQUFFO1FBQ1QsTUFBTSxJQUFJLElBQUksRUFBRSxDQUFDO0tBQ3BCO0FBQ0wsQ0FBQztBQUVEOztHQUVHO0FBQ0g7SUFJSSxZQUE2QixZQUFvQixFQUNwQixPQUFpQixFQUNqQixrQkFBMEIsS0FBSyxFQUMvQixXQUFtQixNQUFNLEVBQ3pCLGNBQThCLGtCQUFrQixFQUFFLEVBQ2xELGVBQTRCLEVBQUUsRUFDOUIsZ0JBQStCLGVBQUs7UUFOcEMsaUJBQVksR0FBWixZQUFZLENBQVE7UUFDcEIsWUFBTyxHQUFQLE9BQU8sQ0FBVTtRQUNqQixvQkFBZSxHQUFmLGVBQWUsQ0FBZ0I7UUFDL0IsYUFBUSxHQUFSLFFBQVEsQ0FBaUI7UUFDekIsZ0JBQVcsR0FBWCxXQUFXLENBQXVDO1FBQ2xELGlCQUFZLEdBQVosWUFBWSxDQUFrQjtRQUM5QixrQkFBYSxHQUFiLGFBQWEsQ0FBdUI7UUFSekQsY0FBUyxHQUFjLEVBQUUsQ0FBQztJQVNsQyxDQUFDO0lBRUQsSUFBSSxJQUFJO1FBQ0osT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRUQsSUFBSSxHQUFHO1FBQ0gsT0FBTyxHQUFHLElBQUksQ0FBQyxZQUFZLFNBQVMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3BELENBQUM7SUFFWSxXQUFXOztZQUNwQixNQUFNLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxZQUFZLFdBQVcsQ0FBQztZQUM1QyxJQUFJO2dCQUNBLE1BQU0sbUJBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFDaEQscUNBQXFDLEVBQ3JDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztnQkFDdkIsT0FBTyxJQUFJLENBQUM7YUFDZjtZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNSLDBCQUFNLENBQUMsSUFBSSxDQUFDLG9DQUFvQyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDN0QsT0FBTyxLQUFLLENBQUM7YUFDaEI7UUFDTCxDQUFDO0tBQUE7SUFFTSxLQUFLLENBQUMsSUFBWTtRQUNyQixNQUFNLElBQUksR0FBRyxJQUFJLENBQUM7UUFDbEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7WUFDaEIsS0FBSyxFQUFFLElBQUksQ0FBQyxRQUFRO1lBQ3BCLE9BQU8sRUFBRSxJQUFJO1lBQ2IsU0FBUyxFQUFFLElBQUksQ0FBQyxxQkFBcUIsRUFBRTtTQUMvQixDQUFDLENBQUM7UUFDZCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUM1RixJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsZUFBZSxFQUFFO1lBQ25DLGdEQUFnRDtZQUNoRCxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDaEI7SUFDTCxDQUFDO0lBRU0sS0FBSztRQUNSLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRU0sS0FBSztRQUNSLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRWEsUUFBUSxDQUFDLFFBQWlCOztZQUNwQyxNQUFNLGtCQUFrQixHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDMUQsTUFBTSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsWUFBWSxhQUFhLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLGtCQUFrQixFQUFFLENBQUM7WUFDM0YsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUNuQyxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztZQUNwQixNQUFNLE1BQU0sR0FBRyxNQUFNLG1CQUFXLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO2dCQUM1RCxJQUFJLEVBQUUsRUFBRSxDQUFDLFFBQVEsRUFBRTtnQkFDbkIsT0FBTyxFQUFFLFdBQVc7YUFDdkIsRUFBRTtnQkFDQyxPQUFPLEVBQUUsRUFBQyxjQUFjLEVBQUUsa0JBQWtCLEVBQUM7YUFDaEQsQ0FBQyxFQUNGLG1CQUFtQixFQUNuQixJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUN6QixJQUFJLENBQUMsU0FBUyxHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUNwRCwwQkFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwQixDQUFDLENBQ0osQ0FBQztZQUNGLE9BQU8sTUFBTSxDQUFDO1FBQ2xCLENBQUM7S0FBQTtJQUVPLHFCQUFxQjtRQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUFFLE9BQU8sRUFBRSxDQUFDO1NBQUU7UUFDckMsTUFBTSxHQUFHLEdBQVMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUM7UUFDaEQsTUFBTSxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxVQUFVLEVBQUUsRUFBRSxHQUFHLENBQUMsY0FBYyxFQUFFLENBQUM7YUFDdkUsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDaEQsTUFBTSxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLEVBQUUsR0FBRyxDQUFDLGFBQWEsRUFBRSxFQUFFLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQzthQUNyRSxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNoRCxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGtCQUFrQixFQUFFLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUM7SUFDNUcsQ0FBQztDQUNKO0FBckZELDRDQXFGQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgwqkgMjAxOCBBdG9taXN0LCBJbmMuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCAqIGFzIF8gZnJvbSBcImxvZGFzaFwiO1xuXG5pbXBvcnQgYXhpb3MgZnJvbSBcImF4aW9zXCI7XG5pbXBvcnQge1Byb2dyZXNzTG9nfSBmcm9tIFwiLi4vLi4vc3BpL2xvZy9Qcm9ncmVzc0xvZ1wiO1xuXG5pbXBvcnQge2xvZ2dlcn0gZnJvbSBcIkBhdG9taXN0L2F1dG9tYXRpb24tY2xpZW50XCI7XG5pbXBvcnQgeyBkb1dpdGhSZXRyeSB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudC91dGlsL3JldHJ5XCI7XG5cbmltcG9ydCB7QXhpb3NJbnN0YW5jZX0gZnJvbSBcImF4aW9zXCI7XG5pbXBvcnQgb3MgPSByZXF1aXJlKFwib3NcIik7XG5pbXBvcnQge1dyYXBPcHRpb25zfSBmcm9tIFwicmV0cnlcIjtcblxuZnVuY3Rpb24qIHRpbWVzdGFtcEdlbmVyYXRvcigpIHtcbiAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICB5aWVsZCBuZXcgRGF0ZSgpO1xuICAgIH1cbn1cblxuLyoqXG4gKiBQb3N0IGxvZyB0byBBdG9taXN0IFJvbGFyIHNlcnZpY2UgZm9yIGl0IHRvIHBlcnNpc3RcbiAqL1xuZXhwb3J0IGNsYXNzIFJvbGFyUHJvZ3Jlc3NMb2cgaW1wbGVtZW50cyBQcm9ncmVzc0xvZyB7XG5cbiAgICBwcml2YXRlIGxvY2FsTG9nczogTG9nRGF0YVtdID0gW107XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHJvbGFyQmFzZVVybDogc3RyaW5nLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgcmVhZG9ubHkgbG9nUGF0aDogc3RyaW5nW10sXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSByZWFkb25seSBidWZmZXJTaXplTGltaXQ6IG51bWJlciA9IDEwMDAwLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgcmVhZG9ubHkgbG9nTGV2ZWw6IHN0cmluZyA9IFwiaW5mb1wiLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgcmVhZG9ubHkgdGltZXN0YW1wZXI6IEl0ZXJhdG9yPERhdGU+ID0gdGltZXN0YW1wR2VuZXJhdG9yKCksXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSByZWFkb25seSByZXRyeU9wdGlvbnM6IFdyYXBPcHRpb25zID0ge30sXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSByZWFkb25seSBheGlvc0luc3RhbmNlOiBBeGlvc0luc3RhbmNlID0gYXhpb3MpIHtcbiAgICB9XG5cbiAgICBnZXQgbmFtZSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9nUGF0aC5qb2luKFwiL1wiKTtcbiAgICB9XG5cbiAgICBnZXQgdXJsKCkge1xuICAgICAgICByZXR1cm4gYCR7dGhpcy5yb2xhckJhc2VVcmx9L2xvZ3MvJHt0aGlzLm5hbWV9YDtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgaXNBdmFpbGFibGUoKSB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke3RoaXMucm9sYXJCYXNlVXJsfS9hcGkvbG9nc2A7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBkb1dpdGhSZXRyeSgoKSA9PiB0aGlzLmF4aW9zSW5zdGFuY2UuaGVhZCh1cmwpLFxuICAgICAgICAgICAgICAgIGBjaGVjayBpZiBSb2xhciBzZXJ2aWNlIGlzIGF2YWlsYWJsZWAsXG4gICAgICAgICAgICAgICAgdGhpcy5yZXRyeU9wdGlvbnMpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGxvZ2dlci53YXJuKGBSb2xhciBsb2dnZXIgaXMgTk9UIGF2YWlsYWJsZSBhdCAke3VybH06ICR7ZX1gKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyB3cml0ZSh3aGF0OiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgbGluZSA9IHdoYXQ7XG4gICAgICAgIHRoaXMubG9jYWxMb2dzLnB1c2goe1xuICAgICAgICAgICAgbGV2ZWw6IHRoaXMubG9nTGV2ZWwsXG4gICAgICAgICAgICBtZXNzYWdlOiBsaW5lLFxuICAgICAgICAgICAgdGltZXN0YW1wOiB0aGlzLmNvbnN0cnVjdFV0Y1RpbWVzdGFtcCgpLFxuICAgICAgICB9IGFzIExvZ0RhdGEpO1xuICAgICAgICBjb25zdCBidWZmZXJTaXplID0gdGhpcy5sb2NhbExvZ3MucmVkdWNlKChhY2MsIGxvZ0RhdGEpID0+IGFjYyArIGxvZ0RhdGEubWVzc2FnZS5sZW5ndGgsIDApO1xuICAgICAgICBpZiAoYnVmZmVyU2l6ZSA+IHRoaXMuYnVmZmVyU2l6ZUxpbWl0KSB7XG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgICAgICAgIHRoaXMuZmx1c2goKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBmbHVzaCgpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wb3N0TG9ncyhmYWxzZSk7XG4gICAgfVxuXG4gICAgcHVibGljIGNsb3NlKCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnBvc3RMb2dzKHRydWUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgcG9zdExvZ3MoaXNDbG9zZWQ6IGJvb2xlYW4pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zdCBjbG9zZWRSZXF1ZXN0UGFyYW0gPSBpc0Nsb3NlZCA/IFwiP2Nsb3NlZD10cnVlXCIgOiBcIlwiO1xuICAgICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLnJvbGFyQmFzZVVybH0vYXBpL2xvZ3MvJHt0aGlzLmxvZ1BhdGguam9pbihcIi9cIil9JHtjbG9zZWRSZXF1ZXN0UGFyYW19YDtcbiAgICAgICAgY29uc3QgcG9zdGluZ0xvZ3MgPSB0aGlzLmxvY2FsTG9ncztcbiAgICAgICAgdGhpcy5sb2NhbExvZ3MgPSBbXTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9XaXRoUmV0cnkoKCkgPT4gdGhpcy5heGlvc0luc3RhbmNlLnBvc3QodXJsLCB7XG4gICAgICAgICAgICAgICAgaG9zdDogb3MuaG9zdG5hbWUoKSxcbiAgICAgICAgICAgICAgICBjb250ZW50OiBwb3N0aW5nTG9ncyxcbiAgICAgICAgICAgIH0sIHtcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7XCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCJ9LFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBgcG9zdCBsb2cgdG8gUm9sYXJgLFxuICAgICAgICAgICAgdGhpcy5yZXRyeU9wdGlvbnMpLmNhdGNoKGUgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9jYWxMb2dzID0gcG9zdGluZ0xvZ3MuY29uY2F0KHRoaXMubG9jYWxMb2dzKTtcbiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIHByaXZhdGUgY29uc3RydWN0VXRjVGltZXN0YW1wKCk6IHN0cmluZyB7XG4gICAgICAgIGlmICghdGhpcy50aW1lc3RhbXBlcikgeyByZXR1cm4gXCJcIjsgfVxuICAgICAgICBjb25zdCBub3c6IERhdGUgPSB0aGlzLnRpbWVzdGFtcGVyLm5leHQoKS52YWx1ZTtcbiAgICAgICAgY29uc3QgZGF0ZSA9IFtub3cuZ2V0VVRDTW9udGgoKSArIDEsIG5vdy5nZXRVVENEYXRlKCksIG5vdy5nZXRVVENGdWxsWWVhcigpXVxuICAgICAgICAgICAgLm1hcCh0ID0+IF8ucGFkU3RhcnQodC50b1N0cmluZygpLCAyLCBcIjBcIikpO1xuICAgICAgICBjb25zdCB0aW1lID0gW25vdy5nZXRVVENIb3VycygpLCBub3cuZ2V0VVRDTWludXRlcygpLCBub3cuZ2V0VVRDU2Vjb25kcygpXVxuICAgICAgICAgICAgLm1hcCh0ID0+IF8ucGFkU3RhcnQodC50b1N0cmluZygpLCAyLCBcIjBcIikpO1xuICAgICAgICByZXR1cm4gYCR7ZGF0ZS5qb2luKFwiL1wiKX0gJHt0aW1lLmpvaW4oXCI6XCIpfS4ke18ucGFkU3RhcnQobm93LmdldFVUQ01pbGxpc2Vjb25kcygpLnRvU3RyaW5nKCksIDMsIFwiMFwiKX1gO1xuICAgIH1cbn1cblxuaW50ZXJmYWNlIExvZ0RhdGEge1xuICAgIGxldmVsOiBzdHJpbmc7XG4gICAgbWVzc2FnZTogc3RyaW5nO1xuICAgIHRpbWVzdGFtcDogc3RyaW5nO1xufVxuIl19