"use strict";/*
 * Copyright Â© 2018 Atomist, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var cov_18278jgu7v=function(){var path="/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/delivery/build/local/npm/npmBuilder.ts",hash="d1a0228f603574d70ae6bcc2b8256d63e99359d5",Function=function(){}.constructor,global=new Function('return this')(),gcv="__coverage__",coverageData={path:"/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/delivery/build/local/npm/npmBuilder.ts",statementMap:{"0":{start:{line:17,column:16},end:{line:24,column:1}},"1":{start:{line:18,column:4},end:{line:23,column:7}},"2":{start:{line:19,column:36},end:{line:19,column:97}},"3":{start:{line:19,column:42},end:{line:19,column:70}},"4":{start:{line:19,column:85},end:{line:19,column:95}},"5":{start:{line:20,column:35},end:{line:20,column:100}},"6":{start:{line:20,column:41},end:{line:20,column:73}},"7":{start:{line:20,column:88},end:{line:20,column:98}},"8":{start:{line:21,column:32},end:{line:21,column:149}},"9":{start:{line:21,column:97},end:{line:21,column:119}},"10":{start:{line:22,column:8},end:{line:22,column:78}},"11":{start:{line:25,column:0},end:{line:25,column:62}},"12":{start:{line:26,column:18},end:{line:26,column:61}},"13":{start:{line:27,column:23},end:{line:27,column:52}},"14":{start:{line:28,column:27},end:{line:28,column:57}},"15":{start:{line:29,column:23},end:{line:29,column:49}},"16":{start:{line:30,column:28},end:{line:30,column:58}},"17":{start:{line:34,column:0},end:{line:36,column:2}},"18":{start:{line:37,column:0},end:{line:37,column:84}},"19":{start:{line:39,column:4},end:{line:42,column:7}},"20":{start:{line:41,column:55},end:{line:41,column:115}},"21":{start:{line:44,column:0},end:{line:44,column:34}},"22":{start:{line:46,column:4},end:{line:61,column:6}},"23":{start:{line:50,column:12},end:{line:50,column:73}},"24":{start:{line:54,column:12},end:{line:59,column:15}},"25":{start:{line:55,column:36},end:{line:55,column:68}},"26":{start:{line:56,column:32},end:{line:56,column:62}},"27":{start:{line:57,column:28},end:{line:57,column:47}},"28":{start:{line:58,column:16},end:{line:58,column:74}},"29":{start:{line:64,column:4},end:{line:79,column:6}},"30":{start:{line:68,column:12},end:{line:68,column:73}},"31":{start:{line:72,column:12},end:{line:77,column:15}},"32":{start:{line:73,column:36},end:{line:73,column:68}},"33":{start:{line:74,column:32},end:{line:74,column:62}},"34":{start:{line:75,column:28},end:{line:75,column:47}},"35":{start:{line:76,column:16},end:{line:76,column:74}},"36":{start:{line:81,column:0},end:{line:81,column:62}},"37":{start:{line:82,column:0},end:{line:82,column:96}},"38":{start:{line:84,column:4},end:{line:92,column:7}},"39":{start:{line:85,column:31},end:{line:85,column:68}},"40":{start:{line:86,column:8},end:{line:91,column:11}},"41":{start:{line:90,column:33},end:{line:90,column:45}},"42":{start:{line:94,column:0},end:{line:94,column:54}},"43":{start:{line:96,column:4},end:{line:107,column:7}},"44":{start:{line:97,column:23},end:{line:97,column:41}},"45":{start:{line:98,column:24},end:{line:98,column:204}},"46":{start:{line:99,column:8},end:{line:106,column:11}},"47":{start:{line:105,column:33},end:{line:105,column:43}},"48":{start:{line:109,column:0},end:{line:109,column:54}},"49":{start:{line:111,column:4},end:{line:118,column:7}},"50":{start:{line:112,column:8},end:{line:117,column:11}},"51":{start:{line:116,column:33},end:{line:116,column:45}},"52":{start:{line:120,column:0},end:{line:120,column:54}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:17,column:44},end:{line:17,column:45}},loc:{start:{line:17,column:89},end:{line:24,column:1}},line:17},"1":{name:"(anonymous_1)",decl:{start:{line:18,column:36},end:{line:18,column:37}},loc:{start:{line:18,column:63},end:{line:23,column:5}},line:18},"2":{name:"fulfilled",decl:{start:{line:19,column:17},end:{line:19,column:26}},loc:{start:{line:19,column:34},end:{line:19,column:99}},line:19},"3":{name:"rejected",decl:{start:{line:20,column:17},end:{line:20,column:25}},loc:{start:{line:20,column:33},end:{line:20,column:102}},line:20},"4":{name:"step",decl:{start:{line:21,column:17},end:{line:21,column:21}},loc:{start:{line:21,column:30},end:{line:21,column:151}},line:21},"5":{name:"(anonymous_5)",decl:{start:{line:21,column:76},end:{line:21,column:77}},loc:{start:{line:21,column:95},end:{line:21,column:121}},line:21},"6":{name:"nodeBuilder",decl:{start:{line:38,column:9},end:{line:38,column:20}},loc:{start:{line:38,column:49},end:{line:43,column:1}},line:38},"7":{name:"(anonymous_7)",decl:{start:{line:41,column:48},end:{line:41,column:49}},loc:{start:{line:41,column:55},end:{line:41,column:115}},line:41},"8":{name:"npmBuilderOptions",decl:{start:{line:45,column:9},end:{line:45,column:26}},loc:{start:{line:45,column:37},end:{line:62,column:1}},line:45},"9":{name:"(anonymous_9)",decl:{start:{line:49,column:21},end:{line:49,column:22}},loc:{start:{line:49,column:42},end:{line:51,column:9}},line:49},"10":{name:"(anonymous_10)",decl:{start:{line:54,column:51},end:{line:54,column:52}},loc:{start:{line:54,column:64},end:{line:59,column:13}},line:54},"11":{name:"npmBuilderOptionsFromFile",decl:{start:{line:63,column:9},end:{line:63,column:34}},loc:{start:{line:63,column:48},end:{line:80,column:1}},line:63},"12":{name:"(anonymous_12)",decl:{start:{line:67,column:21},end:{line:67,column:22}},loc:{start:{line:67,column:42},end:{line:69,column:9}},line:67},"13":{name:"(anonymous_13)",decl:{start:{line:72,column:51},end:{line:72,column:52}},loc:{start:{line:72,column:64},end:{line:77,column:13}},line:72},"14":{name:"npmInstallPreparation",decl:{start:{line:83,column:9},end:{line:83,column:30}},loc:{start:{line:83,column:40},end:{line:93,column:1}},line:83},"15":{name:"(anonymous_15)",decl:{start:{line:84,column:43},end:{line:84,column:44}},loc:{start:{line:84,column:56},end:{line:92,column:5}},line:84},"16":{name:"(anonymous_16)",decl:{start:{line:90,column:25},end:{line:90,column:26}},loc:{start:{line:90,column:33},end:{line:90,column:45}},line:90},"17":{name:"npmVersionPreparation",decl:{start:{line:95,column:9},end:{line:95,column:30}},loc:{start:{line:95,column:40},end:{line:108,column:1}},line:95},"18":{name:"(anonymous_18)",decl:{start:{line:96,column:43},end:{line:96,column:44}},loc:{start:{line:96,column:56},end:{line:107,column:5}},line:96},"19":{name:"(anonymous_19)",decl:{start:{line:105,column:25},end:{line:105,column:26}},loc:{start:{line:105,column:33},end:{line:105,column:43}},line:105},"20":{name:"npmCompilePreparation",decl:{start:{line:110,column:9},end:{line:110,column:30}},loc:{start:{line:110,column:40},end:{line:119,column:1}},line:110},"21":{name:"(anonymous_21)",decl:{start:{line:111,column:43},end:{line:111,column:44}},loc:{start:{line:111,column:56},end:{line:118,column:5}},line:111},"22":{name:"(anonymous_22)",decl:{start:{line:116,column:25},end:{line:116,column:26}},loc:{start:{line:116,column:33},end:{line:116,column:45}},line:116}},branchMap:{"0":{loc:{start:{line:17,column:16},end:{line:24,column:1}},type:"binary-expr",locations:[{start:{line:17,column:17},end:{line:17,column:21}},{start:{line:17,column:25},end:{line:17,column:39}},{start:{line:17,column:44},end:{line:24,column:1}}],line:17},"1":{loc:{start:{line:18,column:16},end:{line:18,column:34}},type:"binary-expr",locations:[{start:{line:18,column:16},end:{line:18,column:17}},{start:{line:18,column:22},end:{line:18,column:33}}],line:18},"2":{loc:{start:{line:21,column:32},end:{line:21,column:148}},type:"cond-expr",locations:[{start:{line:21,column:46},end:{line:21,column:67}},{start:{line:21,column:70},end:{line:21,column:148}}],line:21},"3":{loc:{start:{line:22,column:51},end:{line:22,column:67}},type:"binary-expr",locations:[{start:{line:22,column:51},end:{line:22,column:61}},{start:{line:22,column:65},end:{line:22,column:67}}],line:22},"4":{loc:{start:{line:50,column:19},end:{line:50,column:72}},type:"binary-expr",locations:[{start:{line:50,column:19},end:{line:50,column:46}},{start:{line:50,column:50},end:{line:50,column:72}}],line:50},"5":{loc:{start:{line:68,column:19},end:{line:68,column:72}},type:"binary-expr",locations:[{start:{line:68,column:19},end:{line:68,column:46}},{start:{line:68,column:50},end:{line:68,column:72}}],line:68},"6":{loc:{start:{line:88,column:19},end:{line:88,column:52}},type:"cond-expr",locations:[{start:{line:88,column:36},end:{line:88,column:40}},{start:{line:88,column:43},end:{line:88,column:52}}],line:88}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0,"49":0,"50":0,"51":0,"52":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0},b:{"0":[0,0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0]},_coverageSchema:"332fd63041d2c1bcb487cc26dd0d5f7d97098a6c"},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var __awaiter=(cov_18278jgu7v.s[0]++,(cov_18278jgu7v.b[0][0]++,this)&&(cov_18278jgu7v.b[0][1]++,this.__awaiter)||(cov_18278jgu7v.b[0][2]++,function(thisArg,_arguments,P,generator){cov_18278jgu7v.f[0]++;cov_18278jgu7v.s[1]++;return new((cov_18278jgu7v.b[1][0]++,P)||(cov_18278jgu7v.b[1][1]++,P=Promise))(function(resolve,reject){cov_18278jgu7v.f[1]++;function fulfilled(value){cov_18278jgu7v.f[2]++;cov_18278jgu7v.s[2]++;try{cov_18278jgu7v.s[3]++;step(generator.next(value));}catch(e){cov_18278jgu7v.s[4]++;reject(e);}}function rejected(value){cov_18278jgu7v.f[3]++;cov_18278jgu7v.s[5]++;try{cov_18278jgu7v.s[6]++;step(generator["throw"](value));}catch(e){cov_18278jgu7v.s[7]++;reject(e);}}function step(result){cov_18278jgu7v.f[4]++;cov_18278jgu7v.s[8]++;result.done?(cov_18278jgu7v.b[2][0]++,resolve(result.value)):(cov_18278jgu7v.b[2][1]++,new P(function(resolve){cov_18278jgu7v.f[5]++;cov_18278jgu7v.s[9]++;resolve(result.value);}).then(fulfilled,rejected));}cov_18278jgu7v.s[10]++;step((generator=generator.apply(thisArg,(cov_18278jgu7v.b[3][0]++,_arguments)||(cov_18278jgu7v.b[3][1]++,[]))).next());});}));cov_18278jgu7v.s[11]++;Object.defineProperty(exports,"__esModule",{value:true});const spawned_1=(cov_18278jgu7v.s[12]++,require("../../../../../util/misc/spawned"));const executeBuild_1=(cov_18278jgu7v.s[13]++,require("../../executeBuild"));const projectVersioner_1=(cov_18278jgu7v.s[14]++,require("../projectVersioner"));const SpawnBuilder_1=(cov_18278jgu7v.s[15]++,require("../SpawnBuilder"));const npmLogInterpreter_1=(cov_18278jgu7v.s[16]++,require("./npmLogInterpreter"));/**
 * Options to use when running node commands like npm run compile that require dev dependencies to be installed
 */cov_18278jgu7v.s[17]++;exports.DevelopmentEnvOptions={env:Object.assign({},process.env,{NODE_ENV:"development"})};cov_18278jgu7v.s[18]++;exports.Install=spawned_1.asSpawnCommand("npm ci",exports.DevelopmentEnvOptions);function nodeBuilder(projectLoader,...commands){cov_18278jgu7v.f[6]++;cov_18278jgu7v.s[19]++;return new SpawnBuilder_1.SpawnBuilder({projectLoader,options:npmBuilderOptions(commands.map(cmd=>{cov_18278jgu7v.f[7]++;cov_18278jgu7v.s[20]++;return spawned_1.asSpawnCommand(cmd,exports.DevelopmentEnvOptions);}))});}cov_18278jgu7v.s[21]++;exports.nodeBuilder=nodeBuilder;function npmBuilderOptions(commands){cov_18278jgu7v.f[8]++;cov_18278jgu7v.s[22]++;return{name:"NpmBuilder",commands,errorFinder:(code,signal,l)=>{cov_18278jgu7v.f[9]++;cov_18278jgu7v.s[23]++;return(cov_18278jgu7v.b[4][0]++,l.log.startsWith("[error]"))||(cov_18278jgu7v.b[4][1]++,l.log.includes("ERR!"));},logInterpreter:npmLogInterpreter_1.NpmLogInterpreter,projectToAppInfo(p){cov_18278jgu7v.s[24]++;return __awaiter(this,void 0,void 0,function*(){cov_18278jgu7v.f[10]++;const packageJson=(cov_18278jgu7v.s[25]++,yield p.findFile("package.json"));const content=(cov_18278jgu7v.s[26]++,yield packageJson.getContent());const pkg=(cov_18278jgu7v.s[27]++,JSON.parse(content));cov_18278jgu7v.s[28]++;return{id:p.id,name:pkg.name,version:pkg.version};});}};}function npmBuilderOptionsFromFile(commandFile){cov_18278jgu7v.f[11]++;cov_18278jgu7v.s[29]++;return{name:"NpmBuilder",commandFile,errorFinder:(code,signal,l)=>{cov_18278jgu7v.f[12]++;cov_18278jgu7v.s[30]++;return(cov_18278jgu7v.b[5][0]++,l.log.startsWith("[error]"))||(cov_18278jgu7v.b[5][1]++,l.log.includes("ERR!"));},logInterpreter:npmLogInterpreter_1.NpmLogInterpreter,projectToAppInfo(p){cov_18278jgu7v.s[31]++;return __awaiter(this,void 0,void 0,function*(){cov_18278jgu7v.f[13]++;const packageJson=(cov_18278jgu7v.s[32]++,yield p.findFile("package.json"));const content=(cov_18278jgu7v.s[33]++,yield packageJson.getContent());const pkg=(cov_18278jgu7v.s[34]++,JSON.parse(content));cov_18278jgu7v.s[35]++;return{id:p.id,name:pkg.name,version:pkg.version};});}};}cov_18278jgu7v.s[36]++;exports.npmBuilderOptionsFromFile=npmBuilderOptionsFromFile;cov_18278jgu7v.s[37]++;exports.NpmPreparations=[npmInstallPreparation,npmVersionPreparation,npmCompilePreparation];function npmInstallPreparation(p,rwlc){cov_18278jgu7v.f[14]++;cov_18278jgu7v.s[38]++;return __awaiter(this,void 0,void 0,function*(){cov_18278jgu7v.f[15]++;const hasPackageLock=(cov_18278jgu7v.s[39]++,p.fileExistsSync("package-lock.json"));cov_18278jgu7v.s[40]++;return spawned_1.spawnAndWatch({command:"npm",args:[hasPackageLock?(cov_18278jgu7v.b[6][0]++,"ci"):(cov_18278jgu7v.b[6][1]++,"install")]},Object.assign({cwd:p.baseDir},exports.DevelopmentEnvOptions),rwlc.progressLog,{errorFinder:code=>{cov_18278jgu7v.f[16]++;cov_18278jgu7v.s[41]++;return code!=null;}});});}cov_18278jgu7v.s[42]++;exports.npmInstallPreparation=npmInstallPreparation;function npmVersionPreparation(p,rwlc){cov_18278jgu7v.f[17]++;cov_18278jgu7v.s[43]++;return __awaiter(this,void 0,void 0,function*(){cov_18278jgu7v.f[18]++;const commit=(cov_18278jgu7v.s[44]++,rwlc.status.commit);const version=(cov_18278jgu7v.s[45]++,yield projectVersioner_1.readSdmVersion(commit.repo.owner,commit.repo.name,commit.repo.org.provider.providerId,commit.sha,executeBuild_1.branchFromCommit(commit),rwlc.context));cov_18278jgu7v.s[46]++;return spawned_1.spawnAndWatch({command:"npm",args:["--no-git-tag-version","version",version]},{cwd:p.baseDir},rwlc.progressLog,{errorFinder:code=>{cov_18278jgu7v.f[19]++;cov_18278jgu7v.s[47]++;return code!==0;}});});}cov_18278jgu7v.s[48]++;exports.npmVersionPreparation=npmVersionPreparation;function npmCompilePreparation(p,rwlc){cov_18278jgu7v.f[20]++;cov_18278jgu7v.s[49]++;return __awaiter(this,void 0,void 0,function*(){cov_18278jgu7v.f[21]++;cov_18278jgu7v.s[50]++;return spawned_1.spawnAndWatch({command:"npm",args:["run","compile"]},Object.assign({cwd:p.baseDir},exports.DevelopmentEnvOptions),rwlc.progressLog,{errorFinder:code=>{cov_18278jgu7v.f[22]++;cov_18278jgu7v.s[51]++;return code!=null;}});});}cov_18278jgu7v.s[52]++;exports.npmCompilePreparation=npmCompilePreparation;//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL2NvbW1vbi9kZWxpdmVyeS9idWlsZC9sb2NhbC9ucG0vbnBtQnVpbGRlci50cyIsInNvdXJjZXMiOlsiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL2NvbW1vbi9kZWxpdmVyeS9idWlsZC9sb2NhbC9ucG0vbnBtQnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7O0dBY0c7Ozs7Ozs7Ozs7QUFNSCw4REFJMEM7QUFJMUMscURBQXNEO0FBQ3RELDBEQUFxRDtBQUNyRCxrREFBb0U7QUFDcEUsMkRBQXdEO0FBRXhEOztHQUVHO0FBQ1UsUUFBQSxxQkFBcUIsR0FBRztJQUNqQyxHQUFHLG9CQUNJLE9BQU8sQ0FBQyxHQUFHLElBQ2QsUUFBUSxFQUFFLGFBQWEsR0FDMUI7Q0FDSixDQUFDO0FBRVcsUUFBQSxPQUFPLEdBQWlCLHdCQUFjLENBQUMsUUFBUSxFQUFFLDZCQUFxQixDQUFDLENBQUM7QUFFckYscUJBQTRCLGFBQTRCLEVBQUUsR0FBRyxRQUFrQjtJQUMzRSxPQUFPLElBQUksMkJBQVksQ0FBQztRQUNwQixhQUFhO1FBQ2IsT0FBTyxFQUFFLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyx3QkFBYyxDQUFDLEdBQUcsRUFBRSw2QkFBcUIsQ0FBQyxDQUFDLENBQUM7S0FDOUYsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQUxELGtDQUtDO0FBRUQsMkJBQTJCLFFBQXdCO0lBQy9DLE9BQU87UUFDSCxJQUFJLEVBQUUsWUFBWTtRQUNsQixRQUFRO1FBQ1IsV0FBVyxFQUFFLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUM3QixPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFD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QUM7WUFDYixPQUFPLEVBQUUsS0FBSztZQUNkLElBQUksRUFBRSxDQUFDLHNCQUFzQixFQUFFLFNBQVMsRUFBRSxPQUFPLENBQUM7U0FDckQsRUFDRDtZQUNJLEdBQUcsRUFBRSxDQUFDLENBQUMsT0FBTztTQUNqQixFQUNELElBQUksQ0FBQyxXQUFXLEVBQ2hCO1lBQ0ksV0FBVyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxLQUFLLENBQUM7U0FDbEMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQztDQUFBO0FBcEJELHNEQW9CQztBQUVELCtCQUE0QyxDQUFhLEVBQUUsSUFBdUI7O1FBQzlFLE9BQU8sdUJBQWEsQ0FBQztZQUNqQixPQUFPLEVBQUUsS0FBSztZQUNkLElBQUksRUFBRSxDQUFDLEtBQUssRUFBRSxTQUFTLENBQUM7U0FDM0Isa0JBQ08sR0FBRyxFQUFFLENBQUMsQ0FBQyxPQUFPLElBQ1gsNkJBQXFCLEdBQ3pCLElBQUksQ0FBQyxXQUFXLEVBQ25CO1lBQ0ksV0FBVyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxJQUFJLElBQUk7U0FDcEMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQztDQUFBO0FBWEQsc0RBV0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IMKpIDIwMTggQXRvbWlzdCwgSW5jLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBSZW1vdGVSZXBvUmVmIH0gZnJvbSBcIkBhdG9taXN0L2F1dG9tYXRpb24tY2xpZW50L29wZXJhdGlvbnMvY29tbW9uL1JlcG9JZFwiO1xuaW1wb3J0IHsgR2l0UHJvamVjdCB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudC9wcm9qZWN0L2dpdC9HaXRQcm9qZWN0XCI7XG5pbXBvcnQgeyBQcm9qZWN0IH0gZnJvbSBcIkBhdG9taXN0L2F1dG9tYXRpb24tY2xpZW50L3Byb2plY3QvUHJvamVjdFwiO1xuaW1wb3J0IHsgQXBwSW5mbyB9IGZyb20gXCIuLi8uLi8uLi8uLi8uLi9zcGkvZGVwbG95L0RlcGxveW1lbnRcIjtcbmltcG9ydCB7XG4gICAgYXNTcGF3bkNvbW1hbmQsXG4gICAgc3Bhd25BbmRXYXRjaCxcbiAgICBTcGF3bkNvbW1hbmQsXG59IGZyb20gXCIuLi8uLi8uLi8uLi8uLi91dGlsL21pc2Mvc3Bhd25lZFwiO1xuaW1wb3J0IHsgUHJvamVjdExvYWRlciB9IGZyb20gXCIuLi8uLi8uLi8uLi9yZXBvL1Byb2plY3RMb2FkZXJcIjtcbmltcG9ydCB7IEV4ZWN1dGVHb2FsUmVzdWx0IH0gZnJvbSBcIi4uLy4uLy4uL2dvYWxzL0V4ZWN1dGVHb2FsUmVzdWx0XCI7XG5pbXBvcnQgeyBSdW5XaXRoTG9nQ29udGV4dCB9IGZyb20gXCIuLi8uLi8uLi9nb2Fscy9zdXBwb3J0L3JlcG9ydEdvYWxFcnJvclwiO1xuaW1wb3J0IHsgYnJhbmNoRnJvbUNvbW1pdCB9IGZyb20gXCIuLi8uLi9leGVjdXRlQnVpbGRcIjtcbmltcG9ydCB7IHJlYWRTZG1WZXJzaW9uIH0gZnJvbSBcIi4uL3Byb2plY3RWZXJzaW9uZXJcIjtcbmltcG9ydCB7IFNwYXduQnVpbGRlciwgU3Bhd25CdWlsZGVyT3B0aW9ucyB9IGZyb20gXCIuLi9TcGF3bkJ1aWxkZXJcIjtcbmltcG9ydCB7IE5wbUxvZ0ludGVycHJldGVyIH0gZnJvbSBcIi4vbnBtTG9nSW50ZXJwcmV0ZXJcIjtcblxuLyoqXG4gKiBPcHRpb25zIHRvIHVzZSB3aGVuIHJ1bm5pbmcgbm9kZSBjb21tYW5kcyBsaWtlIG5wbSBydW4gY29tcGlsZSB0aGF0IHJlcXVpcmUgZGV2IGRlcGVuZGVuY2llcyB0byBiZSBpbnN0YWxsZWRcbiAqL1xuZXhwb3J0IGNvbnN0IERldmVsb3BtZW50RW52T3B0aW9ucyA9IHtcbiAgICBlbnY6IHtcbiAgICAgICAgLi4ucHJvY2Vzcy5lbnYsXG4gICAgICAgIE5PREVfRU5WOiBcImRldmVsb3BtZW50XCIsXG4gICAgfSxcbn07XG5cbmV4cG9ydCBjb25zdCBJbnN0YWxsOiBTcGF3bkNvbW1hbmQgPSBhc1NwYXduQ29tbWFuZChcIm5wbSBjaVwiLCBEZXZlbG9wbWVudEVudk9wdGlvbnMpO1xuXG5leHBvcnQgZnVuY3Rpb24gbm9kZUJ1aWxkZXIocHJvamVjdExvYWRlcjogUHJvamVjdExvYWRlciwgLi4uY29tbWFuZHM6IHN0cmluZ1tdKSB7XG4gICAgcmV0dXJuIG5ldyBTcGF3bkJ1aWxkZXIoe1xuICAgICAgICBwcm9qZWN0TG9hZGVyLFxuICAgICAgICBvcHRpb25zOiBucG1CdWlsZGVyT3B0aW9ucyhjb21tYW5kcy5tYXAoY21kID0+IGFzU3Bhd25Db21tYW5kKGNtZCwgRGV2ZWxvcG1lbnRFbnZPcHRpb25zKSkpLFxuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBucG1CdWlsZGVyT3B0aW9ucyhjb21tYW5kczogU3Bhd25Db21tYW5kW10pOiBTcGF3bkJ1aWxkZXJPcHRpb25zIHtcbiAgICByZXR1cm4ge1xuICAgICAgICBuYW1lOiBcIk5wbUJ1aWxkZXJcIixcbiAgICAgICAgY29tbWFuZHMsXG4gICAgICAgIGVycm9yRmluZGVyOiAoY29kZSwgc2lnbmFsLCBsKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbC5sb2cuc3RhcnRzV2l0aChcIltlcnJvcl1cIikgfHwgbC5sb2cuaW5jbHVkZXMoXCJFUlIhXCIpO1xuICAgICAgICB9LFxuICAgICAgICBsb2dJbnRlcnByZXRlcjogTnBtTG9nSW50ZXJwcmV0ZXIsXG4gICAgICAgIGFzeW5jIHByb2plY3RUb0FwcEluZm8ocDogUHJvamVjdCk6IFByb21pc2U8QXBwSW5mbz4ge1xuICAgICAgICAgICAgY29uc3QgcGFja2FnZUpzb24gPSBhd2FpdCBwLmZpbmRGaWxlKFwicGFja2FnZS5qc29uXCIpO1xuICAgICAgICAgICAgY29uc3QgY29udGVudCA9IGF3YWl0IHBhY2thZ2VKc29uLmdldENvbnRlbnQoKTtcbiAgICAgICAgICAgIGNvbnN0IHBrZyA9IEpTT04ucGFyc2UoY29udGVudCk7XG4gICAgICAgICAgICByZXR1cm4geyBpZDogcC5pZCBhcyBSZW1vdGVSZXBvUmVmLCBuYW1lOiBwa2cubmFtZSwgdmVyc2lvbjogcGtnLnZlcnNpb24gfTtcbiAgICAgICAgfSxcbiAgICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbnBtQnVpbGRlck9wdGlvbnNGcm9tRmlsZShjb21tYW5kRmlsZTogc3RyaW5nKTogU3Bhd25CdWlsZGVyT3B0aW9ucyB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgbmFtZTogXCJOcG1CdWlsZGVyXCIsXG4gICAgICAgIGNvbW1hbmRGaWxlLFxuICAgICAgICBlcnJvckZpbmRlcjogKGNvZGUsIHNpZ25hbCwgbCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGwubG9nLnN0YXJ0c1dpdGgoXCJbZXJyb3JdXCIpIHx8IGwubG9nLmluY2x1ZGVzKFwiRVJSIVwiKTtcbiAgICAgICAgfSxcbiAgICAgICAgbG9nSW50ZXJwcmV0ZXI6IE5wbUxvZ0ludGVycHJldGVyLFxuICAgICAgICBhc3luYyBwcm9qZWN0VG9BcHBJbmZvKHA6IFByb2plY3QpOiBQcm9taXNlPEFwcEluZm8+IHtcbiAgICAgICAgICAgIGNvbnN0IHBhY2thZ2VKc29uID0gYXdhaXQgcC5maW5kRmlsZShcInBhY2thZ2UuanNvblwiKTtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCBwYWNrYWdlSnNvbi5nZXRDb250ZW50KCk7XG4gICAgICAgICAgICBjb25zdCBwa2cgPSBKU09OLnBhcnNlKGNvbnRlbnQpO1xuICAgICAgICAgICAgcmV0dXJuIHsgaWQ6IHAuaWQgYXMgUmVtb3RlUmVwb1JlZiwgbmFtZTogcGtnLm5hbWUsIHZlcnNpb246IHBrZy52ZXJzaW9uIH07XG4gICAgICAgIH0sXG4gICAgfTtcbn1cblxuZXhwb3J0IGNvbnN0IE5wbVByZXBhcmF0aW9ucyA9IFtucG1JbnN0YWxsUHJlcGFyYXRpb24sIG5wbVZlcnNpb25QcmVwYXJhdGlvbiwgbnBtQ29tcGlsZVByZXBhcmF0aW9uXTtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG5wbUluc3RhbGxQcmVwYXJhdGlvbihwOiBHaXRQcm9qZWN0LCByd2xjOiBSdW5XaXRoTG9nQ29udGV4dCk6IFByb21pc2U8RXhlY3V0ZUdvYWxSZXN1bHQ+IHtcbiAgICBjb25zdCBoYXNQYWNrYWdlTG9jayA9IHAuZmlsZUV4aXN0c1N5bmMoXCJwYWNrYWdlLWxvY2suanNvblwiKTtcbiAgICByZXR1cm4gc3Bhd25BbmRXYXRjaCh7XG4gICAgICAgIGNvbW1hbmQ6IFwibnBtXCIsXG4gICAgICAgIGFyZ3M6IFtoYXNQYWNrYWdlTG9jayA/IFwiY2lcIiA6IFwiaW5zdGFsbFwiXSxcbiAgICB9LCB7XG4gICAgICAgICAgICBjd2Q6IHAuYmFzZURpcixcbiAgICAgICAgICAgIC4uLkRldmVsb3BtZW50RW52T3B0aW9ucyxcbiAgICAgICAgfSwgcndsYy5wcm9ncmVzc0xvZyxcbiAgICAgICAge1xuICAgICAgICAgICAgZXJyb3JGaW5kZXI6IGNvZGUgPT4gY29kZSAhPSBudWxsLFxuICAgICAgICB9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG5wbVZlcnNpb25QcmVwYXJhdGlvbihwOiBHaXRQcm9qZWN0LCByd2xjOiBSdW5XaXRoTG9nQ29udGV4dCk6IFByb21pc2U8RXhlY3V0ZUdvYWxSZXN1bHQ+IHtcbiAgICBjb25zdCBjb21taXQgPSByd2xjLnN0YXR1cy5jb21taXQ7XG4gICAgY29uc3QgdmVyc2lvbiA9IGF3YWl0IHJlYWRTZG1WZXJzaW9uKFxuICAgICAgICBjb21taXQucmVwby5vd25lcixcbiAgICAgICAgY29tbWl0LnJlcG8ubmFtZSxcbiAgICAgICAgY29tbWl0LnJlcG8ub3JnLnByb3ZpZGVyLnByb3ZpZGVySWQsXG4gICAgICAgIGNvbW1pdC5zaGEsXG4gICAgICAgIGJyYW5jaEZyb21Db21taXQoY29tbWl0KSxcbiAgICAgICAgcndsYy5jb250ZXh0KTtcbiAgICByZXR1cm4gc3Bhd25BbmRXYXRjaCh7XG4gICAgICAgICAgICBjb21tYW5kOiBcIm5wbVwiLFxuICAgICAgICAgICAgYXJnczogW1wiLS1uby1naXQtdGFnLXZlcnNpb25cIiwgXCJ2ZXJzaW9uXCIsIHZlcnNpb25dLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBjd2Q6IHAuYmFzZURpcixcbiAgICAgICAgfSxcbiAgICAgICAgcndsYy5wcm9ncmVzc0xvZyxcbiAgICAgICAge1xuICAgICAgICAgICAgZXJyb3JGaW5kZXI6IGNvZGUgPT4gY29kZSAhPT0gMCxcbiAgICAgICAgfSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBucG1Db21waWxlUHJlcGFyYXRpb24ocDogR2l0UHJvamVjdCwgcndsYzogUnVuV2l0aExvZ0NvbnRleHQpOiBQcm9taXNlPEV4ZWN1dGVHb2FsUmVzdWx0PiB7XG4gICAgcmV0dXJuIHNwYXduQW5kV2F0Y2goe1xuICAgICAgICBjb21tYW5kOiBcIm5wbVwiLFxuICAgICAgICBhcmdzOiBbXCJydW5cIiwgXCJjb21waWxlXCJdLFxuICAgIH0sIHtcbiAgICAgICAgICAgIGN3ZDogcC5iYXNlRGlyLFxuICAgICAgICAgICAgLi4uRGV2ZWxvcG1lbnRFbnZPcHRpb25zLFxuICAgICAgICB9LCByd2xjLnByb2dyZXNzTG9nLFxuICAgICAgICB7XG4gICAgICAgICAgICBlcnJvckZpbmRlcjogY29kZSA9PiBjb2RlICE9IG51bGwsXG4gICAgICAgIH0pO1xufVxuIl19