{"version":3,"file":"/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/delivery/code/PushReactionRegistration.ts","sources":["/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/delivery/code/PushReactionRegistration.ts"],"names":[],"mappings":";AAAA;;;;;;;;;;;;;;GAcG;;;;;;;;;;AAKH;;;;GAIG;AACH,IAAY,oBAYX;AAZD,WAAY,oBAAoB;IAE5B;;;OAGG;IACH,0CAAkB,CAAA;IAElB;;OAEG;IACH,oEAA4C,CAAA;AAChD,CAAC,EAZW,oBAAoB,GAApB,4BAAoB,KAApB,4BAAoB,QAY/B;AAiCD,oCAAoC,CAAgC;IAChE,MAAM,KAAK,GAAG,CAA0B,CAAC;IACzC,OAAO,CAAC,CAAC,KAAK,CAAC,IAAI,IAAI,CAAC,CAAC,KAAK,CAAC,MAAM,CAAC;AAC1C,CAAC;AAED;;;;GAIG;AACH,oCAA2C,GAAkC;IACzE,OAAO,0BAA0B,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;QAC3C,IAAI,EAAE,mBAAmB;QACzB,MAAM,EAAE,GAAG;KACd,CAAC;AACN,CAAC;AALD,gEAKC;AAaD;;;GAGG;AACH,6BAAuC,aAAiD,EACjD,GAAiC;IACpE,OAAO,OAAO,CAAC,GAAG,CACd,aAAa,CAAC,GAAG,CAAC,CAAM,CAAC,EAAC,EAAE,gDAAC,OAAA,CAAC,CAAC,CAAC,CAAC,QAAQ,KAAI,MAAM,CAAC,CAAC,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,CAAA,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAA,GAAA,CAAC,CAAC;SAC5F,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;AAC7C,CAAC;AALD,kDAKC","sourcesContent":["/*\n * Copyright Â© 2018 Atomist, Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { PushImpactListenerInvocation } from \"../../listener/PushImpactListener\";\nimport { PushRegistration } from \"../../listener/PushRegistration\";\n\n/**\n * A code action response that affects delivery:\n * failing the current goal or requiring approval,\n * causing dependent goals to fail or wait.\n */\nexport enum PushReactionResponse {\n\n    /**\n     * Fail execution of the present goalset. Any dependent goals will stop.\n     * Will not stop execution of non-dependent goals.\n     */\n    failGoals = \"fail\",\n\n    /**\n     * Require approval to proceed to dependent goals in the present goalset.\n     */\n    requireApprovalToProceed = \"requireApproval\",\n}\n\n/**\n * Optional PushReactionResponse included in a return value.\n */\nexport interface HasCodeActionResponse {\n\n    /**\n     * Response affecting further execution of the current goalset.\n     */\n    response?: PushReactionResponse;\n}\n\n/**\n * Reaction on a push, with the code available.\n * Can optionally return a response that\n * determines whether to ask for approval or terminate current delivery flow.\n */\nexport type PushReaction<R> = (i: PushImpactListenerInvocation) => Promise<R & HasCodeActionResponse>;\n\n/**\n * Used to register actions on a push that can potentially\n * influence downstream goals. Will be invoked if a PushReactionGoal has\n * been set for the given push.\n * Use ReviewerRegistration if you want to return a structured review.\n */\nexport type PushReactionRegistration<R = any> = PushRegistration<PushReaction<R>>;\n\n/**\n * Something we can register as a push reaction\n */\nexport type PushReactionRegisterable<R = any> = PushReactionRegistration | PushReaction<R>;\n\nfunction isPushReactionRegistration(a: PushReactionRegisterable<any>): a is PushReactionRegistration {\n    const maybe = a as PushRegistration<any>;\n    return !!maybe.name && !!maybe.action;\n}\n\n/**\n * Convert an action function to a PushReaction if necessary\n * @param {PushReactionRegisterable<any>} prr\n * @return {PushReactionRegistration}\n */\nexport function toPushReactionRegistration(prr: PushReactionRegisterable<any>): PushReactionRegistration {\n    return isPushReactionRegistration(prr) ? prr : {\n        name: \"Raw push reaction\",\n        action: prr,\n    };\n}\n\n/**\n * Base options object for registrations that process selective files\n */\nexport interface SelectiveCodeActionOptions {\n\n    /**\n     * Run only on affected files?\n     */\n    considerOnlyChangedFiles: boolean;\n}\n\n/**\n * Compute the relevant actions for this push. Some may be filtered out\n * by their push tests.\n */\nexport function relevantCodeActions<R>(registrations: Array<PushReactionRegistration<R>>,\n                                       pli: PushImpactListenerInvocation): Promise<Array<PushReactionRegistration<R>>> {\n    return Promise.all(\n        registrations.map(async t => (!t.pushTest || await t.pushTest.mapping(pli)) ? t : undefined))\n        .then(elts => elts.filter(x => !!x));\n}\n"]}