"use strict";/*
 * Copyright Â© 2018 Atomist, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var cov_2bftvvt22u=function(){var path="/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/handlers/events/delivery/goals/k8s/launchGoalK8.ts",hash="6233c48df4d05b2a14d92069c1683e5a417c9186",Function=function(){}.constructor,global=new Function('return this')(),gcv="__coverage__",coverageData={path:"/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/handlers/events/delivery/goals/k8s/launchGoalK8.ts",statementMap:{"0":{start:{line:17,column:16},end:{line:24,column:1}},"1":{start:{line:18,column:4},end:{line:23,column:7}},"2":{start:{line:19,column:36},end:{line:19,column:97}},"3":{start:{line:19,column:42},end:{line:19,column:70}},"4":{start:{line:19,column:85},end:{line:19,column:95}},"5":{start:{line:20,column:35},end:{line:20,column:100}},"6":{start:{line:20,column:41},end:{line:20,column:73}},"7":{start:{line:20,column:88},end:{line:20,column:98}},"8":{start:{line:21,column:32},end:{line:21,column:149}},"9":{start:{line:21,column:97},end:{line:21,column:119}},"10":{start:{line:22,column:8},end:{line:22,column:78}},"11":{start:{line:25,column:0},end:{line:25,column:62}},"12":{start:{line:26,column:24},end:{line:26,column:75}},"13":{start:{line:27,column:11},end:{line:27,column:30}},"14":{start:{line:28,column:13},end:{line:28,column:28}},"15":{start:{line:29,column:37},end:{line:29,column:100}},"16":{start:{line:30,column:18},end:{line:30,column:61}},"17":{start:{line:39,column:0},end:{line:90,column:3}},"18":{start:{line:39,column:69},end:{line:90,column:2}},"19":{start:{line:40,column:27},end:{line:40,column:108}},"20":{start:{line:41,column:32},end:{line:41,column:85}},"21":{start:{line:42,column:16},end:{line:42,column:77}},"22":{start:{line:43,column:17},end:{line:48,column:6}},"23":{start:{line:47,column:29},end:{line:47,column:39}},"24":{start:{line:49,column:4},end:{line:51,column:5}},"25":{start:{line:50,column:8},end:{line:50,column:20}},"26":{start:{line:52,column:20},end:{line:52,column:39}},"27":{start:{line:53,column:26},end:{line:53,column:64}},"28":{start:{line:54,column:4},end:{line:54,column:47}},"29":{start:{line:55,column:4},end:{line:56,column:101}},"30":{start:{line:57,column:4},end:{line:57,column:53}},"31":{start:{line:58,column:4},end:{line:58,column:55}},"32":{start:{line:59,column:4},end:{line:59,column:74}},"33":{start:{line:60,column:4},end:{line:78,column:7}},"34":{start:{line:79,column:21},end:{line:79,column:49}},"35":{start:{line:80,column:4},end:{line:80,column:67}},"36":{start:{line:82,column:4},end:{line:87,column:7}},"37":{start:{line:86,column:29},end:{line:86,column:39}},"38":{start:{line:91,column:16},end:{line:105,column:4}},"39":{start:{line:114,column:4},end:{line:121,column:7}},"40":{start:{line:115,column:31},end:{line:115,column:77}},"41":{start:{line:116,column:28},end:{line:116,column:71}},"42":{start:{line:117,column:8},end:{line:120,column:18}},"43":{start:{line:123,column:0},end:{line:123,column:52}},"44":{start:{line:125,column:4},end:{line:133,column:7}},"45":{start:{line:126,column:25},end:{line:126,column:66}},"46":{start:{line:127,column:8},end:{line:132,column:9}},"47":{start:{line:128,column:12},end:{line:128,column:60}},"48":{start:{line:131,column:12},end:{line:131,column:29}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:17,column:44},end:{line:17,column:45}},loc:{start:{line:17,column:89},end:{line:24,column:1}},line:17},"1":{name:"(anonymous_1)",decl:{start:{line:18,column:36},end:{line:18,column:37}},loc:{start:{line:18,column:63},end:{line:23,column:5}},line:18},"2":{name:"fulfilled",decl:{start:{line:19,column:17},end:{line:19,column:26}},loc:{start:{line:19,column:34},end:{line:19,column:99}},line:19},"3":{name:"rejected",decl:{start:{line:20,column:17},end:{line:20,column:25}},loc:{start:{line:20,column:33},end:{line:20,column:102}},line:20},"4":{name:"step",decl:{start:{line:21,column:17},end:{line:21,column:21}},loc:{start:{line:21,column:30},end:{line:21,column:151}},line:21},"5":{name:"(anonymous_5)",decl:{start:{line:21,column:76},end:{line:21,column:77}},loc:{start:{line:21,column:95},end:{line:21,column:121}},line:21},"6":{name:"(anonymous_6)",decl:{start:{line:39,column:41},end:{line:39,column:42}},loc:{start:{line:39,column:69},end:{line:90,column:2}},line:39},"7":{name:"(anonymous_7)",decl:{start:{line:39,column:101},end:{line:39,column:102}},loc:{start:{line:39,column:114},end:{line:90,column:1}},line:39},"8":{name:"(anonymous_8)",decl:{start:{line:47,column:21},end:{line:47,column:22}},loc:{start:{line:47,column:29},end:{line:47,column:39}},line:47},"9":{name:"(anonymous_9)",decl:{start:{line:86,column:21},end:{line:86,column:22}},loc:{start:{line:86,column:29},end:{line:86,column:39}},line:86},"10":{name:"createKubernetesData",decl:{start:{line:113,column:9},end:{line:113,column:29}},loc:{start:{line:113,column:48},end:{line:122,column:1}},line:113},"11":{name:"(anonymous_11)",decl:{start:{line:114,column:43},end:{line:114,column:44}},loc:{start:{line:114,column:56},end:{line:121,column:5}},line:114},"12":{name:"readKubernetesSpec",decl:{start:{line:124,column:9},end:{line:124,column:27}},loc:{start:{line:124,column:37},end:{line:134,column:1}},line:124},"13":{name:"(anonymous_13)",decl:{start:{line:125,column:43},end:{line:125,column:44}},loc:{start:{line:125,column:56},end:{line:133,column:5}},line:125}},branchMap:{"0":{loc:{start:{line:17,column:16},end:{line:24,column:1}},type:"binary-expr",locations:[{start:{line:17,column:17},end:{line:17,column:21}},{start:{line:17,column:25},end:{line:17,column:39}},{start:{line:17,column:44},end:{line:24,column:1}}],line:17},"1":{loc:{start:{line:18,column:16},end:{line:18,column:34}},type:"binary-expr",locations:[{start:{line:18,column:16},end:{line:18,column:17}},{start:{line:18,column:22},end:{line:18,column:33}}],line:18},"2":{loc:{start:{line:21,column:32},end:{line:21,column:148}},type:"cond-expr",locations:[{start:{line:21,column:46},end:{line:21,column:67}},{start:{line:21,column:70},end:{line:21,column:148}}],line:21},"3":{loc:{start:{line:22,column:51},end:{line:22,column:67}},type:"binary-expr",locations:[{start:{line:22,column:51},end:{line:22,column:61}},{start:{line:22,column:65},end:{line:22,column:67}}],line:22},"4":{loc:{start:{line:40,column:27},end:{line:40,column:108}},type:"binary-expr",locations:[{start:{line:40,column:27},end:{line:40,column:62}},{start:{line:40,column:66},end:{line:40,column:108}}],line:40},"5":{loc:{start:{line:41,column:32},end:{line:41,column:85}},type:"binary-expr",locations:[{start:{line:41,column:32},end:{line:41,column:72}},{start:{line:41,column:76},end:{line:41,column:85}}],line:41},"6":{loc:{start:{line:49,column:4},end:{line:51,column:5}},type:"if",locations:[{start:{line:49,column:4},end:{line:51,column:5}},{start:{line:49,column:4},end:{line:51,column:5}}],line:49},"7":{loc:{start:{line:127,column:8},end:{line:132,column:9}},type:"if",locations:[{start:{line:127,column:8},end:{line:132,column:9}},{start:{line:127,column:8},end:{line:132,column:9}}],line:127}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0},b:{"0":[0,0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0,0]},_coverageSchema:"332fd63041d2c1bcb487cc26dd0d5f7d97098a6c"},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var __awaiter=(cov_2bftvvt22u.s[0]++,(cov_2bftvvt22u.b[0][0]++,this)&&(cov_2bftvvt22u.b[0][1]++,this.__awaiter)||(cov_2bftvvt22u.b[0][2]++,function(thisArg,_arguments,P,generator){cov_2bftvvt22u.f[0]++;cov_2bftvvt22u.s[1]++;return new((cov_2bftvvt22u.b[1][0]++,P)||(cov_2bftvvt22u.b[1][1]++,P=Promise))(function(resolve,reject){cov_2bftvvt22u.f[1]++;function fulfilled(value){cov_2bftvvt22u.f[2]++;cov_2bftvvt22u.s[2]++;try{cov_2bftvvt22u.s[3]++;step(generator.next(value));}catch(e){cov_2bftvvt22u.s[4]++;reject(e);}}function rejected(value){cov_2bftvvt22u.f[3]++;cov_2bftvvt22u.s[5]++;try{cov_2bftvvt22u.s[6]++;step(generator["throw"](value));}catch(e){cov_2bftvvt22u.s[7]++;reject(e);}}function step(result){cov_2bftvvt22u.f[4]++;cov_2bftvvt22u.s[8]++;result.done?(cov_2bftvvt22u.b[2][0]++,resolve(result.value)):(cov_2bftvvt22u.b[2][1]++,new P(function(resolve){cov_2bftvvt22u.f[5]++;cov_2bftvvt22u.s[9]++;resolve(result.value);}).then(fulfilled,rejected));}cov_2bftvvt22u.s[10]++;step((generator=generator.apply(thisArg,(cov_2bftvvt22u.b[3][0]++,_arguments)||(cov_2bftvvt22u.b[3][1]++,[]))).next());});}));cov_2bftvvt22u.s[11]++;Object.defineProperty(exports,"__esModule",{value:true});const configuration_1=(cov_2bftvvt22u.s[12]++,require("@atomist/automation-client/configuration"));const fs=(cov_2bftvvt22u.s[13]++,require("fs-extra"));const path=(cov_2bftvvt22u.s[14]++,require("path"));const StringCapturingProgressLog_1=(cov_2bftvvt22u.s[15]++,require("../../../../../common/log/StringCapturingProgressLog"));const spawned_1=(cov_2bftvvt22u.s[16]++,require("../../../../../util/misc/spawned"));/**
 * Launch a goal as a kubernetes job
 * @param {OnAnyRequestedSdmGoal.SdmGoal} goal
 * @param {HandlerContext} ctx
 * @param {ProgressLog} progressLog
 * @returns {Promise<HandlerResult>}
 * @constructor
 */cov_2bftvvt22u.s[17]++;exports.KubernetesIsolatedGoalLauncher=(goal,ctx,progressLog)=>{cov_2bftvvt22u.f[6]++;cov_2bftvvt22u.s[18]++;return __awaiter(this,void 0,void 0,function*(){cov_2bftvvt22u.f[7]++;const deploymentName=(cov_2bftvvt22u.s[19]++,(cov_2bftvvt22u.b[4][0]++,process.env.ATOMIST_DEPLOYMENT_NAME)||(cov_2bftvvt22u.b[4][1]++,configuration_1.configurationValue("name")));const deploymentNamespace=(cov_2bftvvt22u.s[20]++,(cov_2bftvvt22u.b[5][0]++,process.env.ATOMIST_DEPLOYMENT_NAMESPACE)||(cov_2bftvvt22u.b[5][1]++,"default"));const log=(cov_2bftvvt22u.s[21]++,new StringCapturingProgressLog_1.StringCapturingProgressLog());const spec=(cov_2bftvvt22u.s[22]++,yield spawned_1.spawnAndWatch({command:"kubectl",args:["get","deployment",deploymentName,"-n",deploymentNamespace,"-o","json"]},{},log,{errorFinder:code=>{cov_2bftvvt22u.f[8]++;cov_2bftvvt22u.s[23]++;return code!==0;}}));cov_2bftvvt22u.s[24]++;if(spec.code!==0){cov_2bftvvt22u.b[6][0]++;cov_2bftvvt22u.s[25]++;return spec;}else{cov_2bftvvt22u.b[6][1]++;}const jobSpec=(cov_2bftvvt22u.s[26]++,JSON.parse(JobSpec));const containerSpec=(cov_2bftvvt22u.s[27]++,JSON.parse(log.log).spec.template.spec);cov_2bftvvt22u.s[28]++;jobSpec.spec.template.spec=containerSpec;cov_2bftvvt22u.s[29]++;jobSpec.metadata.name=`${deploymentName}-job-${goal.goalSetId.slice(0,7)}-${goal.uniqueName.toLocaleLowerCase()}`;cov_2bftvvt22u.s[30]++;jobSpec.metadata.namespace=deploymentNamespace;cov_2bftvvt22u.s[31]++;jobSpec.spec.template.spec.restartPolicy="Never";cov_2bftvvt22u.s[32]++;jobSpec.spec.template.spec.containers[0].name=jobSpec.metadata.name;cov_2bftvvt22u.s[33]++;jobSpec.spec.template.spec.containers[0].env.push({name:"ATOMIST_JOB_NAME",value:jobSpec.metadata.name},{name:"ATOMIST_GOAL_TEAM",value:ctx.teamId},{name:"ATOMIST_GOAL_TEAM_NAME",value:ctx.context.teamName},{name:"ATOMIST_GOAL_ID",value:goal.id},{name:"ATOMIST_CORRELATION_ID",value:ctx.correlationId},{name:"ATOMIST_ISOLATED_GOAL",value:"true"});const tempfile=(cov_2bftvvt22u.s[34]++,require("tempfile")(".json"));cov_2bftvvt22u.s[35]++;yield fs.writeFile(tempfile,JSON.stringify(jobSpec,null,2));// TODO CD the following code needs to be replaced with proper job scheduling via k8-automation
cov_2bftvvt22u.s[36]++;return spawned_1.spawnAndWatch({command:"kubectl",args:["apply","-f",tempfile]},{},progressLog,{errorFinder:code=>{cov_2bftvvt22u.f[9]++;cov_2bftvvt22u.s[37]++;return code!==0;}});// query kube to make sure the job got scheduled
// kubectl get job <jobname> -o json
});};const JobSpec=(cov_2bftvvt22u.s[38]++,`{
    "kind" : "Job",
    "apiVersion" : "batch/v1",
    "metadata" : {
      "name" : "sample-sdm-job",
      "namespace" : "default"
    },
    "spec" : {
      "template" : {
        "spec" : {
          "containers" : []
        }
      }
    }
  }`);/**
 * Sets kubernetes deployment specific data to an SdmGoal
 * @param {SdmGoal} goal
 * @param {KubernetesOptions} options
 * @param {GitProject} p
 * @returns {Promise<SdmGoal>}
 */function createKubernetesData(goal,options,p){cov_2bftvvt22u.f[10]++;cov_2bftvvt22u.s[39]++;return __awaiter(this,void 0,void 0,function*(){cov_2bftvvt22u.f[11]++;const deploymentSpec=(cov_2bftvvt22u.s[40]++,yield readKubernetesSpec(p,"deployment.json"));const serviceSpec=(cov_2bftvvt22u.s[41]++,yield readKubernetesSpec(p,"service.json"));cov_2bftvvt22u.s[42]++;return Object.assign({},goal,{data:JSON.stringify({kubernetes:Object.assign({},options,{deploymentSpec,serviceSpec})})});});}cov_2bftvvt22u.s[43]++;exports.createKubernetesData=createKubernetesData;function readKubernetesSpec(p,name){cov_2bftvvt22u.f[12]++;cov_2bftvvt22u.s[44]++;return __awaiter(this,void 0,void 0,function*(){cov_2bftvvt22u.f[13]++;const specPath=(cov_2bftvvt22u.s[45]++,path.join(".atomist","kubernetes",name));cov_2bftvvt22u.s[46]++;if(p.fileExistsSync(specPath)){cov_2bftvvt22u.b[7][0]++;cov_2bftvvt22u.s[47]++;return(yield p.getFile(specPath)).getContent();}else{cov_2bftvvt22u.b[7][1]++;cov_2bftvvt22u.s[48]++;return undefined;}});}//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL2hhbmRsZXJzL2V2ZW50cy9kZWxpdmVyeS9nb2Fscy9rOHMvbGF1bmNoR29hbEs4LnRzIiwic291cmNlcyI6WyIvVXNlcnMvcm9kam9obnNvbi9zZm9yemFuZG8tZGV2L2lkZWEtcHJvamVjdHMvbXktZmxvdy9zcmMvaGFuZGxlcnMvZXZlbnRzL2RlbGl2ZXJ5L2dvYWxzL2s4cy9sYXVuY2hHb2FsSzgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7OztHQWNHOzs7Ozs7Ozs7O0FBT0gsNEVBQThFO0FBRTlFLCtCQUErQjtBQUMvQiw2QkFBNkI7QUFDN0IscUdBQWtHO0FBTWxHLDhEQUFpRTtBQUVqRTs7Ozs7OztHQU9HO0FBQ1UsUUFBQSw4QkFBOEIsR0FBRyxDQUFPLElBQW1DLEVBQ25DLEdBQW1CLEVBQ25CLFdBQXdCLEVBQTBCLEVBQUU7SUFDckcsTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsSUFBSSxrQ0FBa0IsQ0FBUyxNQUFNLENBQUMsQ0FBQztJQUNqRyxNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsNEJBQTRCLElBQUksU0FBUyxDQUFDO0lBRWxGLE1BQU0sR0FBRyxHQUFHLElBQUksdURBQTBCLEVBQUUsQ0FBQztJQUU3QyxNQUFNLElBQUksR0FBRyxNQUFNLHVCQUFhLENBQUM7UUFDekIsT0FBTyxFQUFFLFNBQVM7UUFDbEIsSUFBSSxFQUFFLENBQUMsS0FBSyxFQUFFLFlBQVksRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLG1CQUFtQixFQUFFLElBQUksRUFBRSxNQUFNLENBQUM7S0FDdkYsRUFDRCxFQUFFLEVBQ0YsR0FBRyxFQUNIO1FBQ0ksV0FBVyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxLQUFLLENBQUM7S0FDbEMsQ0FDSixDQUFDO0lBRUYs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LElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQ2pCLFVBQVUsb0JBQ0gsT0FBTyxJQUNWLGNBQWM7b0JBQ2QsV0FBVyxHQUNkO2FBQ0osQ0FBQyxJQUNKO0lBQ04sQ0FBQztDQUFBO0FBYkQsb0RBYUM7QUFFRCw0QkFBa0MsQ0FBYSxFQUFFLElBQVk7O1FBQ3pELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLFlBQVksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUMzRCxJQUFJLENBQUMsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDNUIsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLFVBQVUsRUFBRSxDQUFDO1NBQ25EO2FBQU07WUFDSCxPQUFPLFNBQVMsQ0FBQztTQUNwQjtJQUNMLENBQUM7Q0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgwqkgMjAxOCBBdG9taXN0LCBJbmMuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7XG4gICAgQXV0b21hdGlvbkNvbnRleHRBd2FyZSxcbiAgICBIYW5kbGVyQ29udGV4dCxcbiAgICBIYW5kbGVyUmVzdWx0LFxufSBmcm9tIFwiQGF0b21pc3QvYXV0b21hdGlvbi1jbGllbnRcIjtcbmltcG9ydCB7IGNvbmZpZ3VyYXRpb25WYWx1ZSB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudC9jb25maWd1cmF0aW9uXCI7XG5pbXBvcnQgeyBHaXRQcm9qZWN0IH0gZnJvbSBcIkBhdG9taXN0L2F1dG9tYXRpb24tY2xpZW50L3Byb2plY3QvZ2l0L0dpdFByb2plY3RcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmcy1leHRyYVwiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgU3RyaW5nQ2FwdHVyaW5nUHJvZ3Jlc3NMb2cgfSBmcm9tIFwiLi4vLi4vLi4vLi4vLi4vY29tbW9uL2xvZy9TdHJpbmdDYXB0dXJpbmdQcm9ncmVzc0xvZ1wiO1xuaW1wb3J0IHtcbiAgICBPbkFueVJlcXVlc3RlZFNkbUdvYWwsXG4gICAgUHJvZ3Jlc3NMb2csXG59IGZyb20gXCIuLi8uLi8uLi8uLi8uLi9pbmRleFwiO1xuaW1wb3J0IHsgU2RtR29hbCB9IGZyb20gXCIuLi8uLi8uLi8uLi8uLi9pbmdlc3RlcnMvc2RtR29hbEluZ2VzdGVyXCI7XG5pbXBvcnQgeyBzcGF3bkFuZFdhdGNoIH0gZnJvbSBcIi4uLy4uLy4uLy4uLy4uL3V0aWwvbWlzYy9zcGF3bmVkXCI7XG5cbi8qKlxuICogTGF1bmNoIGEgZ29hbCBhcyBhIGt1YmVybmV0ZXMgam9iXG4gKiBAcGFyYW0ge09uQW55UmVxdWVzdGVkU2RtR29hbC5TZG1Hb2FsfSBnb2FsXG4gKiBAcGFyYW0ge0hhbmRsZXJDb250ZXh0fSBjdHhcbiAqIEBwYXJhbSB7UHJvZ3Jlc3NMb2d9IHByb2dyZXNzTG9nXG4gKiBAcmV0dXJucyB7UHJvbWlzZTxIYW5kbGVyUmVzdWx0Pn1cbiAqIEBjb25zdHJ1Y3RvclxuICovXG5leHBvcnQgY29uc3QgS3ViZXJuZXRlc0lzb2xhdGVkR29hbExhdW5jaGVyID0gYXN5bmMgKGdvYWw6IE9uQW55UmVxdWVzdGVkU2RtR29hbC5TZG1Hb2FsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHg6IEhhbmRsZXJDb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzc0xvZzogUHJvZ3Jlc3NMb2cpOiBQcm9taXNlPEhhbmRsZXJSZXN1bHQ+ID0+IHtcbiAgICBjb25zdCBkZXBsb3ltZW50TmFtZSA9IHByb2Nlc3MuZW52LkFUT01JU1RfREVQTE9ZTUVOVF9OQU1FIHx8IGNvbmZpZ3VyYXRpb25WYWx1ZTxzdHJpbmc+KFwibmFtZVwiKTtcbiAgICBjb25zdCBkZXBsb3ltZW50TmFtZXNwYWNlID0gcHJvY2Vzcy5lbnYuQVRPTUlTVF9ERVBMT1lNRU5UX05BTUVTUEFDRSB8fCBcImRlZmF1bHRcIjtcblxuICAgIGNvbnN0IGxvZyA9IG5ldyBTdHJpbmdDYXB0dXJpbmdQcm9ncmVzc0xvZygpO1xuXG4gICAgY29uc3Qgc3BlYyA9IGF3YWl0IHNwYXduQW5kV2F0Y2goe1xuICAgICAgICAgICAgY29tbWFuZDogXCJrdWJlY3RsXCIsXG4gICAgICAgICAgICBhcmdzOiBbXCJnZXRcIiwgXCJkZXBsb3ltZW50XCIsIGRlcGxveW1lbnROYW1lLCBcIi1uXCIsIGRlcGxveW1lbnROYW1lc3BhY2UsIFwiLW9cIiwgXCJqc29uXCJdLFxuICAgICAgICB9LFxuICAgICAgICB7fSxcbiAgICAgICAgbG9nLFxuICAgICAgICB7XG4gICAgICAgICAgICBlcnJvckZpbmRlcjogY29kZSA9PiBjb2RlICE9PSAwLFxuICAgICAgICB9LFxuICAgICk7XG5cbiAgICBpZiAoc3BlYy5jb2RlICE9PSAwKSB7XG4gICAgICAgIHJldHVybiBzcGVjO1xuICAgIH1cblxuICAgIGNvbnN0IGpvYlNwZWMgPSBKU09OLnBhcnNlKEpvYlNwZWMpO1xuICAgIGNvbnN0IGNvbnRhaW5lclNwZWMgPSBKU09OLnBhcnNlKGxvZy5sb2cpLnNwZWMudGVtcGxhdGUuc3BlYztcbiAgICBqb2JTcGVjLnNwZWMudGVtcGxhdGUuc3BlYyA9IGNvbnRhaW5lclNwZWM7XG5cbiAgICBqb2JTcGVjLm1ldGFkYXRhLm5hbWUgPVxuICAgICAgICBgJHtkZXBsb3ltZW50TmFtZX0tam9iLSR7Z29hbC5nb2FsU2V0SWQuc2xpY2UoMCwgNyl9LSR7Z29hbC51bmlxdWVOYW1lLnRvTG9jYWxlTG93ZXJDYXNlKCl9YDtcbiAgICBqb2JTcGVjLm1ldGFkYXRhLm5hbWVzcGFjZSA9IGRlcGxveW1lbnROYW1lc3BhY2U7XG4gICAgam9iU3BlYy5zcGVjLnRlbXBsYXRlLnNwZWMucmVzdGFydFBvbGljeSA9IFwiTmV2ZXJcIjtcbiAgICBqb2JTcGVjLnNwZWMudGVtcGxhdGUuc3BlYy5jb250YWluZXJzWzBdLm5hbWUgPSBqb2JTcGVjLm1ldGFkYXRhLm5hbWU7XG4gICAgam9iU3BlYy5zcGVjLnRlbXBsYXRlLnNwZWMuY29udGFpbmVyc1swXS5lbnYucHVzaCh7XG4gICAgICAgICAgICBuYW1lOiBcIkFUT01JU1RfSk9CX05BTUVcIixcbiAgICAgICAgICAgIHZhbHVlOiBqb2JTcGVjLm1ldGFkYXRhLm5hbWUsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIG5hbWU6IFwiQVRPTUlTVF9HT0FMX1RFQU1cIixcbiAgICAgICAgICAgIHZhbHVlOiBjdHgudGVhbUlkLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBuYW1lOiBcIkFUT01JU1RfR09BTF9URUFNX05BTUVcIixcbiAgICAgICAgICAgIHZhbHVlOiAoY3R4IGFzIGFueSBhcyBBdXRvbWF0aW9uQ29udGV4dEF3YXJlKS5jb250ZXh0LnRlYW1OYW1lLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBuYW1lOiBcIkFUT01JU1RfR09BTF9JRFwiLFxuICAgICAgICAgICAgdmFsdWU6IGdvYWwuaWQsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIG5hbWU6IFwiQVRPTUlTVF9DT1JSRUxBVElPTl9JRFwiLFxuICAgICAgICAgICAgdmFsdWU6IGN0eC5jb3JyZWxhdGlvbklkLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBuYW1lOiBcIkFUT01JU1RfSVNPTEFURURfR09BTFwiLFxuICAgICAgICAgICAgdmFsdWU6IFwidHJ1ZVwiLFxuICAgICAgICB9KTtcblxuICAgIGNvbnN0IHRlbXBmaWxlID0gcmVxdWlyZShcInRlbXBmaWxlXCIpKFwiLmpzb25cIik7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKHRlbXBmaWxlLCBKU09OLnN0cmluZ2lmeShqb2JTcGVjLCBudWxsLCAyKSk7XG5cbiAgICAvLyBUT0RPIENEIHRoZSBmb2xsb3dpbmcgY29kZSBuZWVkcyB0byBiZSByZXBsYWNlZCB3aXRoIHByb3BlciBqb2Igc2NoZWR1bGluZyB2aWEgazgtYXV0b21hdGlvblxuICAgIHJldHVybiBzcGF3bkFuZFdhdGNoKHtcbiAgICAgICAgICAgIGNvbW1hbmQ6IFwia3ViZWN0bFwiLFxuICAgICAgICAgICAgYXJnczogW1wiYXBwbHlcIiwgXCItZlwiLCB0ZW1wZmlsZV0sXG4gICAgICAgIH0sXG4gICAgICAgIHt9LFxuICAgICAgICBwcm9ncmVzc0xvZyxcbiAgICAgICAge1xuICAgICAgICAgICAgZXJyb3JGaW5kZXI6IGNvZGUgPT4gY29kZSAhPT0gMCxcbiAgICAgICAgfSxcbiAgICApO1xuXG4gICAgLy8gcXVlcnkga3ViZSB0byBtYWtlIHN1cmUgdGhlIGpvYiBnb3Qgc2NoZWR1bGVkXG4gICAgLy8ga3ViZWN0bCBnZXQgam9iIDxqb2JuYW1lPiAtbyBqc29uXG59O1xuXG5jb25zdCBKb2JTcGVjID0gYHtcbiAgICBcImtpbmRcIiA6IFwiSm9iXCIsXG4gICAgXCJhcGlWZXJzaW9uXCIgOiBcImJhdGNoL3YxXCIsXG4gICAgXCJtZXRhZGF0YVwiIDoge1xuICAgICAgXCJuYW1lXCIgOiBcInNhbXBsZS1zZG0tam9iXCIsXG4gICAgICBcIm5hbWVzcGFjZVwiIDogXCJkZWZhdWx0XCJcbiAgICB9LFxuICAgIFwic3BlY1wiIDoge1xuICAgICAgXCJ0ZW1wbGF0ZVwiIDoge1xuICAgICAgICBcInNwZWNcIiA6IHtcbiAgICAgICAgICBcImNvbnRhaW5lcnNcIiA6IFtdXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1gO1xuXG5leHBvcnQgaW50ZXJmYWNlIEt1YmVybmV0ZXNPcHRpb25zIHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgZW52aXJvbm1lbnQ6IHN0cmluZztcblxuICAgIG5zPzogc3RyaW5nO1xuICAgIGltYWdlUHVsbFNlY3JldD86IHN0cmluZztcbiAgICBwb3J0PzogbnVtYmVyO1xuICAgIHBhdGg/OiBzdHJpbmc7XG4gICAgaG9zdD86IHN0cmluZztcbiAgICBwcm90b2NvbD86IHN0cmluZztcbiAgICByZXBsaWNhcz86IG51bWJlcjtcbn1cblxuLyoqXG4gKiBTZXRzIGt1YmVybmV0ZXMgZGVwbG95bWVudCBzcGVjaWZpYyBkYXRhIHRvIGFuIFNkbUdvYWxcbiAqIEBwYXJhbSB7U2RtR29hbH0gZ29hbFxuICogQHBhcmFtIHtLdWJlcm5ldGVzT3B0aW9uc30gb3B0aW9uc1xuICogQHBhcmFtIHtHaXRQcm9qZWN0fSBwXG4gKiBAcmV0dXJucyB7UHJvbWlzZTxTZG1Hb2FsPn1cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUt1YmVybmV0ZXNEYXRhKGdvYWw6IFNkbUdvYWwsIG9wdGlvbnM6IEt1YmVybmV0ZXNPcHRpb25zLCBwOiBHaXRQcm9qZWN0KTogUHJvbWlzZTxTZG1Hb2FsPiB7XG4gICAgY29uc3QgZGVwbG95bWVudFNwZWMgPSBhd2FpdCByZWFkS3ViZXJuZXRlc1NwZWMocCwgXCJkZXBsb3ltZW50Lmpzb25cIik7XG4gICAgY29uc3Qgc2VydmljZVNwZWMgPSBhd2FpdCByZWFkS3ViZXJuZXRlc1NwZWMocCwgXCJzZXJ2aWNlLmpzb25cIik7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgLi4uZ29hbCxcbiAgICAgICAgZGF0YTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAga3ViZXJuZXRlczoge1xuICAgICAgICAgICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICAgICAgICAgICAgZGVwbG95bWVudFNwZWMsXG4gICAgICAgICAgICAgICAgc2VydmljZVNwZWMsXG4gICAgICAgICAgICB9LFxuICAgICAgICB9KSxcbiAgICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiByZWFkS3ViZXJuZXRlc1NwZWMocDogR2l0UHJvamVjdCwgbmFtZTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBzcGVjUGF0aCA9IHBhdGguam9pbihcIi5hdG9taXN0XCIsIFwia3ViZXJuZXRlc1wiLCBuYW1lKTtcbiAgICBpZiAocC5maWxlRXhpc3RzU3luYyhzcGVjUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuIChhd2FpdCBwLmdldEZpbGUoc3BlY1BhdGgpKS5nZXRDb250ZW50KCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG59XG4iXX0=