"use strict";/*
 * Copyright Â© 2018 Atomist, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var cov_114ol2ai3k=function(){var path="/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/delivery/goals/support/reportGoalError.ts",hash="1b26885abfa54601a4ced833276fbcb584311489",Function=function(){}.constructor,global=new Function('return this')(),gcv="__coverage__",coverageData={path:"/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/common/delivery/goals/support/reportGoalError.ts",statementMap:{"0":{start:{line:17,column:16},end:{line:24,column:1}},"1":{start:{line:18,column:4},end:{line:23,column:7}},"2":{start:{line:19,column:36},end:{line:19,column:97}},"3":{start:{line:19,column:42},end:{line:19,column:70}},"4":{start:{line:19,column:85},end:{line:19,column:95}},"5":{start:{line:20,column:35},end:{line:20,column:100}},"6":{start:{line:20,column:41},end:{line:20,column:73}},"7":{start:{line:20,column:88},end:{line:20,column:98}},"8":{start:{line:21,column:32},end:{line:21,column:149}},"9":{start:{line:21,column:97},end:{line:21,column:119}},"10":{start:{line:22,column:8},end:{line:22,column:78}},"11":{start:{line:25,column:0},end:{line:25,column:62}},"12":{start:{line:26,column:28},end:{line:26,column:65}},"13":{start:{line:27,column:54},end:{line:27,column:131}},"14":{start:{line:33,column:4},end:{line:49,column:7}},"15":{start:{line:34,column:95},end:{line:34,column:105}},"16":{start:{line:35,column:8},end:{line:35,column:157}},"17":{start:{line:36,column:8},end:{line:36,column:52}},"18":{start:{line:37,column:8},end:{line:37,column:58}},"19":{start:{line:38,column:31},end:{line:38,column:62}},"20":{start:{line:40,column:8},end:{line:48,column:9}},"21":{start:{line:41,column:12},end:{line:43,column:13}},"22":{start:{line:42,column:16},end:{line:42,column:217}},"23":{start:{line:47,column:12},end:{line:47,column:76}},"24":{start:{line:51,column:0},end:{line:51,column:42}},"25":{start:{line:53,column:4},end:{line:71,column:7}},"26":{start:{line:53,column:18},end:{line:71,column:6}},"27":{start:{line:54,column:28},end:{line:56,column:9}},"28":{start:{line:57,column:8},end:{line:69,column:9}},"29":{start:{line:58,column:27},end:{line:58,column:54}},"30":{start:{line:59,column:12},end:{line:68,column:13}},"31":{start:{line:60,column:16},end:{line:60,column:30}},"32":{start:{line:63,column:16},end:{line:67,column:18}},"33":{start:{line:70,column:8},end:{line:70,column:29}},"34":{start:{line:73,column:0},end:{line:73,column:54}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:17,column:44},end:{line:17,column:45}},loc:{start:{line:17,column:89},end:{line:24,column:1}},line:17},"1":{name:"(anonymous_1)",decl:{start:{line:18,column:36},end:{line:18,column:37}},loc:{start:{line:18,column:63},end:{line:23,column:5}},line:18},"2":{name:"fulfilled",decl:{start:{line:19,column:17},end:{line:19,column:26}},loc:{start:{line:19,column:34},end:{line:19,column:99}},line:19},"3":{name:"rejected",decl:{start:{line:20,column:17},end:{line:20,column:25}},loc:{start:{line:20,column:33},end:{line:20,column:102}},line:20},"4":{name:"step",decl:{start:{line:21,column:17},end:{line:21,column:21}},loc:{start:{line:21,column:30},end:{line:21,column:151}},line:21},"5":{name:"(anonymous_5)",decl:{start:{line:21,column:76},end:{line:21,column:77}},loc:{start:{line:21,column:95},end:{line:21,column:121}},line:21},"6":{name:"reportGoalError",decl:{start:{line:32,column:9},end:{line:32,column:24}},loc:{start:{line:32,column:42},end:{line:50,column:1}},line:32},"7":{name:"(anonymous_7)",decl:{start:{line:33,column:43},end:{line:33,column:44}},loc:{start:{line:33,column:56},end:{line:49,column:5}},line:33},"8":{name:"CompositeGoalExecutor",decl:{start:{line:52,column:9},end:{line:52,column:30}},loc:{start:{line:52,column:55},end:{line:72,column:1}},line:52},"9":{name:"(anonymous_9)",decl:{start:{line:53,column:11},end:{line:53,column:12}},loc:{start:{line:53,column:18},end:{line:71,column:6}},line:53},"10":{name:"(anonymous_10)",decl:{start:{line:53,column:50},end:{line:53,column:51}},loc:{start:{line:53,column:63},end:{line:71,column:5}},line:53}},branchMap:{"0":{loc:{start:{line:17,column:16},end:{line:24,column:1}},type:"binary-expr",locations:[{start:{line:17,column:17},end:{line:17,column:21}},{start:{line:17,column:25},end:{line:17,column:39}},{start:{line:17,column:44},end:{line:24,column:1}}],line:17},"1":{loc:{start:{line:18,column:16},end:{line:18,column:34}},type:"binary-expr",locations:[{start:{line:18,column:16},end:{line:18,column:17}},{start:{line:18,column:22},end:{line:18,column:33}}],line:18},"2":{loc:{start:{line:21,column:32},end:{line:21,column:148}},type:"cond-expr",locations:[{start:{line:21,column:46},end:{line:21,column:67}},{start:{line:21,column:70},end:{line:21,column:148}}],line:21},"3":{loc:{start:{line:22,column:51},end:{line:22,column:67}},type:"binary-expr",locations:[{start:{line:22,column:51},end:{line:22,column:61}},{start:{line:22,column:65},end:{line:22,column:67}}],line:22},"4":{loc:{start:{line:40,column:8},end:{line:48,column:9}},type:"if",locations:[{start:{line:40,column:8},end:{line:48,column:9}},{start:{line:40,column:8},end:{line:48,column:9}}],line:40},"5":{loc:{start:{line:41,column:12},end:{line:43,column:13}},type:"if",locations:[{start:{line:41,column:12},end:{line:43,column:13}},{start:{line:41,column:12},end:{line:43,column:13}}],line:41},"6":{loc:{start:{line:59,column:12},end:{line:68,column:13}},type:"if",locations:[{start:{line:59,column:12},end:{line:68,column:13}},{start:{line:59,column:12},end:{line:68,column:13}}],line:59},"7":{loc:{start:{line:65,column:37},end:{line:65,column:116}},type:"cond-expr",locations:[{start:{line:65,column:62},end:{line:65,column:84}},{start:{line:65,column:87},end:{line:65,column:116}}],line:65},"8":{loc:{start:{line:66,column:29},end:{line:66,column:115}},type:"cond-expr",locations:[{start:{line:66,column:46},end:{line:66,column:91}},{start:{line:66,column:94},end:{line:66,column:115}}],line:66}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0},b:{"0":[0,0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0,0],"8":[0,0]},_coverageSchema:"332fd63041d2c1bcb487cc26dd0d5f7d97098a6c"},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var __awaiter=(cov_114ol2ai3k.s[0]++,(cov_114ol2ai3k.b[0][0]++,this)&&(cov_114ol2ai3k.b[0][1]++,this.__awaiter)||(cov_114ol2ai3k.b[0][2]++,function(thisArg,_arguments,P,generator){cov_114ol2ai3k.f[0]++;cov_114ol2ai3k.s[1]++;return new((cov_114ol2ai3k.b[1][0]++,P)||(cov_114ol2ai3k.b[1][1]++,P=Promise))(function(resolve,reject){cov_114ol2ai3k.f[1]++;function fulfilled(value){cov_114ol2ai3k.f[2]++;cov_114ol2ai3k.s[2]++;try{cov_114ol2ai3k.s[3]++;step(generator.next(value));}catch(e){cov_114ol2ai3k.s[4]++;reject(e);}}function rejected(value){cov_114ol2ai3k.f[3]++;cov_114ol2ai3k.s[5]++;try{cov_114ol2ai3k.s[6]++;step(generator["throw"](value));}catch(e){cov_114ol2ai3k.s[7]++;reject(e);}}function step(result){cov_114ol2ai3k.f[4]++;cov_114ol2ai3k.s[8]++;result.done?(cov_114ol2ai3k.b[2][0]++,resolve(result.value)):(cov_114ol2ai3k.b[2][1]++,new P(function(resolve){cov_114ol2ai3k.f[5]++;cov_114ol2ai3k.s[9]++;resolve(result.value);}).then(fulfilled,rejected));}cov_114ol2ai3k.s[10]++;step((generator=generator.apply(thisArg,(cov_114ol2ai3k.b[3][0]++,_arguments)||(cov_114ol2ai3k.b[3][1]++,[]))).next());});}));cov_114ol2ai3k.s[11]++;Object.defineProperty(exports,"__esModule",{value:true});const automation_client_1=(cov_114ol2ai3k.s[12]++,require("@atomist/automation-client"));const reportFailureInterpretationToLinkedChannels_1=(cov_114ol2ai3k.s[13]++,require("../../../../util/slack/reportFailureInterpretationToLinkedChannels"));/**
 * Report an error executing a goal and present a retry button
 * @return {Promise<void>}
 */function reportGoalError(parameters,err){cov_114ol2ai3k.f[6]++;cov_114ol2ai3k.s[14]++;return __awaiter(this,void 0,void 0,function*(){cov_114ol2ai3k.f[7]++;const{goal,implementationName,addressChannels,progressLog,id,logInterpreter}=(cov_114ol2ai3k.s[15]++,parameters);cov_114ol2ai3k.s[16]++;automation_client_1.logger.error("RunWithLog on goal %s with implementation name '%s' caught error: %s",goal.name,implementationName,err.message);cov_114ol2ai3k.s[17]++;automation_client_1.logger.error(err.stack);cov_114ol2ai3k.s[18]++;progressLog.write("ERROR: "+err.message+"\n");const interpretation=(cov_114ol2ai3k.s[19]++,logInterpreter(progressLog.log));// The executor might have information about the failure; report it in the channels
cov_114ol2ai3k.s[20]++;if(interpretation){cov_114ol2ai3k.b[4][0]++;cov_114ol2ai3k.s[21]++;if(!interpretation.doNotReportToUser){cov_114ol2ai3k.b[5][0]++;cov_114ol2ai3k.s[22]++;yield reportFailureInterpretationToLinkedChannels_1.reportFailureInterpretationToLinkedChannels(implementationName,interpretation,{url:progressLog.url,log:progressLog.log},id,addressChannels);}else{cov_114ol2ai3k.b[5][1]++;}}else{cov_114ol2ai3k.b[4][1]++;cov_114ol2ai3k.s[23]++;// We don't have an interpretation available. Just report
yield addressChannels("Failure executing goal: "+err.message);}});}cov_114ol2ai3k.s[24]++;exports.reportGoalError=reportGoalError;function CompositeGoalExecutor(...goalImplementations){cov_114ol2ai3k.f[8]++;cov_114ol2ai3k.s[25]++;return r=>{cov_114ol2ai3k.f[9]++;cov_114ol2ai3k.s[26]++;return __awaiter(this,void 0,void 0,function*(){cov_114ol2ai3k.f[10]++;let overallResult=(cov_114ol2ai3k.s[27]++,{code:0});cov_114ol2ai3k.s[28]++;for(const goalImplementation of goalImplementations){const result=(cov_114ol2ai3k.s[29]++,yield goalImplementation(r));cov_114ol2ai3k.s[30]++;if(result.code!==0){cov_114ol2ai3k.b[6][0]++;cov_114ol2ai3k.s[31]++;return result;}else{cov_114ol2ai3k.b[6][1]++;cov_114ol2ai3k.s[32]++;overallResult={code:result.code,requireApproval:result.requireApproval?(cov_114ol2ai3k.b[7][0]++,result.requireApproval):(cov_114ol2ai3k.b[7][1]++,overallResult.requireApproval),message:result.message?(cov_114ol2ai3k.b[8][0]++,`${overallResult.message}\n${result.message}`):(cov_114ol2ai3k.b[8][1]++,overallResult.message)};}}cov_114ol2ai3k.s[33]++;return overallResult;});};}cov_114ol2ai3k.s[34]++;exports.CompositeGoalExecutor=CompositeGoalExecutor;//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL2NvbW1vbi9kZWxpdmVyeS9nb2Fscy9zdXBwb3J0L3JlcG9ydEdvYWxFcnJvci50cyIsInNvdXJjZXMiOlsiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL2NvbW1vbi9kZWxpdmVyeS9nb2Fscy9zdXBwb3J0L3JlcG9ydEdvYWxFcnJvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7O0dBY0c7Ozs7Ozs7Ozs7QUFFSCxrRUFBb0Q7QUFNcEQsb0lBQWlJO0FBaUJqSTs7O0dBR0c7QUFDSCx5QkFBc0MsVUFPSCxFQUNHLEdBQVU7O1FBQzVDLE1BQU0sRUFBQyxJQUFJLEVBQUUsa0JBQWtCLEVBQUUsZUFBZSxFQUFFLFdBQVcsRUFBRSxFQUFFLEVBQUUsY0FBYyxFQUFDLEdBQUcsVUFBVSxDQUFDO1FBQ2hHLDBCQUFNLENBQUMsS0FBSyxDQUFDLHNFQUFzRSxFQUMvRSxJQUFJLENBQUMsSUFBSSxFQUFFLGtCQUFrQixFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNoRCwwQkFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDeEIsV0FBVyxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsR0FBRyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBQztRQUVsRCxNQUFNLGNBQWMsR0FBRyxjQUFjLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZELG1GQUFtRjtRQUNuRixJQUFJLGNBQWMsRUFBRTtZQUNoQixJQUFJLENBQUMsY0FBYyxDQUFDLGlCQUFpQixFQUFFO2dCQUNuQyxNQUFNLHlGQUEyQyxDQUFDLGtCQUFrQixFQUFFLGNBQWMsRUFDaEYsRUFBQyxHQUFHLEVBQUUsV0FBVyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsV0FBVyxDQUFDLEdBQUcsRUFBQyxFQUM1QyxFQUFFLEVBQUUsZUFBZSxDQUFDLENBQUM7YUFDNUI7U0FDSjthQUFNO1lBQ0gseURBQXlEO1lBQ3pELE1BQU0sZUFBZSxDQUFDLDBCQUEwQixHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUNuRTtJQUNMLENBQUM7Q0FBQTtBQTNCRCwwQ0EyQkM7QUFFRCwrQkFBc0MsR0FBRyxtQkFBeUM7SUFDOUUsT0FBTyxDQUFPLENBQW9CLEVBQUUsRUFBRTtRQUNsQyxJQUFJLGFBQWEsR0FBc0I7WUFDbkMsSUFBSSxFQUFFLENBQUM7U0FDVixDQUFDO1FBRUYsS0FBSyxNQUFNLGtCQUFrQixJQUFJLG1CQUFtQixFQUFFO1lBQ2xELE1BQU0sTUFBTSxHQUFHLE1BQU0sa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0MsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMsRUFBRTtnQkFDbkIsT0FBTyxNQUFNLENBQUM7YUFDakI7aUJBQU07Z0JBQ0gsYUFBYSxHQUFHO29CQUNaLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSTtvQkFDakIsZUFBZSxFQUFFLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxlQUFlO29CQUNoRyxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxhQUFhLENBQUMsT0FBTyxLQUFLLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLE9BQU87aUJBQ2xHLENBQUM7YUFDTDtTQUNKO1FBQ0QsT0FBTyxhQUFhLENBQUM7SUFDekIsQ0FBQyxDQUFBLENBQUM7QUFDTixDQUFDO0FBcEJELHNEQW9CQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgwqkgMjAxOCBBdG9taXN0LCBJbmMuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudFwiO1xuaW1wb3J0IHsgUmVtb3RlUmVwb1JlZiB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudC9vcGVyYXRpb25zL2NvbW1vbi9SZXBvSWRcIjtcbmltcG9ydCB7IEdpdFByb2plY3QgfSBmcm9tIFwiQGF0b21pc3QvYXV0b21hdGlvbi1jbGllbnQvcHJvamVjdC9naXQvR2l0UHJvamVjdFwiO1xuaW1wb3J0IHsgSW50ZXJwcmV0TG9nIH0gZnJvbSBcIi4uLy4uLy4uLy4uL3NwaS9sb2cvSW50ZXJwcmV0ZWRMb2dcIjtcbmltcG9ydCB7IFByb2dyZXNzTG9nIH0gZnJvbSBcIi4uLy4uLy4uLy4uL3NwaS9sb2cvUHJvZ3Jlc3NMb2dcIjtcbmltcG9ydCB7IFN0YXR1c0ZvckV4ZWN1dGVHb2FsIH0gZnJvbSBcIi4uLy4uLy4uLy4uL3R5cGluZ3MvdHlwZXNcIjtcbmltcG9ydCB7IHJlcG9ydEZhaWx1cmVJbnRlcnByZXRhdGlvblRvTGlua2VkQ2hhbm5lbHMgfSBmcm9tIFwiLi4vLi4vLi4vLi4vdXRpbC9zbGFjay9yZXBvcnRGYWlsdXJlSW50ZXJwcmV0YXRpb25Ub0xpbmtlZENoYW5uZWxzXCI7XG5pbXBvcnQgeyBSZXBvQ29udGV4dCB9IGZyb20gXCIuLi8uLi8uLi9jb250ZXh0L1NkbUNvbnRleHRcIjtcbmltcG9ydCB7IEFkZHJlc3NDaGFubmVscyB9IGZyb20gXCIuLi8uLi8uLi9zbGFjay9hZGRyZXNzQ2hhbm5lbHNcIjtcbmltcG9ydCB7IEV4ZWN1dGVHb2FsUmVzdWx0IH0gZnJvbSBcIi4uL0V4ZWN1dGVHb2FsUmVzdWx0XCI7XG5pbXBvcnQgeyBHb2FsIH0gZnJvbSBcIi4uL0dvYWxcIjtcblxuZXhwb3J0IHR5cGUgRXhlY3V0ZUdvYWxXaXRoTG9nID0gKHI6IFJ1bldpdGhMb2dDb250ZXh0KSA9PiBQcm9taXNlPEV4ZWN1dGVHb2FsUmVzdWx0PjtcblxuZXhwb3J0IHR5cGUgUHJlcGFyZUZvckdvYWxFeGVjdXRpb24gPSAocDogR2l0UHJvamVjdCwgcjogUnVuV2l0aExvZ0NvbnRleHQpID0+IFByb21pc2U8RXhlY3V0ZUdvYWxSZXN1bHQ+O1xuXG5leHBvcnQgaW50ZXJmYWNlIFJ1bldpdGhMb2dDb250ZXh0IGV4dGVuZHMgUmVwb0NvbnRleHQge1xuXG4gICAgc3RhdHVzOiBTdGF0dXNGb3JFeGVjdXRlR29hbC5GcmFnbWVudDtcbiAgICBwcm9ncmVzc0xvZzogUHJvZ3Jlc3NMb2c7XG5cbn1cblxuLyoqXG4gKiBSZXBvcnQgYW4gZXJyb3IgZXhlY3V0aW5nIGEgZ29hbCBhbmQgcHJlc2VudCBhIHJldHJ5IGJ1dHRvblxuICogQHJldHVybiB7UHJvbWlzZTx2b2lkPn1cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlcG9ydEdvYWxFcnJvcihwYXJhbWV0ZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdvYWw6IEdvYWwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltcGxlbWVudGF0aW9uTmFtZTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRyZXNzQ2hhbm5lbHM6IEFkZHJlc3NDaGFubmVscyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3NMb2c6IFByb2dyZXNzTG9nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogUmVtb3RlUmVwb1JlZixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nSW50ZXJwcmV0ZXI6IEludGVycHJldExvZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnI6IEVycm9yKSB7XG4gICAgY29uc3Qge2dvYWwsIGltcGxlbWVudGF0aW9uTmFtZSwgYWRkcmVzc0NoYW5uZWxzLCBwcm9ncmVzc0xvZywgaWQsIGxvZ0ludGVycHJldGVyfSA9IHBhcmFtZXRlcnM7XG4gICAgbG9nZ2VyLmVycm9yKFwiUnVuV2l0aExvZyBvbiBnb2FsICVzIHdpdGggaW1wbGVtZW50YXRpb24gbmFtZSAnJXMnIGNhdWdodCBlcnJvcjogJXNcIixcbiAgICAgICAgZ29hbC5uYW1lLCBpbXBsZW1lbnRhdGlvbk5hbWUsIGVyci5tZXNzYWdlKTtcbiAgICBsb2dnZXIuZXJyb3IoZXJyLnN0YWNrKTtcbiAgICBwcm9ncmVzc0xvZy53cml0ZShcIkVSUk9SOiBcIiArIGVyci5tZXNzYWdlICsgXCJcXG5cIik7XG5cbiAgICBjb25zdCBpbnRlcnByZXRhdGlvbiA9IGxvZ0ludGVycHJldGVyKHByb2dyZXNzTG9nLmxvZyk7XG4gICAgLy8gVGhlIGV4ZWN1dG9yIG1pZ2h0IGhhdmUgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGZhaWx1cmU7IHJlcG9ydCBpdCBpbiB0aGUgY2hhbm5lbHNcbiAgICBpZiAoaW50ZXJwcmV0YXRpb24pIHtcbiAgICAgICAgaWYgKCFpbnRlcnByZXRhdGlvbi5kb05vdFJlcG9ydFRvVXNlcikge1xuICAgICAgICAgICAgYXdhaXQgcmVwb3J0RmFpbHVyZUludGVycHJldGF0aW9uVG9MaW5rZWRDaGFubmVscyhpbXBsZW1lbnRhdGlvbk5hbWUsIGludGVycHJldGF0aW9uLFxuICAgICAgICAgICAgICAgIHt1cmw6IHByb2dyZXNzTG9nLnVybCwgbG9nOiBwcm9ncmVzc0xvZy5sb2d9LFxuICAgICAgICAgICAgICAgIGlkLCBhZGRyZXNzQ2hhbm5lbHMpO1xuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgLy8gV2UgZG9uJ3QgaGF2ZSBhbiBpbnRlcnByZXRhdGlvbiBhdmFpbGFibGUuIEp1c3QgcmVwb3J0XG4gICAgICAgIGF3YWl0IGFkZHJlc3NDaGFubmVscyhcIkZhaWx1cmUgZXhlY3V0aW5nIGdvYWw6IFwiICsgZXJyLm1lc3NhZ2UpO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIENvbXBvc2l0ZUdvYWxFeGVjdXRvciguLi5nb2FsSW1wbGVtZW50YXRpb25zOiBFeGVjdXRlR29hbFdpdGhMb2dbXSk6IEV4ZWN1dGVHb2FsV2l0aExvZyB7XG4gICAgcmV0dXJuIGFzeW5jIChyOiBSdW5XaXRoTG9nQ29udGV4dCkgPT4ge1xuICAgICAgICBsZXQgb3ZlcmFsbFJlc3VsdDogRXhlY3V0ZUdvYWxSZXN1bHQgPSB7XG4gICAgICAgICAgICBjb2RlOiAwLFxuICAgICAgICB9O1xuXG4gICAgICAgIGZvciAoY29uc3QgZ29hbEltcGxlbWVudGF0aW9uIG9mIGdvYWxJbXBsZW1lbnRhdGlvbnMpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdvYWxJbXBsZW1lbnRhdGlvbihyKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQuY29kZSAhPT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG92ZXJhbGxSZXN1bHQgPSB7XG4gICAgICAgICAgICAgICAgICAgIGNvZGU6IHJlc3VsdC5jb2RlLFxuICAgICAgICAgICAgICAgICAgICByZXF1aXJlQXBwcm92YWw6IHJlc3VsdC5yZXF1aXJlQXBwcm92YWwgPyByZXN1bHQucmVxdWlyZUFwcHJvdmFsIDogb3ZlcmFsbFJlc3VsdC5yZXF1aXJlQXBwcm92YWwsXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHJlc3VsdC5tZXNzYWdlID8gYCR7b3ZlcmFsbFJlc3VsdC5tZXNzYWdlfVxcbiR7cmVzdWx0Lm1lc3NhZ2V9YCA6IG92ZXJhbGxSZXN1bHQubWVzc2FnZSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBvdmVyYWxsUmVzdWx0O1xuICAgIH07XG59XG4iXX0=