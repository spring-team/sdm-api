"use strict";/*
 * Copyright Â© 2018 Atomist, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var cov_660l2d6nu=function(){var path="/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/handlers/events/delivery/goals/launchGoal.ts",hash="814209382b3395ddd9852aec6514369072c8ad11",Function=function(){}.constructor,global=new Function('return this')(),gcv="__coverage__",coverageData={path:"/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/handlers/events/delivery/goals/launchGoal.ts",statementMap:{"0":{start:{line:17,column:16},end:{line:24,column:1}},"1":{start:{line:18,column:4},end:{line:23,column:7}},"2":{start:{line:19,column:36},end:{line:19,column:97}},"3":{start:{line:19,column:42},end:{line:19,column:70}},"4":{start:{line:19,column:85},end:{line:19,column:95}},"5":{start:{line:20,column:35},end:{line:20,column:100}},"6":{start:{line:20,column:41},end:{line:20,column:73}},"7":{start:{line:20,column:88},end:{line:20,column:98}},"8":{start:{line:21,column:32},end:{line:21,column:149}},"9":{start:{line:21,column:97},end:{line:21,column:119}},"10":{start:{line:22,column:8},end:{line:22,column:78}},"11":{start:{line:25,column:0},end:{line:25,column:62}},"12":{start:{line:26,column:28},end:{line:26,column:65}},"13":{start:{line:27,column:24},end:{line:27,column:75}},"14":{start:{line:28,column:28},end:{line:28,column:89}},"15":{start:{line:29,column:17},end:{line:29,column:75}},"16":{start:{line:30,column:34},end:{line:30,column:102}},"17":{start:{line:31,column:22},end:{line:31,column:81}},"18":{start:{line:32,column:16},end:{line:32,column:34}},"19":{start:{line:33,column:33},end:{line:33,column:68}},"20":{start:{line:36,column:8},end:{line:36,column:16}},"21":{start:{line:37,column:8},end:{line:37,column:57}},"22":{start:{line:38,column:8},end:{line:38,column:43}},"23":{start:{line:39,column:8},end:{line:39,column:37}},"24":{start:{line:42,column:8},end:{line:46,column:9}},"25":{start:{line:44,column:26},end:{line:44,column:147}},"26":{start:{line:44,column:32},end:{line:44,column:147}},"27":{start:{line:45,column:12},end:{line:45,column:83}},"28":{start:{line:49,column:8},end:{line:88,column:11}},"29":{start:{line:50,column:12},end:{line:87,column:13}},"30":{start:{line:51,column:37},end:{line:51,column:62}},"31":{start:{line:52,column:31},end:{line:52,column:60}},"32":{start:{line:53,column:33},end:{line:53,column:77}},"33":{start:{line:54,column:31},end:{line:54,column:58}},"34":{start:{line:55,column:38},end:{line:55,column:91}},"35":{start:{line:57,column:36},end:{line:57,column:183}},"36":{start:{line:58,column:29},end:{line:64,column:18}},"37":{start:{line:66,column:30},end:{line:66,column:151}},"38":{start:{line:66,column:36},end:{line:66,column:151}},"39":{start:{line:67,column:16},end:{line:67,column:87}},"40":{start:{line:69,column:30},end:{line:81,column:17}},"41":{start:{line:82,column:16},end:{line:86,column:20}},"42":{start:{line:82,column:68},end:{line:86,column:18}},"43":{start:{line:83,column:37},end:{line:83,column:50}},"44":{start:{line:84,column:20},end:{line:84,column:107}},"45":{start:{line:85,column:20},end:{line:85,column:61}},"46":{start:{line:85,column:37},end:{line:85,column:52}},"47":{start:{line:91,column:0},end:{line:91,column:66}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:17,column:44},end:{line:17,column:45}},loc:{start:{line:17,column:89},end:{line:24,column:1}},line:17},"1":{name:"(anonymous_1)",decl:{start:{line:18,column:36},end:{line:18,column:37}},loc:{start:{line:18,column:63},end:{line:23,column:5}},line:18},"2":{name:"fulfilled",decl:{start:{line:19,column:17},end:{line:19,column:26}},loc:{start:{line:19,column:34},end:{line:19,column:99}},line:19},"3":{name:"rejected",decl:{start:{line:20,column:17},end:{line:20,column:25}},loc:{start:{line:20,column:33},end:{line:20,column:102}},line:20},"4":{name:"step",decl:{start:{line:21,column:17},end:{line:21,column:21}},loc:{start:{line:21,column:30},end:{line:21,column:151}},line:21},"5":{name:"(anonymous_5)",decl:{start:{line:21,column:76},end:{line:21,column:77}},loc:{start:{line:21,column:95},end:{line:21,column:121}},line:21},"6":{name:"(anonymous_6)",decl:{start:{line:35,column:4},end:{line:35,column:5}},loc:{start:{line:35,column:65},end:{line:40,column:5}},line:35},"7":{name:"(anonymous_7)",decl:{start:{line:41,column:4},end:{line:41,column:5}},loc:{start:{line:41,column:27},end:{line:47,column:5}},line:41},"8":{name:"(anonymous_8)",decl:{start:{line:44,column:26},end:{line:44,column:27}},loc:{start:{line:44,column:32},end:{line:44,column:147}},line:44},"9":{name:"(anonymous_9)",decl:{start:{line:48,column:4},end:{line:48,column:5}},loc:{start:{line:48,column:41},end:{line:89,column:5}},line:48},"10":{name:"(anonymous_10)",decl:{start:{line:49,column:47},end:{line:49,column:48}},loc:{start:{line:49,column:60},end:{line:88,column:9}},line:49},"11":{name:"(anonymous_11)",decl:{start:{line:66,column:30},end:{line:66,column:31}},loc:{start:{line:66,column:36},end:{line:66,column:151}},line:66},"12":{name:"(anonymous_12)",decl:{start:{line:82,column:55},end:{line:82,column:56}},loc:{start:{line:82,column:68},end:{line:86,column:18}},line:82},"13":{name:"(anonymous_13)",decl:{start:{line:82,column:100},end:{line:82,column:101}},loc:{start:{line:82,column:113},end:{line:86,column:17}},line:82},"14":{name:"(anonymous_14)",decl:{start:{line:85,column:31},end:{line:85,column:32}},loc:{start:{line:85,column:37},end:{line:85,column:52}},line:85}},branchMap:{"0":{loc:{start:{line:17,column:16},end:{line:24,column:1}},type:"binary-expr",locations:[{start:{line:17,column:17},end:{line:17,column:21}},{start:{line:17,column:25},end:{line:17,column:39}},{start:{line:17,column:44},end:{line:24,column:1}}],line:17},"1":{loc:{start:{line:18,column:16},end:{line:18,column:34}},type:"binary-expr",locations:[{start:{line:18,column:16},end:{line:18,column:17}},{start:{line:18,column:22},end:{line:18,column:33}}],line:18},"2":{loc:{start:{line:21,column:32},end:{line:21,column:148}},type:"cond-expr",locations:[{start:{line:21,column:46},end:{line:21,column:67}},{start:{line:21,column:70},end:{line:21,column:148}}],line:21},"3":{loc:{start:{line:22,column:51},end:{line:22,column:67}},type:"binary-expr",locations:[{start:{line:22,column:51},end:{line:22,column:61}},{start:{line:22,column:65},end:{line:22,column:67}}],line:22},"4":{loc:{start:{line:42,column:8},end:{line:46,column:9}},type:"if",locations:[{start:{line:42,column:8},end:{line:46,column:9}},{start:{line:42,column:8},end:{line:46,column:9}}],line:42},"5":{loc:{start:{line:50,column:12},end:{line:87,column:13}},type:"if",locations:[{start:{line:50,column:12},end:{line:87,column:13}},{start:{line:50,column:12},end:{line:87,column:13}}],line:50},"6":{loc:{start:{line:53,column:33},end:{line:53,column:77}},type:"binary-expr",locations:[{start:{line:53,column:33},end:{line:53,column:67}},{start:{line:53,column:71},end:{line:53,column:77}}],line:53},"7":{loc:{start:{line:55,column:38},end:{line:55,column:91}},type:"binary-expr",locations:[{start:{line:55,column:38},end:{line:55,column:72}},{start:{line:55,column:76},end:{line:55,column:91}}],line:55}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0},b:{"0":[0,0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0,0]},_coverageSchema:"332fd63041d2c1bcb487cc26dd0d5f7d97098a6c"},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var __awaiter=(cov_660l2d6nu.s[0]++,(cov_660l2d6nu.b[0][0]++,this)&&(cov_660l2d6nu.b[0][1]++,this.__awaiter)||(cov_660l2d6nu.b[0][2]++,function(thisArg,_arguments,P,generator){cov_660l2d6nu.f[0]++;cov_660l2d6nu.s[1]++;return new((cov_660l2d6nu.b[1][0]++,P)||(cov_660l2d6nu.b[1][1]++,P=Promise))(function(resolve,reject){cov_660l2d6nu.f[1]++;function fulfilled(value){cov_660l2d6nu.f[2]++;cov_660l2d6nu.s[2]++;try{cov_660l2d6nu.s[3]++;step(generator.next(value));}catch(e){cov_660l2d6nu.s[4]++;reject(e);}}function rejected(value){cov_660l2d6nu.f[3]++;cov_660l2d6nu.s[5]++;try{cov_660l2d6nu.s[6]++;step(generator["throw"](value));}catch(e){cov_660l2d6nu.s[7]++;reject(e);}}function step(result){cov_660l2d6nu.f[4]++;cov_660l2d6nu.s[8]++;result.done?(cov_660l2d6nu.b[2][0]++,resolve(result.value)):(cov_660l2d6nu.b[2][1]++,new P(function(resolve){cov_660l2d6nu.f[5]++;cov_660l2d6nu.s[9]++;resolve(result.value);}).then(fulfilled,rejected));}cov_660l2d6nu.s[10]++;step((generator=generator.apply(thisArg,(cov_660l2d6nu.b[3][0]++,_arguments)||(cov_660l2d6nu.b[3][1]++,[]))).next());});}));cov_660l2d6nu.s[11]++;Object.defineProperty(exports,"__esModule",{value:true});const automation_client_1=(cov_660l2d6nu.s[12]++,require("@atomist/automation-client"));const configuration_1=(cov_660l2d6nu.s[13]++,require("@atomist/automation-client/configuration"));const ApolloGraphClient_1=(cov_660l2d6nu.s[14]++,require("@atomist/automation-client/graph/ApolloGraphClient"));const string_1=(cov_660l2d6nu.s[15]++,require("@atomist/automation-client/internal/util/string"));const AutomationEventListener_1=(cov_660l2d6nu.s[16]++,require("@atomist/automation-client/server/AutomationEventListener"));const GraphClient_1=(cov_660l2d6nu.s[17]++,require("@atomist/automation-client/spi/graph/GraphClient"));const cluster=(cov_660l2d6nu.s[18]++,require("cluster"));const FulfillGoalOnRequested_1=(cov_660l2d6nu.s[19]++,require("./FulfillGoalOnRequested"));class GoalAutomationEventListener extends(AutomationEventListener_1.AutomationEventListenerSupport){constructor(implementationMapper,projectLoader,logFactory){cov_660l2d6nu.f[6]++;cov_660l2d6nu.s[20]++;super();cov_660l2d6nu.s[21]++;this.implementationMapper=implementationMapper;cov_660l2d6nu.s[22]++;this.projectLoader=projectLoader;cov_660l2d6nu.s[23]++;this.logFactory=logFactory;}eventIncoming(payload){cov_660l2d6nu.f[7]++;cov_660l2d6nu.s[24]++;if(cluster.isWorker){cov_660l2d6nu.b[4][0]++;cov_660l2d6nu.s[25]++;// Register event handler locally only
const maker=()=>{cov_660l2d6nu.f[8]++;cov_660l2d6nu.s[26]++;return new FulfillGoalOnRequested_1.FulfillGoalOnRequested(this.implementationMapper,this.projectLoader,this.logFactory);};cov_660l2d6nu.s[27]++;automation_client_1.automationClientInstance().withEventHandler(maker);}else{cov_660l2d6nu.b[4][1]++;}}registrationSuccessful(eventHandler){cov_660l2d6nu.f[9]++;cov_660l2d6nu.s[28]++;return __awaiter(this,void 0,void 0,function*(){cov_660l2d6nu.f[10]++;cov_660l2d6nu.s[29]++;if(cluster.isMaster){cov_660l2d6nu.b[5][0]++;const registration=(cov_660l2d6nu.s[30]++,eventHandler.registration);const teamId=(cov_660l2d6nu.s[31]++,process.env.ATOMIST_GOAL_TEAM);const teamName=(cov_660l2d6nu.s[32]++,(cov_660l2d6nu.b[6][0]++,process.env.ATOMIST_GOAL_TEAM_NAME)||(cov_660l2d6nu.b[6][1]++,teamId));const goalId=(cov_660l2d6nu.s[33]++,process.env.ATOMIST_GOAL_ID);const correlationId=(cov_660l2d6nu.s[34]++,(cov_660l2d6nu.b[7][0]++,process.env.ATOMIST_CORRELATION_ID)||(cov_660l2d6nu.b[7][1]++,string_1.guid()));// Obtain goal via graphql query
const graphClient=(cov_660l2d6nu.s[35]++,new ApolloGraphClient_1.ApolloGraphClient(`https://automation.atomist.com/graphql/team/${teamId}`,{Authorization:`Bearer ${registration.jwt}`}));const goal=(cov_660l2d6nu.s[36]++,yield graphClient.query({name:"SdmGoalById",variables:{id:goalId},options:GraphClient_1.QueryNoCacheOptions}));// Register event handler locally only
cov_660l2d6nu.s[37]++;const maker=()=>{cov_660l2d6nu.f[11]++;cov_660l2d6nu.s[38]++;return new FulfillGoalOnRequested_1.FulfillGoalOnRequested(this.implementationMapper,this.projectLoader,this.logFactory);};cov_660l2d6nu.s[39]++;automation_client_1.automationClientInstance().withEventHandler(maker);// Create event and run event handler
const event=(cov_660l2d6nu.s[40]++,{data:goal,extensions:{correlation_id:correlationId,team_id:teamId,team_name:teamName,operationName:maker().subscriptionName},secrets:[{uri:automation_client_1.Secrets.OrgToken,value:configuration_1.configurationValue("token")}]});cov_660l2d6nu.s[41]++;yield eventHandler.processEvent(event,results=>{cov_660l2d6nu.f[12]++;cov_660l2d6nu.s[42]++;return __awaiter(this,void 0,void 0,function*(){cov_660l2d6nu.f[13]++;const resolved=(cov_660l2d6nu.s[43]++,yield results);cov_660l2d6nu.s[44]++;automation_client_1.logger.info("Processing goal completed with results %j",resolved);cov_660l2d6nu.s[45]++;setTimeout(()=>{cov_660l2d6nu.f[14]++;cov_660l2d6nu.s[46]++;return process.exit(0);},10000);});});}else{cov_660l2d6nu.b[5][1]++;}});}}cov_660l2d6nu.s[47]++;exports.GoalAutomationEventListener=GoalAutomationEventListener;//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL2hhbmRsZXJzL2V2ZW50cy9kZWxpdmVyeS9nb2Fscy9sYXVuY2hHb2FsLnRzIiwic291cmNlcyI6WyIvVXNlcnMvcm9kam9obnNvbi9zZm9yemFuZG8tZGV2L2lkZWEtcHJvamVjdHMvbXktZmxvdy9zcmMvaGFuZGxlcnMvZXZlbnRzL2RlbGl2ZXJ5L2dvYWxzL2xhdW5jaEdvYWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7OztHQWNHOzs7Ozs7Ozs7O0FBRUgsa0VBTW9DO0FBQ3BDLDRFQUE4RTtBQUM5RSwwRkFBdUY7QUFNdkYsNEVBQXVFO0FBQ3ZFLHVHQUEyRztBQUMzRyxrRkFBdUY7QUFDdkYsbUNBQW1DO0FBU25DLHFFQUFrRTtBQVNsRSxpQ0FBeUMsU0FBUSx3REFBOEI7SUFFM0UsWUFBNkIsb0JBQWlELEVBQ2pELGFBQTRCLEVBQzVCLFVBQThCO1FBQ3ZELEtBQUssRUFBRSxDQUFDO1FBSGlCLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBNkI7UUFDakQsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7SUFFM0QsQ0FBQztJQUVNLGFBQWEsQ0FBQyxPQUFzQjtRQUN2QyxJQUFJLE9BQU8sQ0FBQyxRQUFRLEVBQUU7WUFDbEIsc0NBQXNDO1lBQ3RDLE1BQU0sS0FBSyxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksK0NBQXNCLENBQUMsSUFBSSxDQUFDLG9CQUFvQixFQUFFLElBQUksQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQy9HLDRDQUF3QixFQUFFLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDdEQ7SUFDTCxDQUFDO0lBRVksc0JBQXNCLENBQUMsWUFBOEI7O1lBQzlELElBQUksT0FBTyxDQUFDLFFBQVEsRUFBRTtnQkFDbEIsTUFBTSxZQUFZLEdBQUksWUFBb0IsQ0FBQyxZQUF3QyxDQUFDO2dCQUNwRixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDO2dCQUM3QyxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixJQUFJLE1BQU0sQ0FBQztnQkFDOUQsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUM7Z0JBQzNDLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLElBQUksYUFBSSxFQUFFLENBQUM7Z0JBRW5FLGdDQUFnQztnQkFDaEMsTUFBTSxXQUFXLEdBQUcsSUFBSSxxQ0FBaUIsQ0FDckMsK0NBQStDLE1BQU0sRUFBRSxFQUN2RCxFQUFFLGFBQWEsRUFBRSxVQUFVLFlBQVksQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7Z0JBRXJELE1BQU0sSUFBSSxHQUFHLE1BQU0sV0FBVyxDQUFDLEtBQUssQ0FBMkM7b0JBQzNFLElBQUksRUFBRSxhQUFhO29CQUNuQixTQUFTLEVBQUU7d0JBQ1AsRUFBRSxFQUFFLE1BQU07cUJBQ2I7b0JBQ0QsT0FBTyxFQUFFLGlDQUFtQjtpQkFDL0IsQ0FBQyxDQUFDO2dCQUVILHNDQUFzQztnQkFDdEMsTUFBTSxLQUFLLEdBQUcsR0FBRyxFQUFFLENBQUMsSUFBSSwrQ0FBc0IsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsSUFBSSxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQy9HLDRDQUF3QixFQUFFLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBRW5ELHFDQUFxQztnQkFDckMsTUFBTSxLQUFLLEdBQWtCO29CQUN6QixJQUFJLEVBQUUsSUFBSTtvQkFDVixVQUFVLEVBQUU7d0JBQ1IsY0FBYyxFQUFFLGFBQWE7d0JBQzdCLE9BQU8sRUFBRSxNQUFNO3dCQUNmLFNBQVMsRUFBRSxRQUFRO3dCQUNuQixhQUFhLEVBQUUsS0FBSyxFQUFFLENBQUMsZ0JBQWdCO3FCQUMxQztvQkFDRCxPQUFPLEVBQUUsQ0FBQzs0QkFDTixHQUFHLEVBQUUsMkJBQU8sQ0FBQyxRQUFROzRCQUNyQixLQUFLLEVBQUUsa0NBQWtCLENBQVMsT0FBTyxDQUFDO3lCQUM3QyxDQUFDO2lCQUNMLENBQUM7Z0JBQ0YsTUFBTSxZQUFZLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxDQUFNLE9BQU8sRUFBQyxFQUFFO29CQUNuRCxNQUFNLFFBQVEsR0FBRyxNQUFNLE9BQU8sQ0FBQztvQkFDL0IsMEJBQU0sQ0FBQyxJQUFJLENBQUMsMkNBQTJDLEVBQUUsUUFBUSxDQUFDLENBQUM7b0JBQ25FLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUM3QyxDQUFDLENBQUEsQ0FBQyxDQUFDO2FBQ047UUFDTCxDQUFDO0tBQUE7Q0FDSjtBQTlERCxrRUE4REMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IMKpIDIwMTggQXRvbWlzdCwgSW5jLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge1xuICAgIGF1dG9tYXRpb25DbGllbnRJbnN0YW5jZSxcbiAgICBIYW5kbGVyQ29udGV4dCxcbiAgICBIYW5kbGVyUmVzdWx0LFxuICAgIGxvZ2dlcixcbiAgICBTZWNyZXRzLFxufSBmcm9tIFwiQGF0b21pc3QvYXV0b21hdGlvbi1jbGllbnRcIjtcbmltcG9ydCB7IGNvbmZpZ3VyYXRpb25WYWx1ZSB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudC9jb25maWd1cmF0aW9uXCI7XG5pbXBvcnQgeyBBcG9sbG9HcmFwaENsaWVudCB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudC9ncmFwaC9BcG9sbG9HcmFwaENsaWVudFwiO1xuaW1wb3J0IHtcbiAgICBFdmVudEluY29taW5nLFxuICAgIFJlcXVlc3RQcm9jZXNzb3IsXG59IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudC9pbnRlcm5hbC90cmFuc3BvcnQvUmVxdWVzdFByb2Nlc3NvclwiO1xuaW1wb3J0IHsgUmVnaXN0cmF0aW9uQ29uZmlybWF0aW9uIH0gZnJvbSBcIkBhdG9taXN0L2F1dG9tYXRpb24tY2xpZW50L2ludGVybmFsL3RyYW5zcG9ydC93ZWJzb2NrZXQvV2ViU29ja2V0UmVxdWVzdFByb2Nlc3NvclwiO1xuaW1wb3J0IHsgZ3VpZCB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudC9pbnRlcm5hbC91dGlsL3N0cmluZ1wiO1xuaW1wb3J0IHsgQXV0b21hdGlvbkV2ZW50TGlzdGVuZXJTdXBwb3J0IH0gZnJvbSBcIkBhdG9taXN0L2F1dG9tYXRpb24tY2xpZW50L3NlcnZlci9BdXRvbWF0aW9uRXZlbnRMaXN0ZW5lclwiO1xuaW1wb3J0IHsgUXVlcnlOb0NhY2hlT3B0aW9ucyB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudC9zcGkvZ3JhcGgvR3JhcGhDbGllbnRcIjtcbmltcG9ydCAqIGFzIGNsdXN0ZXIgZnJvbSBcImNsdXN0ZXJcIjtcbmltcG9ydCB7XG4gICAgT25BbnlSZXF1ZXN0ZWRTZG1Hb2FsLFxuICAgIFByb2dyZXNzTG9nLFxuICAgIFByb2dyZXNzTG9nRmFjdG9yeSxcbiAgICBTZG1Hb2FsQnlJZCxcbn0gZnJvbSBcIi4uLy4uLy4uLy4uXCI7XG5pbXBvcnQgeyBTZG1Hb2FsSW1wbGVtZW50YXRpb25NYXBwZXIgfSBmcm9tIFwiLi4vLi4vLi4vLi4vY29tbW9uL2RlbGl2ZXJ5L2dvYWxzL1NkbUdvYWxJbXBsZW1lbnRhdGlvbk1hcHBlclwiO1xuaW1wb3J0IHsgUHJvamVjdExvYWRlciB9IGZyb20gXCIuLi8uLi8uLi8uLi9jb21tb24vcmVwby9Qcm9qZWN0TG9hZGVyXCI7XG5pbXBvcnQgeyBGdWxmaWxsR29hbE9uUmVxdWVzdGVkIH0gZnJvbSBcIi4vRnVsZmlsbEdvYWxPblJlcXVlc3RlZFwiO1xuXG4vKipcbiAqIExhdW5jaCBhIGdvYWwgaW4gYW4gaXNvbGF0ZWQgZW52aXJvbm1lbnQgKGNvbnRhaW5lciBvciBwcm9jZXNzKSBmb3IgZnVsZmlsbG1lbnQuXG4gKi9cbmV4cG9ydCB0eXBlIElzb2xhdGVkR29hbExhdW5jaGVyID0gKGdvYWw6IE9uQW55UmVxdWVzdGVkU2RtR29hbC5TZG1Hb2FsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4OiBIYW5kbGVyQ29udGV4dCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzTG9nOiBQcm9ncmVzc0xvZykgPT4gUHJvbWlzZTxIYW5kbGVyUmVzdWx0PjtcblxuZXhwb3J0IGNsYXNzIEdvYWxBdXRvbWF0aW9uRXZlbnRMaXN0ZW5lciBleHRlbmRzIEF1dG9tYXRpb25FdmVudExpc3RlbmVyU3VwcG9ydCB7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGltcGxlbWVudGF0aW9uTWFwcGVyOiBTZG1Hb2FsSW1wbGVtZW50YXRpb25NYXBwZXIsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSByZWFkb25seSBwcm9qZWN0TG9hZGVyOiBQcm9qZWN0TG9hZGVyLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgcmVhZG9ubHkgbG9nRmFjdG9yeTogUHJvZ3Jlc3NMb2dGYWN0b3J5KSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGV2ZW50SW5jb21pbmcocGF5bG9hZDogRXZlbnRJbmNvbWluZykge1xuICAgICAgICBpZiAoY2x1c3Rlci5pc1dvcmtlcikge1xuICAgICAgICAgICAgLy8gUmVnaXN0ZXIgZXZlbnQgaGFuZGxlciBsb2NhbGx5IG9ubHlcbiAgICAgICAgICAgIGNvbnN0IG1ha2VyID0gKCkgPT4gbmV3IEZ1bGZpbGxHb2FsT25SZXF1ZXN0ZWQodGhpcy5pbXBsZW1lbnRhdGlvbk1hcHBlciwgdGhpcy5wcm9qZWN0TG9hZGVyLCB0aGlzLmxvZ0ZhY3RvcnkpO1xuICAgICAgICAgICAgYXV0b21hdGlvbkNsaWVudEluc3RhbmNlKCkud2l0aEV2ZW50SGFuZGxlcihtYWtlcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgcmVnaXN0cmF0aW9uU3VjY2Vzc2Z1bChldmVudEhhbmRsZXI6IFJlcXVlc3RQcm9jZXNzb3IpIHtcbiAgICAgICAgaWYgKGNsdXN0ZXIuaXNNYXN0ZXIpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlZ2lzdHJhdGlvbiA9IChldmVudEhhbmRsZXIgYXMgYW55KS5yZWdpc3RyYXRpb24gYXMgUmVnaXN0cmF0aW9uQ29uZmlybWF0aW9uO1xuICAgICAgICAgICAgY29uc3QgdGVhbUlkID0gcHJvY2Vzcy5lbnYuQVRPTUlTVF9HT0FMX1RFQU07XG4gICAgICAgICAgICBjb25zdCB0ZWFtTmFtZSA9IHByb2Nlc3MuZW52LkFUT01JU1RfR09BTF9URUFNX05BTUUgfHwgdGVhbUlkO1xuICAgICAgICAgICAgY29uc3QgZ29hbElkID0gcHJvY2Vzcy5lbnYuQVRPTUlTVF9HT0FMX0lEO1xuICAgICAgICAgICAgY29uc3QgY29ycmVsYXRpb25JZCA9IHByb2Nlc3MuZW52LkFUT01JU1RfQ09SUkVMQVRJT05fSUQgfHwgZ3VpZCgpO1xuXG4gICAgICAgICAgICAvLyBPYnRhaW4gZ29hbCB2aWEgZ3JhcGhxbCBxdWVyeVxuICAgICAgICAgICAgY29uc3QgZ3JhcGhDbGllbnQgPSBuZXcgQXBvbGxvR3JhcGhDbGllbnQoXG4gICAgICAgICAgICAgICAgYGh0dHBzOi8vYXV0b21hdGlvbi5hdG9taXN0LmNvbS9ncmFwaHFsL3RlYW0vJHt0ZWFtSWR9YCxcbiAgICAgICAgICAgICAgICB7IEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHtyZWdpc3RyYXRpb24uand0fWAgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGdvYWwgPSBhd2FpdCBncmFwaENsaWVudC5xdWVyeTxTZG1Hb2FsQnlJZC5RdWVyeSwgU2RtR29hbEJ5SWQuVmFyaWFibGVzPih7XG4gICAgICAgICAgICAgICAgbmFtZTogXCJTZG1Hb2FsQnlJZFwiLFxuICAgICAgICAgICAgICAgIHZhcmlhYmxlczoge1xuICAgICAgICAgICAgICAgICAgICBpZDogZ29hbElkLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgb3B0aW9uczogUXVlcnlOb0NhY2hlT3B0aW9ucyxcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvLyBSZWdpc3RlciBldmVudCBoYW5kbGVyIGxvY2FsbHkgb25seVxuICAgICAgICAgICAgY29uc3QgbWFrZXIgPSAoKSA9PiBuZXcgRnVsZmlsbEdvYWxPblJlcXVlc3RlZCh0aGlzLmltcGxlbWVudGF0aW9uTWFwcGVyLCB0aGlzLnByb2plY3RMb2FkZXIsIHRoaXMubG9nRmFjdG9yeSk7XG4gICAgICAgICAgICBhdXRvbWF0aW9uQ2xpZW50SW5zdGFuY2UoKS53aXRoRXZlbnRIYW5kbGVyKG1ha2VyKTtcblxuICAgICAgICAgICAgLy8gQ3JlYXRlIGV2ZW50IGFuZCBydW4gZXZlbnQgaGFuZGxlclxuICAgICAgICAgICAgY29uc3QgZXZlbnQ6IEV2ZW50SW5jb21pbmcgPSB7XG4gICAgICAgICAgICAgICAgZGF0YTogZ29hbCxcbiAgICAgICAgICAgICAgICBleHRlbnNpb25zOiB7XG4gICAgICAgICAgICAgICAgICAgIGNvcnJlbGF0aW9uX2lkOiBjb3JyZWxhdGlvbklkLFxuICAgICAgICAgICAgICAgICAgICB0ZWFtX2lkOiB0ZWFtSWQsXG4gICAgICAgICAgICAgICAgICAgIHRlYW1fbmFtZTogdGVhbU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIG9wZXJhdGlvbk5hbWU6IG1ha2VyKCkuc3Vic2NyaXB0aW9uTmFtZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHNlY3JldHM6IFt7XG4gICAgICAgICAgICAgICAgICAgIHVyaTogU2VjcmV0cy5PcmdUb2tlbixcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGNvbmZpZ3VyYXRpb25WYWx1ZTxzdHJpbmc+KFwidG9rZW5cIiksXG4gICAgICAgICAgICAgICAgfV0sXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYXdhaXQgZXZlbnRIYW5kbGVyLnByb2Nlc3NFdmVudChldmVudCwgYXN5bmMgcmVzdWx0cyA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWQgPSBhd2FpdCByZXN1bHRzO1xuICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKFwiUHJvY2Vzc2luZyBnb2FsIGNvbXBsZXRlZCB3aXRoIHJlc3VsdHMgJWpcIiwgcmVzb2x2ZWQpO1xuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gcHJvY2Vzcy5leGl0KDApLCAxMDAwMCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==