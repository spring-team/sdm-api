"use strict";/*
 * Copyright Â© 2018 Atomist, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var cov_yo9zrwkhc=function(){var path="/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/util/slack/diffRendering.ts",hash="3f5f8df739995be7fcc2c5eb7908eb330d9b97c9",Function=function(){}.constructor,global=new Function('return this')(),gcv="__coverage__",coverageData={path:"/Users/rodjohnson/sforzando-dev/idea-projects/my-flow/src/util/slack/diffRendering.ts",statementMap:{"0":{start:{line:17,column:16},end:{line:24,column:1}},"1":{start:{line:18,column:4},end:{line:23,column:7}},"2":{start:{line:19,column:36},end:{line:19,column:97}},"3":{start:{line:19,column:42},end:{line:19,column:70}},"4":{start:{line:19,column:85},end:{line:19,column:95}},"5":{start:{line:20,column:35},end:{line:20,column:100}},"6":{start:{line:20,column:41},end:{line:20,column:73}},"7":{start:{line:20,column:88},end:{line:20,column:98}},"8":{start:{line:21,column:32},end:{line:21,column:149}},"9":{start:{line:21,column:97},end:{line:21,column:119}},"10":{start:{line:22,column:8},end:{line:22,column:78}},"11":{start:{line:25,column:0},end:{line:25,column:62}},"12":{start:{line:26,column:28},end:{line:26,column:65}},"13":{start:{line:27,column:14},end:{line:27,column:62}},"14":{start:{line:28,column:15},end:{line:28,column:40}},"15":{start:{line:29,column:27},end:{line:29,column:57}},"16":{start:{line:32,column:4},end:{line:32,column:102}},"17":{start:{line:34,column:0},end:{line:34,column:32}},"18":{start:{line:36,column:4},end:{line:36,column:49}},"19":{start:{line:39,column:4},end:{line:48,column:7}},"20":{start:{line:40,column:27},end:{line:40,column:81}},"21":{start:{line:41,column:24},end:{line:45,column:11}},"22":{start:{line:41,column:53},end:{line:45,column:9}},"23":{start:{line:46,column:8},end:{line:46,column:88}},"24":{start:{line:47,column:8},end:{line:47,column:99}},"25":{start:{line:50,column:0},end:{line:50,column:32}},"26":{start:{line:52,column:35},end:{line:52,column:37}},"27":{start:{line:53,column:17},end:{line:53,column:21}},"28":{start:{line:54,column:26},end:{line:54,column:28}},"29":{start:{line:55,column:27},end:{line:55,column:32}},"30":{start:{line:56,column:4},end:{line:73,column:5}},"31":{start:{line:57,column:20},end:{line:58,column:47}},"32":{start:{line:59,column:8},end:{line:61,column:9}},"33":{start:{line:60,column:12},end:{line:60,column:36}},"34":{start:{line:62,column:8},end:{line:69,column:9}},"35":{start:{line:63,column:12},end:{line:66,column:14}},"36":{start:{line:67,column:12},end:{line:67,column:24}},"37":{start:{line:68,column:12},end:{line:68,column:57}},"38":{start:{line:70,column:8},end:{line:72,column:9}},"39":{start:{line:71,column:12},end:{line:71,column:49}},"40":{start:{line:74,column:22},end:{line:74,column:24}},"41":{start:{line:75,column:4},end:{line:91,column:7}},"42":{start:{line:77,column:18},end:{line:77,column:29}},"43":{start:{line:78,column:24},end:{line:78,column:86}},"44":{start:{line:78,column:46},end:{line:78,column:74}},"45":{start:{line:79,column:25},end:{line:79,column:42}},"46":{start:{line:80,column:27},end:{line:89,column:9}},"47":{start:{line:90,column:8},end:{line:90,column:37}},"48":{start:{line:93,column:4},end:{line:104,column:5}},"49":{start:{line:94,column:8},end:{line:94,column:46}},"50":{start:{line:95,column:36},end:{line:95,column:85}},"51":{start:{line:96,column:27},end:{line:102,column:9}},"52":{start:{line:103,column:8},end:{line:103,column:37}},"53":{start:{line:119,column:4},end:{line:119,column:40}},"54":{start:{line:124,column:14},end:{line:124,column:80}},"55":{start:{line:125,column:4},end:{line:125,column:118}},"56":{start:{line:127,column:0},end:{line:127,column:50}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:17,column:44},end:{line:17,column:45}},loc:{start:{line:17,column:89},end:{line:24,column:1}},line:17},"1":{name:"(anonymous_1)",decl:{start:{line:18,column:36},end:{line:18,column:37}},loc:{start:{line:18,column:63},end:{line:23,column:5}},line:18},"2":{name:"fulfilled",decl:{start:{line:19,column:17},end:{line:19,column:26}},loc:{start:{line:19,column:34},end:{line:19,column:99}},line:19},"3":{name:"rejected",decl:{start:{line:20,column:17},end:{line:20,column:25}},loc:{start:{line:20,column:33},end:{line:20,column:102}},line:20},"4":{name:"step",decl:{start:{line:21,column:17},end:{line:21,column:21}},loc:{start:{line:21,column:30},end:{line:21,column:151}},line:21},"5":{name:"(anonymous_5)",decl:{start:{line:21,column:76},end:{line:21,column:77}},loc:{start:{line:21,column:95},end:{line:21,column:121}},line:21},"6":{name:"linkToDiff",decl:{start:{line:31,column:9},end:{line:31,column:19}},loc:{start:{line:31,column:52},end:{line:33,column:1}},line:31},"7":{name:"diffUrl",decl:{start:{line:35,column:9},end:{line:35,column:16}},loc:{start:{line:35,column:33},end:{line:37,column:1}},line:35},"8":{name:"renderDiff",decl:{start:{line:38,column:9},end:{line:38,column:19}},loc:{start:{line:38,column:50},end:{line:49,column:1}},line:38},"9":{name:"(anonymous_9)",decl:{start:{line:39,column:43},end:{line:39,column:44}},loc:{start:{line:39,column:56},end:{line:48,column:5}},line:39},"10":{name:"(anonymous_10)",decl:{start:{line:41,column:47},end:{line:41,column:48}},loc:{start:{line:41,column:53},end:{line:45,column:9}},line:41},"11":{name:"render",decl:{start:{line:51,column:9},end:{line:51,column:15}},loc:{start:{line:51,column:52},end:{line:120,column:1}},line:51},"12":{name:"(anonymous_12)",decl:{start:{line:76,column:17},end:{line:76,column:18}},loc:{start:{line:76,column:25},end:{line:91,column:5}},line:76},"13":{name:"(anonymous_13)",decl:{start:{line:78,column:41},end:{line:78,column:42}},loc:{start:{line:78,column:46},end:{line:78,column:74}},line:78},"14":{name:"renderCommitMessage",decl:{start:{line:122,column:9},end:{line:122,column:28}},loc:{start:{line:122,column:47},end:{line:126,column:1}},line:122}},branchMap:{"0":{loc:{start:{line:17,column:16},end:{line:24,column:1}},type:"binary-expr",locations:[{start:{line:17,column:17},end:{line:17,column:21}},{start:{line:17,column:25},end:{line:17,column:39}},{start:{line:17,column:44},end:{line:24,column:1}}],line:17},"1":{loc:{start:{line:18,column:16},end:{line:18,column:34}},type:"binary-expr",locations:[{start:{line:18,column:16},end:{line:18,column:17}},{start:{line:18,column:22},end:{line:18,column:33}}],line:18},"2":{loc:{start:{line:21,column:32},end:{line:21,column:148}},type:"cond-expr",locations:[{start:{line:21,column:46},end:{line:21,column:67}},{start:{line:21,column:70},end:{line:21,column:148}}],line:21},"3":{loc:{start:{line:22,column:51},end:{line:22,column:67}},type:"binary-expr",locations:[{start:{line:22,column:51},end:{line:22,column:61}},{start:{line:22,column:65},end:{line:22,column:67}}],line:22},"4":{loc:{start:{line:32,column:63},end:{line:32,column:97}},type:"binary-expr",locations:[{start:{line:32,column:63},end:{line:32,column:77}},{start:{line:32,column:81},end:{line:32,column:97}}],line:32},"5":{loc:{start:{line:57,column:20},end:{line:58,column:47}},type:"cond-expr",locations:[{start:{line:58,column:14},end:{line:58,column:33}},{start:{line:58,column:36},end:{line:58,column:47}}],line:57},"6":{loc:{start:{line:57,column:20},end:{line:57,column:94}},type:"binary-expr",locations:[{start:{line:57,column:20},end:{line:57,column:41}},{start:{line:57,column:45},end:{line:57,column:64}},{start:{line:57,column:68},end:{line:57,column:94}}],line:57},"7":{loc:{start:{line:59,column:8},end:{line:61,column:9}},type:"if",locations:[{start:{line:59,column:8},end:{line:61,column:9}},{start:{line:59,column:8},end:{line:61,column:9}}],line:59},"8":{loc:{start:{line:62,column:8},end:{line:69,column:9}},type:"if",locations:[{start:{line:62,column:8},end:{line:69,column:9}},{start:{line:62,column:8},end:{line:69,column:9}}],line:62},"9":{loc:{start:{line:62,column:12},end:{line:62,column:43}},type:"binary-expr",locations:[{start:{line:62,column:12},end:{line:62,column:26}},{start:{line:62,column:30},end:{line:62,column:43}}],line:62},"10":{loc:{start:{line:70,column:8},end:{line:72,column:9}},type:"if",locations:[{start:{line:70,column:8},end:{line:72,column:9}},{start:{line:70,column:8},end:{line:72,column:9}}],line:70},"11":{loc:{start:{line:93,column:4},end:{line:104,column:5}},type:"if",locations:[{start:{line:93,column:4},end:{line:104,column:5}},{start:{line:93,column:4},end:{line:104,column:5}}],line:93}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0,"49":0,"50":0,"51":0,"52":0,"53":0,"54":0,"55":0,"56":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0},b:{"0":[0,0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0,0],"7":[0,0],"8":[0,0],"9":[0,0],"10":[0,0],"11":[0,0]},_coverageSchema:"332fd63041d2c1bcb487cc26dd0d5f7d97098a6c"},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var __awaiter=(cov_yo9zrwkhc.s[0]++,(cov_yo9zrwkhc.b[0][0]++,this)&&(cov_yo9zrwkhc.b[0][1]++,this.__awaiter)||(cov_yo9zrwkhc.b[0][2]++,function(thisArg,_arguments,P,generator){cov_yo9zrwkhc.f[0]++;cov_yo9zrwkhc.s[1]++;return new((cov_yo9zrwkhc.b[1][0]++,P)||(cov_yo9zrwkhc.b[1][1]++,P=Promise))(function(resolve,reject){cov_yo9zrwkhc.f[1]++;function fulfilled(value){cov_yo9zrwkhc.f[2]++;cov_yo9zrwkhc.s[2]++;try{cov_yo9zrwkhc.s[3]++;step(generator.next(value));}catch(e){cov_yo9zrwkhc.s[4]++;reject(e);}}function rejected(value){cov_yo9zrwkhc.f[3]++;cov_yo9zrwkhc.s[5]++;try{cov_yo9zrwkhc.s[6]++;step(generator["throw"](value));}catch(e){cov_yo9zrwkhc.s[7]++;reject(e);}}function step(result){cov_yo9zrwkhc.f[4]++;cov_yo9zrwkhc.s[8]++;result.done?(cov_yo9zrwkhc.b[2][0]++,resolve(result.value)):(cov_yo9zrwkhc.b[2][1]++,new P(function(resolve){cov_yo9zrwkhc.f[5]++;cov_yo9zrwkhc.s[9]++;resolve(result.value);}).then(fulfilled,rejected));}cov_yo9zrwkhc.s[10]++;step((generator=generator.apply(thisArg,(cov_yo9zrwkhc.b[3][0]++,_arguments)||(cov_yo9zrwkhc.b[3][1]++,[]))).next());});}));cov_yo9zrwkhc.s[11]++;Object.defineProperty(exports,"__esModule",{value:true});const automation_client_1=(cov_yo9zrwkhc.s[12]++,require("@atomist/automation-client"));const slack=(cov_yo9zrwkhc.s[13]++,require("@atomist/slack-messages/SlackMessages"));const ghub_1=(cov_yo9zrwkhc.s[14]++,require("../github/ghub"));const lifecycleHelpers_1=(cov_yo9zrwkhc.s[15]++,require("../lifecycleHelpers"));/* tslint:disable:no-unused-variable */function linkToDiff(id,start,end,endDescription){cov_yo9zrwkhc.f[6]++;cov_yo9zrwkhc.s[16]++;return slack.url(diffUrl(id,start,end),`(Compare with ${(cov_yo9zrwkhc.b[4][0]++,endDescription)||(cov_yo9zrwkhc.b[4][1]++,end.substr(0,6))})`);}cov_yo9zrwkhc.s[17]++;exports.linkToDiff=linkToDiff;function diffUrl(id,start,end){cov_yo9zrwkhc.f[7]++;cov_yo9zrwkhc.s[18]++;return`${id.url}/compare/${start}...${end}`;}function renderDiff(token,id,start,end,color){cov_yo9zrwkhc.f[8]++;cov_yo9zrwkhc.s[19]++;return __awaiter(this,void 0,void 0,function*(){cov_yo9zrwkhc.f[9]++;const fromGitHub=(cov_yo9zrwkhc.s[20]++,yield ghub_1.listCommitsBetween(token,id,start,end));const commits=(cov_yo9zrwkhc.s[21]++,fromGitHub.commits.map(c=>{cov_yo9zrwkhc.f[10]++;cov_yo9zrwkhc.s[22]++;return{message:c.commit.message,sha:c.sha,author:c.author};}));cov_yo9zrwkhc.s[23]++;automation_client_1.logger.info("Rendering %d commits in diff",commits.length);cov_yo9zrwkhc.s[24]++;return render({owner:id.owner,name:id.repo},commits,diffUrl(id,start,end),color);});}cov_yo9zrwkhc.s[25]++;exports.renderDiff=renderDiff;function render(repo,commits,fullDiffLink,color){cov_yo9zrwkhc.f[11]++;const commitsGroupedByAuthor=(cov_yo9zrwkhc.s[26]++,[]);let author=(cov_yo9zrwkhc.s[27]++,null);let commitsByAuthor=(cov_yo9zrwkhc.s[28]++,{});let unknownCommitter=(cov_yo9zrwkhc.s[29]++,false);cov_yo9zrwkhc.s[30]++;for(const commit of commits){const ca=(cov_yo9zrwkhc.s[31]++,(cov_yo9zrwkhc.b[6][0]++,commit.author!=null)&&(cov_yo9zrwkhc.b[6][1]++,commit.author.login)&&(cov_yo9zrwkhc.b[6][2]++,commit.author.login!=="")?(cov_yo9zrwkhc.b[5][0]++,commit.author.login):(cov_yo9zrwkhc.b[5][1]++,"(unknown)"));cov_yo9zrwkhc.s[32]++;if(ca==="(unknown)"){cov_yo9zrwkhc.b[7][0]++;cov_yo9zrwkhc.s[33]++;unknownCommitter=true;}else{cov_yo9zrwkhc.b[7][1]++;}cov_yo9zrwkhc.s[34]++;if((cov_yo9zrwkhc.b[9][0]++,author==null)||(cov_yo9zrwkhc.b[9][1]++,author!==ca)){cov_yo9zrwkhc.b[8][0]++;cov_yo9zrwkhc.s[35]++;commitsByAuthor={author:ca,commits:[]};cov_yo9zrwkhc.s[36]++;author=ca;cov_yo9zrwkhc.s[37]++;commitsGroupedByAuthor.push(commitsByAuthor);}else{cov_yo9zrwkhc.b[8][1]++;}cov_yo9zrwkhc.s[38]++;if(ca===author){cov_yo9zrwkhc.b[10][0]++;cov_yo9zrwkhc.s[39]++;commitsByAuthor.commits.push(commit);}else{cov_yo9zrwkhc.b[10][1]++;}}let attachments=(cov_yo9zrwkhc.s[40]++,[]);cov_yo9zrwkhc.s[41]++;commitsGroupedByAuthor.forEach(cgba=>{cov_yo9zrwkhc.f[12]++;const a=(cov_yo9zrwkhc.s[42]++,cgba.author);const message=(cov_yo9zrwkhc.s[43]++,cgba.commits.map(c=>{cov_yo9zrwkhc.f[13]++;cov_yo9zrwkhc.s[44]++;return renderCommitMessage(repo,c);}).join("\n"));const fallback=(cov_yo9zrwkhc.s[45]++,`lots of commits`);const attachment=(cov_yo9zrwkhc.s[46]++,{author_name:`@${a}`,author_link:lifecycleHelpers_1.userUrl(repo,a),author_icon:lifecycleHelpers_1.avatarUrl(repo,a),text:message,mrkdwn_in:["text"],color,fallback,actions:[]});cov_yo9zrwkhc.s[47]++;attachments.push(attachment);});// Limit number of commits by author to 3
cov_yo9zrwkhc.s[48]++;if(attachments.length>3){cov_yo9zrwkhc.b[11][0]++;cov_yo9zrwkhc.s[49]++;attachments=attachments.slice(0,3);const fullDiffDescription=(cov_yo9zrwkhc.s[50]++,`... and more! (${commits.length} total commits)`);const attachment=(cov_yo9zrwkhc.s[51]++,{title_link:fullDiffLink,title:fullDiffDescription,color,fallback:fullDiffDescription,actions:[]});cov_yo9zrwkhc.s[52]++;attachments.push(attachment);}else{cov_yo9zrwkhc.b[11][1]++;}// if (attachments.length > 0) {
//     const lastAttachment = attachments[attachments.length - 1];
//     if (unknownCommitter) {
//         lastAttachment.footer_icon = "https://images.atomist.com/rug/question.png";
//         lastAttachment.footer = `Unrecognized author. Please use a known email address to commit.`;
//     } else {
//         lastAttachment.footer_icon = "https://images.atomist.com/rug/commit.png";
//         if (lastAttachment.footer != null) {
//             lastAttachment.footer = `${url(repoUrl(repo), repoSlug(repo))} - ${lastAttachment.footer}`;
//         } else {
//             lastAttachment.footer = url(repoUrl(repo), repoSlug(repo));
//         }
//         lastAttachment.ts = Math.floor(Date.parse(push.timestamp) / 1000);
//     }
cov_yo9zrwkhc.s[53]++;return Promise.resolve(attachments);}// exported for testing
function renderCommitMessage(repo,commitNode){cov_yo9zrwkhc.f[14]++;// Cut commit to 50 chars of first line
const m=(cov_yo9zrwkhc.s[54]++,lifecycleHelpers_1.truncateCommitMessage(commitNode.message,repo));cov_yo9zrwkhc.s[55]++;return"`"+slack.url(lifecycleHelpers_1.commitUrl(repo,commitNode),commitNode.sha.substring(0,7))+"` "+m;}cov_yo9zrwkhc.s[56]++;exports.renderCommitMessage=renderCommitMessage;//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL3V0aWwvc2xhY2svZGlmZlJlbmRlcmluZy50cyIsInNvdXJjZXMiOlsiL1VzZXJzL3JvZGpvaG5zb24vc2ZvcnphbmRvLWRldi9pZGVhLXByb2plY3RzL215LWZsb3cvc3JjL3V0aWwvc2xhY2svZGlmZlJlbmRlcmluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7O0dBY0c7Ozs7Ozs7Ozs7QUFFSCxrRUFBb0Q7QUFHcEQsK0RBQStEO0FBQy9ELHlDQUFvRDtBQUNwRCwwREFNNkI7QUFFN0IsdUNBQXVDO0FBRXZDLG9CQUEyQixFQUFpQixFQUFFLEtBQWEsRUFBRSxHQUFXLEVBQUUsY0FBdUI7SUFDN0YsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFLEVBQUUsS0FBSyxFQUFFLEdBQUcsQ0FBQyxFQUFFLGlCQUFpQixjQUFjLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3RHLENBQUM7QUFGRCxnQ0FFQztBQUVELGlCQUFpQixFQUFpQixFQUFFLEtBQWEsRUFBRSxHQUFXO0lBQzFELE9BQU8sR0FBRyxFQUFFLENBQUMsR0FBRyxZQUFZLEtBQUssTUFBTSxHQUFHLEVBQUUsQ0FBQztBQUNqRCxDQUFDO0FBRUQsb0JBQWlDLEtBQWEsRUFBRSxFQUFpQixFQUFFLEtBQWEsRUFBRSxHQUFXLEVBQUUsS0FBYTs7UUFDeEcsTUFBTSxVQUFVLEdBQUcsTUFBTSx5QkFBa0IsQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztRQUVuRSxNQUFNLE9BQU8sR0FBeUIsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQy9ELE9BQU8sRUFBRSxDQUFDLENB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QUMsQ0FBQyxDQUFDO1FBQ3RDLE1BQU0sbUJBQW1CLEdBQUcsa0JBQWtCLE9BQU8sQ0FBQyxNQUFNLGlCQUFpQixDQUFDO1FBRTlFLE1BQU0sVUFBVSxHQUFxQjtZQUNqQyxVQUFVLEVBQUUsWUFBWTtZQUN4QixLQUFLLEVBQUUsbUJBQW1CO1lBQzFCLEtBQUs7WUFDTCxRQUFRLEVBQUUsbUJBQW1CO1lBQzdCLE9BQU8sRUFBRSxFQUFFO1NBQ2QsQ0FBQztRQUNGLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7S0FDaEM7SUFFRCxnQ0FBZ0M7SUFDaEMsa0VBQWtFO0lBQ2xFLDhCQUE4QjtJQUM5QixzRkFBc0Y7SUFDdEYsc0dBQXNHO0lBQ3RHLGVBQWU7SUFDZixvRkFBb0Y7SUFDcEYsK0NBQStDO0lBQy9DLDBHQUEwRztJQUMxRyxtQkFBbUI7SUFDbkIsMEVBQTBFO0lBQzFFLFlBQVk7SUFDWiw2RUFBNkU7SUFDN0UsUUFBUTtJQUVSLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUN4QyxDQUFDO0FBRUQsdUJBQXVCO0FBQ3ZCLDZCQUFvQyxJQUFjLEVBQUUsVUFBOEI7SUFDOUUsdUNBQXVDO0lBQ3ZDLE1BQU0sQ0FBQyxHQUFHLHdDQUFxQixDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDMUQsT0FBTyxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyw0QkFBUyxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsRUFBRSxVQUFVLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDO0FBQ25HLENBQUM7QUFKRCxrREFJQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgwqkgMjAxOCBBdG9taXN0LCBJbmMuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudFwiO1xuaW1wb3J0IHsgR2l0SHViUmVwb1JlZiB9IGZyb20gXCJAYXRvbWlzdC9hdXRvbWF0aW9uLWNsaWVudC9vcGVyYXRpb25zL2NvbW1vbi9HaXRIdWJSZXBvUmVmXCI7XG5pbXBvcnQgeyBSZW1vdGVSZXBvUmVmIH0gZnJvbSBcIkBhdG9taXN0L2F1dG9tYXRpb24tY2xpZW50L29wZXJhdGlvbnMvY29tbW9uL1JlcG9JZFwiO1xuaW1wb3J0ICogYXMgc2xhY2sgZnJvbSBcIkBhdG9taXN0L3NsYWNrLW1lc3NhZ2VzL1NsYWNrTWVzc2FnZXNcIjtcbmltcG9ydCB7IGxpc3RDb21taXRzQmV0d2VlbiB9IGZyb20gXCIuLi9naXRodWIvZ2h1YlwiO1xuaW1wb3J0IHtcbiAgICBhdmF0YXJVcmwsXG4gICAgY29tbWl0VXJsLFxuICAgIFJlcG9JbmZvLFxuICAgIHRydW5jYXRlQ29tbWl0TWVzc2FnZSxcbiAgICB1c2VyVXJsLFxufSBmcm9tIFwiLi4vbGlmZWN5Y2xlSGVscGVyc1wiO1xuXG4vKiB0c2xpbnQ6ZGlzYWJsZTpuby11bnVzZWQtdmFyaWFibGUgKi9cblxuZXhwb3J0IGZ1bmN0aW9uIGxpbmtUb0RpZmYoaWQ6IFJlbW90ZVJlcG9SZWYsIHN0YXJ0OiBzdHJpbmcsIGVuZDogc3RyaW5nLCBlbmREZXNjcmlwdGlvbj86IHN0cmluZykge1xuICAgIHJldHVybiBzbGFjay51cmwoZGlmZlVybChpZCwgc3RhcnQsIGVuZCksIGAoQ29tcGFyZSB3aXRoICR7ZW5kRGVzY3JpcHRpb24gfHwgZW5kLnN1YnN0cigwLCA2KX0pYCk7XG59XG5cbmZ1bmN0aW9uIGRpZmZVcmwoaWQ6IFJlbW90ZVJlcG9SZWYsIHN0YXJ0OiBzdHJpbmcsIGVuZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGAke2lkLnVybH0vY29tcGFyZS8ke3N0YXJ0fS4uLiR7ZW5kfWA7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW5kZXJEaWZmKHRva2VuOiBzdHJpbmcsIGlkOiBHaXRIdWJSZXBvUmVmLCBzdGFydDogc3RyaW5nLCBlbmQ6IHN0cmluZywgY29sb3I6IHN0cmluZyk6IFByb21pc2U8c2xhY2suQXR0YWNobWVudFtdPiB7XG4gICAgY29uc3QgZnJvbUdpdEh1YiA9IGF3YWl0IGxpc3RDb21taXRzQmV0d2Vlbih0b2tlbiwgaWQsIHN0YXJ0LCBlbmQpO1xuXG4gICAgY29uc3QgY29tbWl0czogQ29tbWl0Rm9yUmVuZGVyaW5nW10gPSBmcm9tR2l0SHViLmNvbW1pdHMubWFwKGMgPT4gKHtcbiAgICAgICAgbWVzc2FnZTogYy5jb21taXQubWVzc2FnZSxcbiAgICAgICAgc2hhOiBjLnNoYSxcbiAgICAgICAgYXV0aG9yOiBjLmF1dGhvcixcbiAgICB9KSk7XG5cbiAgICBsb2dnZXIuaW5mbyhcIlJlbmRlcmluZyAlZCBjb21taXRzIGluIGRpZmZcIiwgY29tbWl0cy5sZW5ndGgpO1xuICAgIHJldHVybiByZW5kZXIoe293bmVyOiBpZC5vd25lciwgbmFtZTogaWQucmVwb30sIGNvbW1pdHMsIGRpZmZVcmwoaWQsIHN0YXJ0LCBlbmQpLCBjb2xvcik7XG59XG5cbi8vIGV4cG9ydGVkIGZvciB0ZXN0aW5nXG5leHBvcnQgaW50ZXJmYWNlIENvbW1pdEZvclJlbmRlcmluZyB7XG4gICAgc2hhOiBzdHJpbmc7XG4gICAgbWVzc2FnZTogc3RyaW5nO1xuICAgIGF1dGhvcjoge1xuICAgICAgICBsb2dpbjogc3RyaW5nLFxuICAgIH07XG59XG5cbmZ1bmN0aW9uIHJlbmRlcihyZXBvOiBSZXBvSW5mbywgY29tbWl0czogQ29tbWl0Rm9yUmVuZGVyaW5nW10sIGZ1bGxEaWZmTGluazogc3RyaW5nLCBjb2xvcjogc3RyaW5nKTogUHJvbWlzZTxzbGFjay5BdHRhY2htZW50W10+IHtcblxuICAgIGNvbnN0IGNvbW1pdHNHcm91cGVkQnlBdXRob3IgPSBbXTtcblxuICAgIGxldCBhdXRob3IgPSBudWxsO1xuICAgIGxldCBjb21taXRzQnlBdXRob3I6IGFueSA9IHt9O1xuICAgIGxldCB1bmtub3duQ29tbWl0dGVyID0gZmFsc2U7XG4gICAgZm9yIChjb25zdCBjb21taXQgb2YgY29tbWl0cykge1xuICAgICAgICBjb25zdCBjYSA9IChjb21taXQuYXV0aG9yICE9IG51bGwgJiYgY29tbWl0LmF1dGhvci5sb2dpbiAmJiBjb21taXQuYXV0aG9yLmxvZ2luICE9PSBcIlwiXG4gICAgICAgICAgICA/IGNvbW1pdC5hdXRob3IubG9naW4gOiBcIih1bmtub3duKVwiKTtcblxuICAgICAgICBpZiAoY2EgPT09IFwiKHVua25vd24pXCIpIHtcbiAgICAgICAgICAgIHVua25vd25Db21taXR0ZXIgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGF1dGhvciA9PSBudWxsIHx8IGF1dGhvciAhPT0gY2EpIHtcbiAgICAgICAgICAgIGNvbW1pdHNCeUF1dGhvciA9IHtcbiAgICAgICAgICAgICAgICBhdXRob3I6IGNhLFxuICAgICAgICAgICAgICAgIGNvbW1pdHM6IFtdLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGF1dGhvciA9IGNhO1xuICAgICAgICAgICAgY29tbWl0c0dyb3VwZWRCeUF1dGhvci5wdXNoKGNvbW1pdHNCeUF1dGhvcik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNhID09PSBhdXRob3IpIHtcbiAgICAgICAgICAgIGNvbW1pdHNCeUF1dGhvci5jb21taXRzLnB1c2goY29tbWl0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGxldCBhdHRhY2htZW50czogc2xhY2suQXR0YWNobWVudFtdID0gW107XG5cbiAgICBjb21taXRzR3JvdXBlZEJ5QXV0aG9yXG4gICAgICAgIC5mb3JFYWNoKGNnYmEgPT4ge1xuICAgICAgICAgICAgY29uc3QgYSA9IGNnYmEuYXV0aG9yO1xuXG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gY2diYS5jb21taXRzLm1hcChjID0+IHJlbmRlckNvbW1pdE1lc3NhZ2UocmVwbywgYykpLmpvaW4oXCJcXG5cIik7XG5cbiAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrID0gYGxvdHMgb2YgY29tbWl0c2A7XG5cbiAgICAgICAgICAgIGNvbnN0IGF0dGFjaG1lbnQ6IHNsYWNrLkF0dGFjaG1lbnQgPSB7XG4gICAgICAgICAgICAgICAgYXV0aG9yX25hbWU6IGBAJHthfWAsXG4gICAgICAgICAgICAgICAgYXV0aG9yX2xpbms6IHVzZXJVcmwocmVwbywgYSksXG4gICAgICAgICAgICAgICAgYXV0aG9yX2ljb246IGF2YXRhclVybChyZXBvLCBhKSxcbiAgICAgICAgICAgICAgICB0ZXh0OiBtZXNzYWdlLFxuICAgICAgICAgICAgICAgIG1ya2R3bl9pbjogW1widGV4dFwiXSxcbiAgICAgICAgICAgICAgICBjb2xvcixcbiAgICAgICAgICAgICAgICBmYWxsYmFjayxcbiAgICAgICAgICAgICAgICBhY3Rpb25zOiBbXSxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBhdHRhY2htZW50cy5wdXNoKGF0dGFjaG1lbnQpO1xuICAgICAgICB9KTtcblxuICAgIC8vIExpbWl0IG51bWJlciBvZiBjb21taXRzIGJ5IGF1dGhvciB0byAzXG4gICAgaWYgKGF0dGFjaG1lbnRzLmxlbmd0aCA+IDMpIHtcbiAgICAgICAgYXR0YWNobWVudHMgPSBhdHRhY2htZW50cy5zbGljZSgwLCAzKTtcbiAgICAgICAgY29uc3QgZnVsbERpZmZEZXNjcmlwdGlvbiA9IGAuLi4gYW5kIG1vcmUhICgke2NvbW1pdHMubGVuZ3RofSB0b3RhbCBjb21taXRzKWA7XG5cbiAgICAgICAgY29uc3QgYXR0YWNobWVudDogc2xhY2suQXR0YWNobWVudCA9IHtcbiAgICAgICAgICAgIHRpdGxlX2xpbms6IGZ1bGxEaWZmTGluayxcbiAgICAgICAgICAgIHRpdGxlOiBmdWxsRGlmZkRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgY29sb3IsXG4gICAgICAgICAgICBmYWxsYmFjazogZnVsbERpZmZEZXNjcmlwdGlvbixcbiAgICAgICAgICAgIGFjdGlvbnM6IFtdLFxuICAgICAgICB9O1xuICAgICAgICBhdHRhY2htZW50cy5wdXNoKGF0dGFjaG1lbnQpO1xuICAgIH1cblxuICAgIC8vIGlmIChhdHRhY2htZW50cy5sZW5ndGggPiAwKSB7XG4gICAgLy8gICAgIGNvbnN0IGxhc3RBdHRhY2htZW50ID0gYXR0YWNobWVudHNbYXR0YWNobWVudHMubGVuZ3RoIC0gMV07XG4gICAgLy8gICAgIGlmICh1bmtub3duQ29tbWl0dGVyKSB7XG4gICAgLy8gICAgICAgICBsYXN0QXR0YWNobWVudC5mb290ZXJfaWNvbiA9IFwiaHR0cHM6Ly9pbWFnZXMuYXRvbWlzdC5jb20vcnVnL3F1ZXN0aW9uLnBuZ1wiO1xuICAgIC8vICAgICAgICAgbGFzdEF0dGFjaG1lbnQuZm9vdGVyID0gYFVucmVjb2duaXplZCBhdXRob3IuIFBsZWFzZSB1c2UgYSBrbm93biBlbWFpbCBhZGRyZXNzIHRvIGNvbW1pdC5gO1xuICAgIC8vICAgICB9IGVsc2Uge1xuICAgIC8vICAgICAgICAgbGFzdEF0dGFjaG1lbnQuZm9vdGVyX2ljb24gPSBcImh0dHBzOi8vaW1hZ2VzLmF0b21pc3QuY29tL3J1Zy9jb21taXQucG5nXCI7XG4gICAgLy8gICAgICAgICBpZiAobGFzdEF0dGFjaG1lbnQuZm9vdGVyICE9IG51bGwpIHtcbiAgICAvLyAgICAgICAgICAgICBsYXN0QXR0YWNobWVudC5mb290ZXIgPSBgJHt1cmwocmVwb1VybChyZXBvKSwgcmVwb1NsdWcocmVwbykpfSAtICR7bGFzdEF0dGFjaG1lbnQuZm9vdGVyfWA7XG4gICAgLy8gICAgICAgICB9IGVsc2Uge1xuICAgIC8vICAgICAgICAgICAgIGxhc3RBdHRhY2htZW50LmZvb3RlciA9IHVybChyZXBvVXJsKHJlcG8pLCByZXBvU2x1ZyhyZXBvKSk7XG4gICAgLy8gICAgICAgICB9XG4gICAgLy8gICAgICAgICBsYXN0QXR0YWNobWVudC50cyA9IE1hdGguZmxvb3IoRGF0ZS5wYXJzZShwdXNoLnRpbWVzdGFtcCkgLyAxMDAwKTtcbiAgICAvLyAgICAgfVxuXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShhdHRhY2htZW50cyk7XG59XG5cbi8vIGV4cG9ydGVkIGZvciB0ZXN0aW5nXG5leHBvcnQgZnVuY3Rpb24gcmVuZGVyQ29tbWl0TWVzc2FnZShyZXBvOiBSZXBvSW5mbywgY29tbWl0Tm9kZTogQ29tbWl0Rm9yUmVuZGVyaW5nKTogc3RyaW5nIHtcbiAgICAvLyBDdXQgY29tbWl0IHRvIDUwIGNoYXJzIG9mIGZpcnN0IGxpbmVcbiAgICBjb25zdCBtID0gdHJ1bmNhdGVDb21taXRNZXNzYWdlKGNvbW1pdE5vZGUubWVzc2FnZSwgcmVwbyk7XG4gICAgcmV0dXJuIFwiYFwiICsgc2xhY2sudXJsKGNvbW1pdFVybChyZXBvLCBjb21taXROb2RlKSwgY29tbWl0Tm9kZS5zaGEuc3Vic3RyaW5nKDAsIDcpKSArIFwiYCBcIiArIG07XG59XG4iXX0=